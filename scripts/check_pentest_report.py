#!/usr/bin/env python3
"""Penetration test report validation check.

Gate ID: p4-pentest-report
Validation: scripts/check_pentest_report.py

Checks:
1. OWASP ZAP pentest report exists (JSON format)
2. Report contains zero Critical or High findings
3. Markdown summary report exists alongside JSON

Usage:
    python3 scripts/check_pentest_report.py [--json]

Exit codes:
    0: Report exists with zero Critical/High
    1: Report missing or has Critical/High findings
"""

from __future__ import annotations

import json
import sys
from pathlib import Path

REPORT_DIR = Path("evidence/pentest")
JSON_REPORT = REPORT_DIR / "zap-report.json"
MD_REPORT = REPORT_DIR / "zap-report.md"


def check_report_exists(results: list[dict]) -> bool:
    """Verify pentest report files exist."""
    passed = True

    if not JSON_REPORT.exists():
        results.append(
            {
                "check": "json_report",
                "status": "FAIL",
                "detail": (
                    f"{JSON_REPORT} not found. Run: zap-baseline.py -t <target> -J {JSON_REPORT}"
                ),
            }
        )
        passed = False
    else:
        size = JSON_REPORT.stat().st_size
        results.append(
            {
                "check": "json_report",
                "status": "PASS",
                "detail": f"{JSON_REPORT} exists ({size} bytes)",
            }
        )

    if not MD_REPORT.exists():
        results.append(
            {
                "check": "md_report",
                "status": "FAIL",
                "detail": f"{MD_REPORT} not found. Generate alongside JSON report.",
            }
        )
        passed = False
    else:
        results.append(
            {
                "check": "md_report",
                "status": "PASS",
                "detail": f"{MD_REPORT} exists",
            }
        )

    return passed


def check_no_critical_high(results: list[dict]) -> bool:
    """Verify zero Critical/High findings in ZAP report."""
    if not JSON_REPORT.exists():
        return False  # Already reported by check_report_exists

    try:
        with open(JSON_REPORT) as f:
            report = json.load(f)
    except (json.JSONDecodeError, OSError) as exc:
        results.append(
            {
                "check": "report_parse",
                "status": "FAIL",
                "detail": f"Failed to parse {JSON_REPORT}: {exc}",
            }
        )
        return False

    # ZAP JSON report structure: site[].alerts[] with riskcode field
    # riskcode: 0=Informational, 1=Low, 2=Medium, 3=High
    # Some reports use "risk" string: "High", "Medium", "Low", "Informational"
    critical_high = []

    sites = report.get("site", [])
    for site in sites:
        alerts = site.get("alerts", [])
        for alert in alerts:
            riskcode = alert.get("riskcode", "0")
            risk = alert.get("risk", "").lower()
            if str(riskcode) == "3" or risk in ("high", "critical"):
                critical_high.append(
                    {
                        "name": alert.get("name", alert.get("alert", "unknown")),
                        "risk": alert.get("risk", f"riskcode={riskcode}"),
                        "count": alert.get("count", len(alert.get("instances", []))),
                    }
                )

    if critical_high:
        details = "; ".join(
            f"{f['name']} ({f['risk']}, {f['count']} instances)" for f in critical_high
        )
        results.append(
            {
                "check": "critical_high_findings",
                "status": "FAIL",
                "detail": f"{len(critical_high)} Critical/High findings: {details}",
            }
        )
        return False

    # Count total findings for informational purposes
    total = sum(len(s.get("alerts", [])) for s in sites)
    results.append(
        {
            "check": "critical_high_findings",
            "status": "PASS",
            "detail": f"Zero Critical/High findings ({total} total findings at lower severity)",
        }
    )
    return True


def main() -> int:
    use_json = "--json" in sys.argv
    results: list[dict] = []
    all_pass = True

    all_pass = check_report_exists(results) and all_pass
    all_pass = check_no_critical_high(results) and all_pass

    if use_json:
        output = {
            "gate_id": "p4-pentest-report",
            "status": "PASS" if all_pass else "FAIL",
            "checks": results,
        }
        print(json.dumps(output, indent=2))
    else:
        for r in results:
            marker = "OK" if r["status"] == "PASS" else "FAIL"
            print(f"  [{marker}] {r['check']}: {r['detail']}")
        print()
        print(f"Pentest report check: {'PASS' if all_pass else 'FAIL'}")

    return 0 if all_pass else 1


if __name__ == "__main__":
    sys.exit(main())
