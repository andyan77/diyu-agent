# DIYU Agent Milestone Matrix (Machine-Readable)
# Human-readable version: docs/governance/milestone-matrix*.md
# Schema: delivery/milestone-matrix.schema.yaml
# Usage: uv run python scripts/verify_phase.py --phase 0 --json

schema_version: "1.1"
current_phase: "phase_3"

phases:
  phase_0:
    name: "Governance Minimum + Delivery Skeleton"
    milestones:
      # Backend (milestone-matrix-backend.md)
      - {id: "B0-1", layer: "Brain", summary: "Brain module skeleton"}
      - {id: "B0-2", layer: "Brain", summary: "Brain Port interface references"}
      - {id: "B0-3", layer: "Brain", summary: "Conversation engine shell"}
      - {id: "MC0-1", layer: "MemoryCore", summary: "MemoryCorePort interface"}
      - {id: "MC0-2", layer: "MemoryCore", summary: "MemoryCorePort Stub (SQLite)"}
      - {id: "MC0-3", layer: "MemoryCore", summary: "MemoryItem v1 Schema"}
      - {id: "K0-1", layer: "Knowledge", summary: "KnowledgePort interface"}
      - {id: "K0-2", layer: "Knowledge", summary: "KnowledgePort Stub"}
      - {id: "K0-3", layer: "Knowledge", summary: "KnowledgeBundle v1 Schema"}
      - {id: "S0-1", layer: "Skill", summary: "SkillProtocol base class"}
      - {id: "S0-2", layer: "Skill", summary: "SkillRegistry Stub"}
      - {id: "T0-1", layer: "Tool", summary: "LLMCallPort interface"}
      - {id: "T0-2", layer: "Tool", summary: "LLMCallPort Stub"}
      - {id: "T0-3", layer: "Tool", summary: "ToolProtocol base class"}
      - {id: "G0-1", layer: "Gateway", summary: "FastAPI minimal healthz"}
      - {id: "G0-2", layer: "Gateway", summary: "OpenAPI spec auto-gen"}
      - {id: "G0-3", layer: "Gateway", summary: "Request logging middleware"}
      - {id: "I0-1", layer: "Infra", summary: "Docker Compose full-stack"}
      - {id: "I0-2", layer: "Infra", summary: "pyproject.toml + uv.lock"}
      - {id: "I0-3", layer: "Infra", summary: "Alembic migration skeleton"}
      - {id: "I0-4", layer: "Infra", summary: "Makefile standard commands"}
      - {id: "I0-5", layer: "Infra", summary: ".env.example"}
      - {id: "I0-6", layer: "Infra", summary: "ruff + mypy strict config"}
      # Frontend (milestone-matrix-frontend.md)
      - {id: "FW0-1", layer: "FE-Web", summary: "Next.js 15 + TS strict + Tailwind"}
      - {id: "FW0-2", layer: "FE-Web", summary: "Turborepo + pnpm workspace"}
      - {id: "FW0-3", layer: "FE-Web", summary: "packages/ui base components"}
      - {id: "FW0-4", layer: "FE-Web", summary: "packages/api-client"}
      - {id: "FW0-5", layer: "FE-Web", summary: "packages/shared"}
      - {id: "FW0-6", layer: "FE-Web", summary: "ESLint + Prettier + a11y"}
      - {id: "FW0-7", layer: "FE-Web", summary: "Vitest config"}
      - {id: "FW0-8", layer: "FE-Web", summary: "Playwright E2E infra"}
      - {id: "FA0-1", layer: "FE-Admin", summary: "Next.js Admin App"}
      - {id: "FA0-2", layer: "FE-Admin", summary: "Admin Layout"}
      - {id: "FA0-3", layer: "FE-Admin", summary: "TierGate redirect"}
      # Crosscutting (milestone-matrix-crosscutting.md)
      - {id: "D0-1", layer: "Delivery", summary: "manifest.yaml skeleton"}
      - {id: "D0-2", layer: "Delivery", summary: "milestone-matrix.schema.yaml"}
      - {id: "D0-3", layer: "Delivery", summary: "preflight.sh"}
      - {id: "D0-4", layer: "Delivery", summary: "ci.yml hard gates"}
      - {id: "D0-5", layer: "Delivery", summary: "check_layer_deps.sh"}
      - {id: "D0-6", layer: "Delivery", summary: "check_port_compat.sh"}
      - {id: "D0-7", layer: "Delivery", summary: "check_migration.sh"}
      - {id: "D0-8", layer: "Delivery", summary: "change_impact_router.sh"}
      - {id: "D0-9", layer: "Delivery", summary: "PR template + CODEOWNERS"}
      - {id: "D0-10", layer: "Delivery", summary: "verify-phase-0"}
      - {id: "MM0-1", layer: "Multimodal", summary: "ContentBlock Schema v1.1"}
      - {id: "MM0-2", layer: "Multimodal", summary: "ObjectStoragePort"}
      - {id: "MM0-3", layer: "Multimodal", summary: "media_objects DDL + RLS"}
      - {id: "MM0-4", layer: "Multimodal", summary: "tool_usage_records DDL"}
      - {id: "MM0-5", layer: "Multimodal", summary: "content_schema_version column"}
      - {id: "MM0-6", layer: "Multimodal", summary: "LLMCallPort content_parts expand"}
      - {id: "MM0-7", layer: "Multimodal", summary: "Security pipeline Stage 1"}
      - {id: "MM0-8", layer: "Multimodal", summary: "Contract tests L1-4"}
      - {id: "OS0-1", layer: "Observability", summary: "Unified log format"}
      - {id: "OS0-2", layer: "Observability", summary: "ruff + mypy CI"}
      - {id: "OS0-3", layer: "Observability", summary: "Secret scanning"}
      - {id: "OS0-4", layer: "Observability", summary: "SAST baseline"}
      - {id: "OS0-5", layer: "Observability", summary: "Dependency vuln scan"}
      - {id: "OS0-6", layer: "Observability", summary: "FE security lint + audit"}
    exit_criteria:
      hard:
        - id: "p0-toolchain"
          description: "Dev toolchain healthy (0 FAIL)"
          check: "uv run python scripts/doctor.py --json | uv run python -c \"import sys,json; d=json.load(sys.stdin); sys.exit(0 if d['summary']['fail']==0 else 1)\""

        - id: "p0-backend-skeleton"
          description: "Python project config exists"
          check: "test -f pyproject.toml"

        - id: "p0-frontend-skeleton"
          description: "Frontend monorepo config exists"
          check: "test -f frontend/pnpm-workspace.yaml"

        - id: "p0-guards"
          description: "Guard scripts exist and are executable"
          check: "test -x scripts/check_layer_deps.sh && test -x scripts/check_port_compat.sh"

        - id: "p0-makefile"
          description: "Makefile with lifecycle commands"
          check: "test -f Makefile && grep -q 'bootstrap' Makefile && grep -q 'doctor' Makefile"

        - id: "p0-claude-md"
          description: "CLAUDE.md exists and <= 80 lines"
          check: "test -f CLAUDE.md && [ $(wc -l < CLAUDE.md) -le 80 ]"

        - id: "p0-milestone-matrix"
          description: "Milestone matrix YAML parseable"
          check: "uv run python -c \"import yaml; yaml.safe_load(open('delivery/milestone-matrix.yaml'))\""

        - id: "p0-schema-validation"
          description: "Task card schema and validation scripts exist"
          check: "test -f docs/governance/task-card-schema-v1.0.md && test -f scripts/check_task_schema.py"

        - id: "p0-env-template"
          description: "Environment template exists"
          check: "test -f .env.example"

        - id: "p0-gitignore"
          description: "Gitignore configured"
          check: "test -f .gitignore && grep -q '__pycache__' .gitignore"

      soft:
        - id: "p0-hooks"
          description: "Claude Code hooks configured"
          check: "test -f .claude/settings.json"

        - id: "p0-adr-index"
          description: "ADR index exists"
          check: "test -f docs/adr/README.md"

    go_no_go:
      hard_pass_rate: 1.0
      approver: "architect"

  phase_1:
    name: "Security & Tenant Foundation"
    depends_on: ["phase_0"]
    milestones:
      # Backend
      - {id: "G1-1", layer: "Gateway", summary: "JWT auth middleware", status: "done"}
      - {id: "G1-2", layer: "Gateway", summary: "OrgContext middleware", status: "done"}
      - {id: "G1-3", layer: "Gateway", summary: "RBAC permission check", status: "done"}
      - {id: "G1-4", layer: "Gateway", summary: "RLS policy baseline", status: "done"}
      - {id: "G1-5", layer: "Gateway", summary: "API partition rules", status: "done"}
      - {id: "G1-6", layer: "Gateway", summary: "Security headers", status: "done"}
      - {id: "I1-1", layer: "Infra", summary: "org/users/org_members DDL", status: "done"}
      - {id: "I1-2", layer: "Infra", summary: "org_settings inheritance", status: "done"}
      - {id: "I1-3", layer: "Infra", summary: "RLS policies all tables", status: "done"}
      - {id: "I1-4", layer: "Infra", summary: "RBAC skeleton", status: "done"}
      - {id: "I1-5", layer: "Infra", summary: "audit_events table", status: "done"}
      - {id: "I1-6", layer: "Infra", summary: "event_outbox pattern", status: "done"}
      - {id: "I1-7", layer: "Infra", summary: "Secret/SAST/dep scanning", status: "done"}
      # Frontend
      - {id: "FW1-1", layer: "FE-Web", summary: "Login page", status: "done"}
      - {id: "FW1-2", layer: "FE-Web", summary: "AuthProvider + PermissionGate", status: "done"}
      - {id: "FW1-3", layer: "FE-Web", summary: "Org switcher", status: "done"}
      - {id: "FW1-4", layer: "FE-Web", summary: "SaaS/Private token modes", status: "done"}
      - {id: "FA1-1", layer: "FE-Admin", summary: "Admin login with 2FA slot", status: "done"}
      - {id: "FA1-2", layer: "FE-Admin", summary: "Permission matrix mgmt", status: "done"}
      # Crosscutting
      - {id: "D1-1", layer: "Delivery", summary: "Image security scan", status: "done"}
      - {id: "D1-2", layer: "Delivery", summary: "SBOM generation", status: "done"}
      - {id: "D1-3", layer: "Delivery", summary: "verify-phase-1", status: "done"}
      - {id: "OS1-1", layer: "Observability", summary: "RLS isolation test framework", status: "done"}
      - {id: "OS1-2", layer: "Observability", summary: "Isolation smoke CI gate", status: "done"}
      - {id: "OS1-3", layer: "Observability", summary: "audit_events baseline", status: "done"}
      - {id: "OS1-4", layer: "Observability", summary: "JWT security tests", status: "done"}
      - {id: "OS1-5", layer: "Observability", summary: "CORS + security headers", status: "done"}
      - {id: "OS1-6", layer: "Observability", summary: "FE XSS protection", status: "done"}
    exit_criteria:
      hard:
        - id: "p1-org-migration"
          description: "Organization DDL migration exists"
          check: "ls migrations/versions/*organization* 2>/dev/null | head -1 | grep -q ."

        - id: "p1-rls"
          description: "RLS isolation smoke tests pass"
          check: "uv run pytest tests/isolation/smoke/ --tb=short -q"

        - id: "p1-orgcontext"
          description: "OrgContext gateway test passes"
          check: "uv run pytest tests/unit/gateway/test_org_context.py -q"

        - id: "p1-audit"
          description: "Audit events migration exists"
          check: "ls migrations/versions/*audit_events* 2>/dev/null | head -1 | grep -q ."

        - id: "p1-port-contracts"
          description: "Port contract tests pass"
          check: "uv run pytest tests/unit/ports/ -q"

        - id: "p1-gateway-auth"
          description: "JWT auth middleware tests pass"
          check: "uv run pytest tests/unit/gateway/test_jwt_auth.py -q"

        - id: "p1-rbac"
          description: "RBAC permission check tests pass"
          check: "uv run pytest tests/unit/gateway/test_rbac.py -q"

        - id: "p1-sbom"
          description: "SPDX SBOM generated and valid"
          check: "bash scripts/generate_sbom.sh --validate"

        - id: "p1-security-scan"
          description: "Security scan passes (semgrep + pip-audit)"
          # Phase Gate = local verification supplement.
          # Merge blocking relies on CI required check ("L1: Security Scan").
          check: "bash scripts/security_scan.sh --full"

      soft: []

    go_no_go:
      hard_pass_rate: 1.0
      approver: "architect"

  phase_2:
    name: "Core Conversation + Knowledge"
    depends_on: ["phase_1"]
    milestones:
      # Backend
      - {id: "B2-1", layer: "Brain", summary: "Conversation engine full impl", status: "done"}
      - {id: "B2-2", layer: "Brain", summary: "Intent understanding", status: "done"}
      - {id: "B2-3", layer: "Brain", summary: "Context Assembler v1", status: "done"}
      - {id: "B2-4", layer: "Brain", summary: "Context Assembler CE (RRF)", status: "done"}
      - {id: "B2-5", layer: "Brain", summary: "Memory write pipeline", status: "done"}
      - {id: "B2-6", layer: "Brain", summary: "injection/retrieval receipts", status: "done"}
      - {id: "B2-7", layer: "Brain", summary: "Graceful degradation", status: "done"}
      - {id: "B2-8", layer: "Brain", summary: "WebSocket real-time chat", status: "done"}
      - {id: "MC2-1", layer: "MemoryCore", summary: "PG adapter replaces Stub", status: "done"}
      - {id: "MC2-2", layer: "MemoryCore", summary: "conversation_events CRUD", status: "done"}
      - {id: "MC2-3", layer: "MemoryCore", summary: "memory_items CRUD versioned", status: "done"}
      - {id: "MC2-4", layer: "MemoryCore", summary: "pgvector semantic search", status: "done"}
      - {id: "MC2-5", layer: "MemoryCore", summary: "Evolution Pipeline", status: "done"}
      - {id: "MC2-6", layer: "MemoryCore", summary: "injection/retrieval receipts", status: "done"}
      - {id: "MC2-7", layer: "MemoryCore", summary: "confidence_effective decay", status: "done"}
      - {id: "T2-1", layer: "Tool", summary: "LLMCallPort real impl", status: "done"}
      - {id: "T2-2", layer: "Tool", summary: "Model Registry + Fallback", status: "done"}
      - {id: "T2-3", layer: "Tool", summary: "Token metering", status: "done"}
      - {id: "G2-1", layer: "Gateway", summary: "Conversation REST API", status: "done"}
      - {id: "G2-2", layer: "Gateway", summary: "WebSocket streaming", status: "done"}
      - {id: "G2-3", layer: "Gateway", summary: "LLM Gateway (LiteLLM)", status: "done"}
      - {id: "G2-4", layer: "Gateway", summary: "Token budget pre-check", status: "done"}
      - {id: "G2-5", layer: "Gateway", summary: "Rate limiting middleware", status: "done"}
      - {id: "G2-6", layer: "Gateway", summary: "3-step file upload", status: "done"}
      - {id: "G2-7", layer: "Gateway", summary: "SSE notification endpoint", status: "done"}
      - {id: "I2-1", layer: "Infra", summary: "Redis cache + session", status: "done"}
      - {id: "I2-2", layer: "Infra", summary: "Celery Worker + Redis Broker", status: "done"}
      - {id: "I2-3", layer: "Infra", summary: "Token billing minimal loop", status: "done"}
      - {id: "I2-4", layer: "Infra", summary: "conversation_events table", status: "done"}
      - {id: "I2-5", layer: "Infra", summary: "memory_items + pgvector", status: "done"}
      # Frontend
      - {id: "FW2-1", layer: "FE-Web", summary: "Chat dual-pane layout", status: "done"}
      - {id: "FW2-2", layer: "FE-Web", summary: "Streaming message render", status: "done"}
      - {id: "FW2-3", layer: "FE-Web", summary: "Chat history management", status: "done"}
      - {id: "FW2-4", layer: "FE-Web", summary: "Memory context panel", status: "done"}
      - {id: "FW2-5", layer: "FE-Web", summary: "Message actions", status: "done"}
      - {id: "FW2-6", layer: "FE-Web", summary: "File upload (drag + progress)", status: "done"}
      - {id: "FW2-7", layer: "FE-Web", summary: "WS connection management", status: "done"}
      - {id: "FW2-8", layer: "FE-Web", summary: "OpenAPI type sync", status: "done"}
      - {id: "FW2-9", layer: "FE-Web", summary: "SSE EventSource client", status: "done"}
      - {id: "FA2-1", layer: "FE-Admin", summary: "User management DataTable", status: "done"}
      - {id: "FA2-2", layer: "FE-Admin", summary: "Organization management", status: "done"}
      - {id: "FA2-3", layer: "FE-Admin", summary: "Audit log viewer", status: "done"}
      # Crosscutting
      - {id: "D2-1", layer: "Delivery", summary: "Frontend CI pipeline", status: "done"}
      - {id: "D2-2", layer: "Delivery", summary: "OpenAPI type sync CI gate", status: "done"}
      - {id: "D2-3", layer: "Delivery", summary: "Dogfooding environment", status: "done"}
      - {id: "D2-4", layer: "Delivery", summary: "Resource consumption data", status: "done"}
      - {id: "D2-5", layer: "Delivery", summary: "verify-phase-2", status: "done"}
      - {id: "OS2-1", layer: "Observability", summary: "4 golden signals", status: "done"}
      - {id: "OS2-2", layer: "Observability", summary: "Basic alert rules", status: "done"}
      - {id: "OS2-3", layer: "Observability", summary: "Token anomaly alert", status: "done"}
      - {id: "OS2-4", layer: "Observability", summary: "Structured error logging", status: "done"}
      - {id: "OS2-5", layer: "Observability", summary: "FE error boundary + Sentry", status: "done"}
    exit_criteria:
      hard:
        - id: "p2-brain-engine"
          description: "Brain conversation engine tests pass"
          check: "uv run pytest tests/unit/brain/ -q --tb=short"

        - id: "p2-memory-core"
          description: "MemoryCore CRUD + pgvector tests pass"
          check: "uv run pytest tests/unit/memory/ -q --tb=short"

        - id: "p2-gateway-all"
          description: "Gateway unit tests pass (REST + WS + SSE + auth + rate limit)"
          check: "uv run pytest tests/unit/gateway/ -q --tb=short"

        - id: "p2-fe-web-build"
          description: "Frontend web app builds"
          check: "cd frontend && pnpm run build --filter web"

        - id: "p2-fe-admin-build"
          description: "Frontend admin app builds"
          check: "cd frontend && pnpm run build --filter admin"

        - id: "p2-knowledge-port"
          description: "Knowledge port unit tests pass"
          check: "uv run pytest tests/unit/knowledge/ -q --tb=short"

        - id: "p2-integration"
          description: "Integration tests pass (memory + redis + celery + brain + llm)"
          check: "uv run pytest tests/integration/ -q --tb=short"

        - id: "p2-lint"
          description: "Full lint (ruff + frontend ESLint)"
          check: "make lint"

        - id: "p2-no-mock-py"
          description: "No banned mock patterns in Python"
          check: "uv run python scripts/check_no_mock.py src/ tests/"

        - id: "p2-no-mock-ts"
          description: "No banned mock patterns in TypeScript"
          check: "cd frontend && node ../scripts/check_no_mock_ts.mjs ."

        - id: "p2-layer-boundary"
          description: "Layer boundary violations = 0"
          check: "bash scripts/check_layer_deps.sh --json"

        - id: "p2-security-scan"
          description: "Security scan (semgrep + pip-audit)"
          check: "bash scripts/security_scan.sh --full"

        - id: "p2-e2e-conversation-loop"
          description: "E2E conversation loop (integration-level, Fake adapters): chat -> remember -> recall -> inject"
          check: "uv run pytest tests/e2e/test_conversation_loop.py -q --tb=short"

        # --- Cross-layer integration gate (hard = Fake adapter, no external services) ---
        - id: "p2-x2-1-conversation-loop"
          description: "Cross-layer: full conversation loop + streaming E2E (X2-1, X2-2)"
          check: "uv run pytest tests/e2e/cross/test_conversation_loop.py -v --tb=short"
          xnodes: [X2-1, X2-2]

        - id: "p2-xf2-4-openapi-sync"
          description: "Cross-layer FE: OpenAPI type consistency (XF2-4)"
          check: "bash scripts/check_openapi_sync.sh"
          xnodes: [XF2-4]

        - id: "p2-env-completeness"
          description: "All source-referenced env vars present in .env.example"
          check: "uv run python scripts/check_env_completeness.py"

        - id: "p2-no-vacuous-pass"
          description: "No all-skip vacuous pass in gate-critical E2E tests"
          check: "uv run python scripts/check_no_vacuous_pass.py tests/e2e/cross/ frontend/tests/e2e/cross/"

      soft:
        - id: "p2-streaming"
          description: "SSE streaming e2e test"
          check: "cd frontend && pnpm exec playwright test tests/e2e/web/chat/streaming.spec.ts"

        # --- Cross-layer integration gate (soft = needs external services) ---
        - id: "p2-x2-3-memory-evolution"
          description: "Cross-layer: memory evolution closed loop (X2-3)"
          check: "uv run pytest tests/e2e/cross/test_memory_evolution.py -v --tb=short"
          xnodes: [X2-3]

        - id: "p2-x2-4-token-backpressure"
          description: "Cross-layer: token budget backpressure (X2-4)"
          check: "uv run pytest tests/e2e/cross/test_token_backpressure.py -v --tb=short"
          xnodes: [X2-4]

        - id: "p2-xf2-1-login-to-streaming"
          description: "Cross-layer FE: login -> org -> chat -> streaming (XF2-1/2/3)"
          check: "cd frontend && pnpm exec playwright test tests/e2e/cross/web/login-to-streaming.spec.ts"
          xnodes: [XF2-1, XF2-2, XF2-3]

        - id: "p2-x2-5-golden-signals"
          description: "Cross-layer: 4 golden signals e2e (X2-5)"
          check: "uv run pytest tests/e2e/cross/test_golden_signals.py -v --tb=short"
          xnodes: [X2-5]

        - id: "p2-x2-6-fe-error-boundary"
          description: "Cross-layer: FE error boundary closed loop (X2-6)"
          check: "cd frontend && pnpm exec playwright test tests/e2e/cross/web/error-boundary.spec.ts"
          xnodes: [X2-6]

    go_no_go:
      hard_pass_rate: 1.0
      xnode_coverage_min: 0.40
      approver: "architect"

  phase_3:
    name: "Knowledge & Skill Ecosystem"
    depends_on: ["phase_2"]
    milestones:
      # Backend
      - {id: "B3-1", layer: "Brain", summary: "Skill Router"}
      - {id: "B3-2", layer: "Brain", summary: "Skill orchestration flow"}
      - {id: "B3-3", layer: "Brain", summary: "Role adaptation module"}
      - {id: "B3-4", layer: "Brain", summary: "Negative feedback fuse"}
      - {id: "MC3-1", layer: "MemoryCore", summary: "Promotion Pipeline"}
      - {id: "MC3-2", layer: "MemoryCore", summary: "promotion_receipt"}
      - {id: "K3-1", layer: "Knowledge", summary: "Neo4j schema + seed data"}
      - {id: "K3-2", layer: "Knowledge", summary: "Qdrant init + seed data"}
      - {id: "K3-3", layer: "Knowledge", summary: "FK linkage mechanism"}
      - {id: "K3-4", layer: "Knowledge", summary: "Knowledge Write API"}
      - {id: "K3-5", layer: "Knowledge", summary: "Diyu Resolver minimal"}
      - {id: "K3-6", layer: "Knowledge", summary: "Entity type registration"}
      - {id: "K3-7", layer: "Knowledge", summary: "ERP/PIM ChangeSet interface"}
      - {id: "S3-1", layer: "Skill", summary: "ContentWriterSkill"}
      - {id: "S3-2", layer: "Skill", summary: "MerchandisingSkill"}
      - {id: "S3-3", layer: "Skill", summary: "Skill lifecycle management"}
      - {id: "S3-4", layer: "Skill", summary: "Skill param validation"}
      - {id: "T3-1", layer: "Tool", summary: "WebSearch Tool"}
      - {id: "T3-2", layer: "Tool", summary: "ImageAnalyze Tool"}
      - {id: "T3-3", layer: "Tool", summary: "AudioTranscribe Tool"}
      - {id: "G3-1", layer: "Gateway", summary: "Knowledge Admin API"}
      - {id: "G3-2", layer: "Gateway", summary: "Skill API"}
      - {id: "G3-3", layer: "Gateway", summary: "Content security check"}
      - {id: "I3-1", layer: "Infra", summary: "Neo4j connection + CRUD"}
      - {id: "I3-2", layer: "Infra", summary: "Qdrant connection + CRUD"}
      - {id: "I3-3", layer: "Infra", summary: "ObjectStoragePort (S3/MinIO)"}
      - {id: "I3-4", layer: "Infra", summary: "tool_usage_records DDL"}
      # Frontend
      - {id: "FW3-1", layer: "FE-Web", summary: "Knowledge browse page"}
      - {id: "FW3-2", layer: "FE-Web", summary: "Skill artifact render"}
      - {id: "FW3-3", layer: "FE-Web", summary: "Product components"}
      - {id: "FA3-1", layer: "FE-Admin", summary: "Knowledge editor workbench"}
      - {id: "FA3-2", layer: "FE-Admin", summary: "Content review queue"}
      - {id: "FA3-3", layer: "FE-Admin", summary: "org_settings config mgmt"}
      # Crosscutting
      - {id: "D3-1", layer: "Delivery", summary: "manifest.yaml real values"}
      - {id: "D3-2", layer: "Delivery", summary: "Installer productization"}
      - {id: "D3-3", layer: "Delivery", summary: "deploy/manifest drift check"}
      - {id: "D3-4", layer: "Delivery", summary: "verify-phase-3"}
      - {id: "MM1-1", layer: "Multimodal", summary: "Personal media upload API"}
      - {id: "MM1-2", layer: "Multimodal", summary: "WS payload media extension"}
      - {id: "MM1-3", layer: "Multimodal", summary: "ImageAnalyze + AudioTranscribe"}
      - {id: "MM1-4", layer: "Multimodal", summary: "Brain multimodal model selection"}
      - {id: "MM1-5", layer: "Multimodal", summary: "security_status 3-layer intercept"}
      - {id: "MM1-6", layer: "Multimodal", summary: "Personal media delete tombstone"}
      - {id: "OS3-1", layer: "Observability", summary: "Content security pipeline"}
      - {id: "OS3-2", layer: "Observability", summary: "Audit loop all CRUD"}
      - {id: "OS3-3", layer: "Observability", summary: "Knowledge write XSS protection"}
      - {id: "OS3-4", layer: "Observability", summary: "Resolver query audit"}
      - {id: "OS3-5", layer: "Observability", summary: "API rate limit alert"}
      - {id: "OS3-6", layer: "Observability", summary: "Tenant isolation runtime"}
      - {id: "D3-5", layer: "Delivery", summary: "SBOM attestation"}
    exit_criteria:
      hard:
        # --- Phase 3 专属 (7 项) ---
        - id: "p3-knowledge-crud"
          description: "Knowledge CRUD API tests (FK linkage + admin API)"
          check: "uv run pytest tests/unit/knowledge/ tests/integration/knowledge/ -q"
          xnodes: ["X3-2", "X3-4"]

        - id: "p3-skill-registry"
          description: "Skill registry + E2E skill loop tests"
          check: "uv run pytest tests/unit/skill/ -q"
          xnodes: ["X3-1"]

        - id: "p3-tool-execution"
          description: "Tool execution sandbox tests (Phase 3 new tools only)"
          check: "uv run pytest tests/unit/tool/test_web_search.py tests/unit/tool/test_image_analyze.py tests/unit/tool/test_audio_transcribe.py -q"
          xnodes: ["XM1-1"]

        - id: "p3-fe-knowledge"
          description: "Frontend knowledge + skill + admin pages build + exist"
          check: "cd frontend && pnpm run build && test -f apps/web/app/knowledge/page.tsx && test -f apps/admin/app/knowledge/page.tsx && test -f apps/admin/app/knowledge/review/page.tsx"
          xnodes: ["XF3-1", "XF3-2", "XF3-3"]

        - id: "p3-promotion-pipeline"
          description: "Memory->Knowledge promotion pipeline cross-SSOT"
          check: "uv run pytest tests/unit/memory/test_promotion.py tests/integration/test_promotion.py -q"
          xnodes: ["X3-3"]

        - id: "p3-content-security"
          description: "Content security pipeline (security_status 6-state)"
          check: "uv run pytest tests/unit/gateway/test_content_pipeline.py -q"
          xnodes: ["X3-5", "XM1-2"]

        - id: "p3-resolver-audit"
          description: "Resolver query audit (who/when/what/why)"
          check: "uv run pytest tests/unit/knowledge/test_resolver_audit.py -q"
          xnodes: ["X3-6"]

        # --- 决策文档新增 (2 项) ---
        - id: "p3-tenant-isolation-runtime"
          description: "Runtime tenant isolation (cross-org blocked)"
          check: "uv run pytest tests/isolation/test_tenant_crossover.py -q"

        - id: "p3-env-completeness"
          description: "All source-referenced env vars present in .env.example"
          check: "uv run python scripts/check_env_completeness.py"

        # --- 继承 Phase 2 通用质量门禁 (5 项) ---
        - id: "p3-lint"
          description: "Full lint (ruff + frontend ESLint)"
          check: "make lint"

        - id: "p3-security-scan"
          description: "Security scan (semgrep + pip-audit)"
          check: "bash scripts/security_scan.sh --full"

        - id: "p3-layer-boundary"
          description: "Layer boundary violations = 0"
          check: "bash scripts/check_layer_deps.sh --json"

        - id: "p3-no-mock-py"
          description: "No banned mock patterns in Python"
          check: "uv run python scripts/check_no_mock.py src/ tests/"

        - id: "p3-integration"
          description: "Integration tests pass"
          check: "uv run pytest tests/integration/ -q --tb=short"

      soft:
        - id: "p3-graph-perf"
          description: "Knowledge graph query p95 < 200ms"
          check: "uv run pytest tests/perf/test_knowledge_query.py -q"

        - id: "p3-sbom-attestation"
          description: "SBOM signed with cosign (Phase 3 soft, Phase 4 hard)"
          check: "bash scripts/sign_sbom.sh"

    go_no_go:
      hard_pass_rate: 1.0
      xnode_coverage_min: 0.70
      approver: "architect"

  phase_4:
    name: "Full Feature + Performance"
    depends_on: ["phase_3"]
    milestones:
      # Backend
      - {id: "B4-1", layer: "Brain", summary: "Context Assembler perf P95<200ms"}
      - {id: "B4-2", layer: "Brain", summary: "Dynamic budget allocator v1"}
      - {id: "B4-3", layer: "Brain", summary: "TruncationPolicy"}
      - {id: "B4-4", layer: "Brain", summary: "7 SLI instrumentation"}
      - {id: "B4-5", layer: "Brain", summary: "Sanitization pattern-based"}
      - {id: "MC4-1", layer: "MemoryCore", summary: "Delete pipeline 8-state FSM"}
      - {id: "MC4-2", layer: "MemoryCore", summary: "Backup restore drill"}
      - {id: "MC4-3", layer: "MemoryCore", summary: "deletion_timeout_rate SLI=0%"}
      - {id: "K4-1", layer: "Knowledge", summary: "Graph query perf baseline"}
      - {id: "K4-2", layer: "Knowledge", summary: "Vector search perf baseline"}
      - {id: "K4-3", layer: "Knowledge", summary: "FK Reconciliation Job"}
      - {id: "S4-1", layer: "Skill", summary: "Skill circuit breaker"}
      - {id: "S4-2", layer: "Skill", summary: "Skill execution timeout"}
      - {id: "T4-1", layer: "Tool", summary: "Tool independent billing"}
      - {id: "T4-2", layer: "Tool", summary: "Tool retry + exponential backoff"}
      - {id: "G4-1", layer: "Gateway", summary: "SLO metrics + alerts"}
      - {id: "G4-2", layer: "Gateway", summary: "HA validation"}
      - {id: "G4-3", layer: "Gateway", summary: "Per-org/user rate limiting"}
      - {id: "I4-1", layer: "Infra", summary: "Prometheus + Grafana stack"}
      - {id: "I4-2", layer: "Infra", summary: "PG failover drill"}
      - {id: "I4-3", layer: "Infra", summary: "Backup restore drill PG"}
      - {id: "I4-4", layer: "Infra", summary: "Fault injection tests"}
      - {id: "I4-5", layer: "Infra", summary: "PIPL/GDPR delete pipeline"}
      # Frontend
      - {id: "FW4-1", layer: "FE-Web", summary: "Performance budget pass"}
      - {id: "FW4-2", layer: "FE-Web", summary: "a11y check pass"}
      - {id: "FW4-3", layer: "FE-Web", summary: "Dark/light mode"}
      - {id: "FW4-4", layer: "FE-Web", summary: "Keyboard shortcuts"}
      - {id: "FW4-5", layer: "FE-Web", summary: "Billing recharge page"}
      - {id: "FA4-1", layer: "FE-Admin", summary: "System monitoring dashboard"}
      - {id: "FA4-2", layer: "FE-Admin", summary: "Quota management"}
      - {id: "FA4-3", layer: "FE-Admin", summary: "Backup management"}
      # Crosscutting
      - {id: "D4-1", layer: "Delivery", summary: "Upgrade rollback process"}
      - {id: "D4-2", layer: "Delivery", summary: "Backup restore drill gate"}
      - {id: "D4-3", layer: "Delivery", summary: "One-click diag package"}
      - {id: "D4-4", layer: "Delivery", summary: "Key rotation + cert mgmt"}
      - {id: "D4-5", layer: "Delivery", summary: "Lightweight offline deploy"}
      - {id: "D4-6", layer: "Delivery", summary: "verify-phase-4"}
      - {id: "MM2-1", layer: "Multimodal", summary: "Enterprise media upload API"}
      - {id: "MM2-2", layer: "Multimodal", summary: "KnowledgeBundle media extension"}
      - {id: "MM2-3", layer: "Multimodal", summary: "enterprise_media Neo4j FK"}
      - {id: "MM2-4", layer: "Multimodal", summary: "Skill multimodal capability"}
      - {id: "MM2-5", layer: "Multimodal", summary: "DocumentExtract Tool"}
      - {id: "MM2-6", layer: "Multimodal", summary: "Enterprise media delete cascade"}
      - {id: "OS4-1", layer: "Observability", summary: "7 Brain SLI Grafana dashboard"}
      - {id: "OS4-2", layer: "Observability", summary: "SLO definition"}
      - {id: "OS4-3", layer: "Observability", summary: "Alert tiering P0/P1/P2"}
      - {id: "OS4-4", layer: "Observability", summary: "Full-chain trace_id"}
      - {id: "OS4-5", layer: "Observability", summary: "Fault injection delete pipeline"}
      - {id: "OS4-6", layer: "Observability", summary: "Fault injection LLM provider"}
      - {id: "OS4-7", layer: "Observability", summary: "Pentest OWASP Top 10"}
      - {id: "OS4-8", layer: "Observability", summary: "FE a11y axe-core audit"}
    exit_criteria:
      hard:
        # === Group 1: Core Quality Gates (4) ===
        - id: "p4-coverage"
          description: "Test coverage >= 80%"
          check: "uv run pytest tests/ --cov=src --cov-fail-under=80 -q"

        - id: "p4-fe-build"
          description: "Full frontend build passes"
          check: "cd frontend && pnpm run build"

        - id: "p4-lighthouse"
          description: "Lighthouse CI performance budget (LCP<2.5s/FID<100ms/CLS<0.1/200KB)"
          check: "cd frontend && pnpm exec lhci autorun"
          xnodes: ["XF4-1"]

        - id: "p4-a11y"
          description: "Zero critical a11y violations (axe-core)"
          check: "cd frontend && pnpm exec axe-core-cli --exit"

        # === Group 2: Cross-Layer E2E Verification (6) ===
        - id: "p4-trace-e2e"
          description: "Full-chain trace_id propagation E2E"
          check: "uv run pytest tests/e2e/cross/test_trace_id_full_stack.py -v"
          xnodes: ["X4-1"]

        - id: "p4-ssot-drift"
          description: "Triple SSOT consistency check (Decision docs <-> Port signatures <-> manifest)"
          check: "bash scripts/check_ssot_drift.sh"
          xnodes: ["X4-3"]

        - id: "p4-delete-e2e"
          description: "Delete pipeline E2E (request -> tombstone -> physical delete -> audit -> storage cleanup)"
          check: "uv run pytest tests/e2e/cross/test_delete_pipeline_e2e.py -v"
          xnodes: ["X4-4"]

        - id: "p4-fault-injection"
          description: "Fault injection + recovery (delete pipeline + LLM provider)"
          check: "uv run pytest tests/e2e/cross/test_fault_injection.py -v"
          xnodes: ["X4-6"]

        - id: "p4-billing-e2e"
          description: "Billing flow E2E (quota exhaustion -> recharge -> balance update)"
          check: "cd frontend && pnpm exec playwright test tests/e2e/cross/web/billing-flow.spec.ts"
          xnodes: ["XF4-1"]

        - id: "p4-memory-privacy-e2e"
          description: "Memory privacy E2E (view AI memory -> delete -> confirm deletion)"
          check: "cd frontend && pnpm exec playwright test tests/e2e/cross/web/memory-privacy.spec.ts"
          xnodes: ["XF4-3"]

        # === Group 3: Operational Hardening (6) ===
        - id: "p4-release-drill"
          description: "Upgrade/rollback drill (upgrade -> downgrade -> upgrade, data integrity verified)"
          check: "bash scripts/drill_release.sh"
          xnodes: ["X4-2"]

        - id: "p4-dr-restore"
          description: "Backup restore drill (PG + evidence integrity)"
          check: "bash scripts/drill_dr_restore.sh"

        - id: "p4-dependency-chaos"
          description: "Dependency chaos testing (CB-4 scenarios)"
          check: "uv run pytest tests/e2e/cross/test_dependency_chaos.py -v"

        - id: "p4-incident-readiness"
          description: "Incident management readiness (SLA + alerts + runbooks + on-call)"
          check: "python3 scripts/check_incident_readiness.py"

        - id: "p4-alert-routing"
          description: "Alert routing validation (severity labels + routing rules)"
          check: "python3 scripts/check_alert_routing.py"

        - id: "p4-compliance-artifacts"
          description: "Compliance artifacts complete (SBOM + ADR + threat model)"
          check: "python3 scripts/check_compliance_artifacts.py"

        # === Group 4: SLO / Observability (4) ===
        - id: "p4-slo-metrics"
          description: "SLI/SLO metrics + alerts operational (7 Brain SLI + API SLO in Grafana)"
          check: "python3 scripts/check_slo_budget.py"
          xnodes: ["X4-5"]

        - id: "p4-slo-burn-rate"
          description: "SLO burn-rate alert rules configured (fast 14.4x + slow 6x)"
          check: "python3 scripts/check_alert_routing.py --verify-burn-rate"

        - id: "p4-monitoring-dashboard"
          description: "Admin monitoring dashboard E2E"
          check: "cd frontend && pnpm exec playwright test tests/e2e/cross/admin/monitoring-dashboard.spec.ts"
          xnodes: ["XF4-2"]

        - id: "p4-xnode-coverage"
          description: "XNode result coverage >= 90%"
          check: "python3 scripts/check_xnode_coverage.py --phase 4 --verify-results"

        # === Group 5: Security + Compliance (2) ===
        - id: "p4-pentest-report"
          description: "Pentest OWASP Top 10 report: zero Critical/High (OWASP ZAP)"
          check: "python3 scripts/check_pentest_report.py"
          xnodes: ["X4-7"]

        - id: "p4-sbom-attestation"
          description: "SBOM cosign attestation (hard gate, signing required)"
          check: "bash scripts/sign_sbom.sh"

        # === Group 6: Performance + HA (2) ===
        - id: "p4-perf-baseline"
          description: "Performance baseline (Assembler P95<200ms, Graph P95<100ms, Vector P95<50ms)"
          check: "uv run pytest tests/perf/ -v --timeout=600"

        - id: "p4-ha-validation"
          description: "HA failover validation (<30s recovery, 2 app + nginx + PG primary/standby)"
          check: "bash scripts/check_ha_validation.sh"

        # === Group 7: Delivery Completeness (2) ===
        - id: "p4-diag-package"
          description: "One-click diagnostic package (diyu_diagnose.sh collects logs+metrics+config)"
          check: "bash scripts/diyu_diagnose.sh --dry-run"

        - id: "p4-key-rotation"
          description: "Key rotation + cert management (rotate_secrets.sh covers JWT+DB+MinIO+LLM)"
          check: "bash scripts/rotate_secrets.sh --dry-run"

        # === Group 8: Multimodal (2) ===
        - id: "p4-enterprise-media"
          description: "Enterprise media dual-write + FK verification (Neo4j + Qdrant consistency)"
          check: "uv run pytest tests/integration/knowledge/test_enterprise_media_fk.py -v"
          xnodes: ["XM2-1"]

        - id: "p4-media-safety"
          description: "Enterprise media NSFW + copyright precheck"
          check: "uv run pytest tests/integration/test_media_safety.py -v"
          xnodes: ["XM2-2"]

        # === Group 9: Postmortem + CAPA (1) ===
        - id: "p4-postmortem-capa"
          description: "Postmortem template + CAPA register exist and schema-valid"
          check: "python3 scripts/check_postmortem_capa.py"

      soft: []

    go_no_go:
      hard_pass_rate: 1.0
      xnode_coverage_min: 0.90
      approver: "architect"

  phase_5:
    name: "Advanced Experience + Compliance"
    depends_on: ["phase_4"]
    milestones:
      # Backend
      - {id: "B5-1", layer: "Brain", summary: "Memory Governor"}
      - {id: "B5-2", layer: "Brain", summary: "Confidence Calibration"}
      - {id: "B5-3", layer: "Brain", summary: "AssemblyProfile multi-LLM"}
      - {id: "B5-4", layer: "Brain", summary: "Memory Consolidation"}
      - {id: "MC5-1", layer: "MemoryCore", summary: "Auto merge similar memories"}
      - {id: "MC5-2", layer: "MemoryCore", summary: "Contextual Chunking embedding"}
      - {id: "MC5-3", layer: "MemoryCore", summary: "Crypto Shredding per-user"}
      - {id: "K5-1", layer: "Knowledge", summary: "Capability Registry"}
      - {id: "K5-2", layer: "Knowledge", summary: "Explainability panel"}
      - {id: "S5-1", layer: "Skill", summary: "Skill A/B Testing"}
      - {id: "S5-2", layer: "Skill", summary: "Skill multimodal declaration"}
      - {id: "T5-1", layer: "Tool", summary: "Tool cost dashboard"}
      - {id: "T5-2", layer: "Tool", summary: "LLMCallPort Contract evaluation"}
      - {id: "G5-1", layer: "Gateway", summary: "API version negotiation"}
      - {id: "G5-2", layer: "Gateway", summary: "API deprecation warning"}
      - {id: "I5-1", layer: "Infra", summary: "Event Mesh evolution"}
      - {id: "I5-2", layer: "Infra", summary: "Schema Registry"}
      # Frontend
      - {id: "FW5-1", layer: "FE-Web", summary: "Voice interaction"}
      - {id: "FA5-1", layer: "FE-Admin", summary: "Compliance report"}
      - {id: "FA5-2", layer: "FE-Admin", summary: "Exception Register UI"}
      # Crosscutting
      - {id: "D5-1", layer: "Delivery", summary: "3 SSOT auto consistency"}
      - {id: "D5-2", layer: "Delivery", summary: "Exception Register audit"}
      - {id: "D5-3", layer: "Delivery", summary: "Monthly arch audit template"}
      - {id: "D5-4", layer: "Delivery", summary: "verify-phase-5"}
      - {id: "MM3-1", layer: "Multimodal", summary: "Copyright risk detection"}
      - {id: "MM3-2", layer: "Multimodal", summary: "Cross-modal semantic search"}
      - {id: "MM3-3", layer: "Multimodal", summary: "LLMCallPort Contract eval"}
      - {id: "OS5-1", layer: "Observability", summary: "3 SSOT auto consistency check"}
      - {id: "OS5-2", layer: "Observability", summary: "Guard auto-block strategy"}
      - {id: "OS5-3", layer: "Observability", summary: "Exception Register expiry audit"}
      - {id: "OS5-4", layer: "Observability", summary: "Monthly arch deviation audit"}
      - {id: "OS5-5", layer: "Observability", summary: "GDPR/PIPL compliance report"}
      - {id: "OS5-6", layer: "Observability", summary: "Security incident runbook"}
    exit_criteria:
      hard:
        - id: "p5-compliance-report"
          description: "Compliance report generation"
          check: "uv run pytest tests/unit/compliance/ -q"

        - id: "p5-backup-drill"
          description: "Backup-restore drill evidence exists"
          check: "test -f evidence/release/backup-drill.json"

        - id: "p5-full-e2e"
          description: "Full e2e test suite passes"
          check: "cd frontend && pnpm exec playwright test"

      soft:
        - id: "p5-voice"
          description: "Voice interaction available"
          check: "cd frontend && pnpm exec playwright test tests/e2e/web/voice/"

    go_no_go:
      hard_pass_rate: 1.0
      xnode_coverage_min: 1.0
      approver: "architect"
