# DIYU Agent CI Pipeline
# L1 quality gates only; L3 task-card checks are in task-card-check.yml

name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1"  # Weekly Monday 06:00 UTC
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: read
  security-events: write  # required for SARIF upload to GitHub Code Scanning

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "22"
  UV_CACHE_DIR: /tmp/uv-cache
  EVIDENCE_DIR: evidence/${{ github.sha }}

jobs:
  # L1: Security scanning (H-4 + H-5, PR blocking)
  # REQUIRED: GitHub Settings > Branches > main >
  #   Require status checks > Add "L1: Security Scan"
  # Verification: gh api repos/{owner}/{repo}/rules
  #   or: gh api repos/{owner}/{repo}/branches/main/protection
  security-scan:
    name: "L1: Security Scan"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - name: Install semgrep
        run: uv tool install semgrep
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: cd frontend && pnpm install --frozen-lockfile
      - name: Secret scanning (gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
      - name: SAST + dependency audit (unified)
        run: bash scripts/security_scan.sh --ci
      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        if: always() && hashFiles('evidence/security-scan.sarif') != ''
        continue-on-error: true  # May fail if Code Scanning not enabled on repo
        with:
          sarif_file: evidence/security-scan.sarif
      - name: Upload security evidence
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-evidence
          path: evidence/security-scan.*

  # L1: Deterministic checks (always run)
  lint-backend:
    name: "L1: Backend Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - run: uv run ruff check src/ tests/ scripts/
      - run: uv run ruff format --check src/ tests/ scripts/

  lint-frontend:
    name: "L1: Frontend Lint"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: cd frontend && pnpm install --frozen-lockfile
      - run: cd frontend && pnpm run lint

  # L1: Type checking
  typecheck-backend:
    name: "L1: Backend Typecheck"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - run: uv run mypy src/

  typecheck-frontend:
    name: "L1: Frontend Typecheck"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: cd frontend && pnpm install --frozen-lockfile
      - run: cd frontend && pnpm run typecheck

  # L1: Unit tests
  test-backend:
    name: "L1: Backend Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - run: |
          mkdir -p ${{ env.EVIDENCE_DIR }}
          uv run pytest tests/unit/ -v --tb=short \
            --cov=src --cov-report=xml:${{ env.EVIDENCE_DIR }}/coverage.xml \
            --cov-report=term-missing --cov-fail-under=80 \
            --junitxml=${{ env.EVIDENCE_DIR }}/test-results.xml
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-test-results
          path: ${{ env.EVIDENCE_DIR }}/

  # P2 E2E: Conversation loop state cycle
  # REQUIRED: GitHub Settings > Branches > main >
  #   Require status checks > Add "P2: E2E Conversation Loop"
  # NOTE: Branch protection "required check" needs manual configuration
  #   in GitHub Settings after this workflow is merged.
  test-e2e:
    name: "P2: E2E Conversation Loop"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - run: uv run pytest tests/e2e/test_conversation_loop.py -v --tb=short

  test-frontend:
    name: "L1: Frontend Tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: cd frontend && pnpm install --frozen-lockfile
      - run: cd frontend && pnpm run test

  # D2-1: Frontend a11y check (eslint-plugin-jsx-a11y via lint)
  a11y-frontend:
    name: "L1: Frontend A11y"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: cd frontend && pnpm install --frozen-lockfile
      - run: cd frontend && pnpm run lint

  # D2-2: OpenAPI type sync CI gate
  openapi-sync:
    name: "L1: OpenAPI Sync"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: cd frontend && pnpm install --frozen-lockfile
      - run: bash scripts/check_openapi_sync.sh

  # L1: Guard scripts (consumes change-impact outputs when available)
  guard-checks:
    name: "L1: Guard Scripts"
    runs-on: ubuntu-latest
    needs: [change-impact]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - name: Install semgrep (needed by verify_phase security gate)
        run: uv tool install semgrep
      - name: Run layer dependency check (always, or if src gate triggered)
        if: |
          always() && (
            needs.change-impact.outputs.triggered_gates == '' ||
            contains(needs.change-impact.outputs.triggered_gates, 'check_layer_deps')
          )
        run: bash scripts/check_layer_deps.sh --json
      - name: Log triggered gates from impact analysis
        if: needs.change-impact.outputs.triggered_gates != ''
        run: |
          echo "Triggered gates: ${{ needs.change-impact.outputs.triggered_gates }}"
          echo "Risk score: ${{ needs.change-impact.outputs.risk_score }}"
      - name: Run governance checks (if governance gate triggered)
        if: contains(needs.change-impact.outputs.triggered_gates, 'governance')
        run: |
          uv run python scripts/check_task_schema.py --mode full --json
          uv run python scripts/count_task_cards.py --json
      - name: Run port compatibility check (if ports gate triggered)
        if: contains(needs.change-impact.outputs.triggered_gates, 'check_port_compat')
        run: bash scripts/check_port_compat.sh
      - name: Run RLS check (if infra gate triggered)
        if: contains(needs.change-impact.outputs.triggered_gates, 'isolation_smoke')
        run: bash scripts/check_rls.sh
      - name: Run migration safety check (if migration gate triggered)
        if: contains(needs.change-impact.outputs.triggered_gates, 'check_migration')
        run: bash scripts/check_migration.sh
      - name: Setup pnpm (if fe gate triggered)
        if: |
          contains(needs.change-impact.outputs.triggered_gates, 'fe_lint') ||
          contains(needs.change-impact.outputs.triggered_gates, 'fe_test') ||
          contains(needs.change-impact.outputs.triggered_gates, 'contract_test')
        uses: pnpm/action-setup@v4
        with:
          version: 9
      - name: Setup Node.js (if fe gate triggered)
        if: |
          contains(needs.change-impact.outputs.triggered_gates, 'fe_lint') ||
          contains(needs.change-impact.outputs.triggered_gates, 'fe_test') ||
          contains(needs.change-impact.outputs.triggered_gates, 'contract_test')
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - name: Install frontend deps (if fe gate triggered)
        if: |
          contains(needs.change-impact.outputs.triggered_gates, 'fe_lint') ||
          contains(needs.change-impact.outputs.triggered_gates, 'fe_test') ||
          contains(needs.change-impact.outputs.triggered_gates, 'contract_test')
        run: cd frontend && pnpm install --frozen-lockfile
      - name: Run frontend lint (if fe gate triggered)
        if: contains(needs.change-impact.outputs.triggered_gates, 'fe_lint')
        run: cd frontend && pnpm run lint
      - name: Run frontend tests (if fe gate triggered)
        if: contains(needs.change-impact.outputs.triggered_gates, 'fe_test')
        run: cd frontend && pnpm run test
      - name: Run contract tests (if api-client gate triggered)
        if: contains(needs.change-impact.outputs.triggered_gates, 'contract_test')
        run: cd frontend && pnpm --filter @diyu/api-client run test
      - name: Run OpenAPI sync check (if openapi gate triggered)
        if: contains(needs.change-impact.outputs.triggered_gates, 'openapi_sync')
        run: bash scripts/check_openapi_sync.sh
      # V4 Phase 2 guards (always run, blocking)
      - name: Phase 2 gate verification
        run: uv run python scripts/verify_phase.py --phase 2 --json
      - name: Python no-mock check
        run: uv run python scripts/check_no_mock.py src/ tests/
      - name: TypeScript no-mock check
        run: node scripts/check_no_mock_ts.mjs frontend/
      - name: Validate Phase 2 runtime config
        run: uv run python scripts/validate_phase2_config.py
      - name: Lint workflow check commands
        run: |
          for f in delivery/v4-workflows.yaml delivery/v4-phase2-workflows.yaml; do
            if [ -f "$f" ]; then
              uv run python scripts/lint_workflow_checks.py "$f"
            fi
          done

  # Audit system self-check (triggered by audit infrastructure changes)
  audit-system-check:
    name: "Audit System Check"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - name: Check for audit infrastructure changes
        id: audit-changes
        run: |
          # Verify base ref is available; fail explicitly if not
          if ! git rev-parse --verify "origin/${{ github.base_ref }}" >/dev/null 2>&1; then
            echo "ERROR: origin/${{ github.base_ref }} not found -- fetch-depth may be insufficient" >&2
            exit 1
          fi
          CHANGED=$(git diff --name-only "origin/${{ github.base_ref }}...HEAD" -- \
            '.claude/skills/**' \
            '.claude/commands/**' \
            'scripts/validate_audit_artifacts.py' \
            'scripts/schemas/**' \
            'scripts/run_*.sh')
          if [ -n "$CHANGED" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changed audit files:"
            echo "$CHANGED"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No audit infrastructure changes detected"
          fi
      - name: Run audit artifact validation
        if: steps.audit-changes.outputs.has_changes == 'true'
        run: |
          if ls evidence/*.json 1>/dev/null 2>&1; then
            make audit-artifacts
          else
            echo "::warning::No evidence artifacts present (gitignored) -- generate locally with: make audit-e2e"
            echo "Skipping artifact validation in CI (evidence/ is gitignored by design)"
          fi
      - name: Run audit-related unit tests
        if: steps.audit-changes.outputs.has_changes == 'true'
        run: |
          uv run pytest tests/unit/scripts/test_audit_artifact_schema.py \
            tests/unit/scripts/test_audit_command_contracts.py -v --tb=short

  # Skills governance check (D10 requirement)
  skills-governance-check:
    name: "Skills Governance Check"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - name: Validate skills governance
        run: make skills-validate
      - name: Run skills governance tests
        run: make skills-smoke

  # L2: Semantic checks (independent job -- contract tests + isolation smoke + port compat)
  semantic-checks:
    name: "L2: Semantic Checks"
    runs-on: ubuntu-latest
    needs: [change-impact]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml
      - run: cd frontend && pnpm install --frozen-lockfile
      - name: Port compatibility check
        run: bash scripts/check_port_compat.sh
      - name: RLS isolation smoke
        run: bash scripts/check_rls.sh
      - name: Migration safety check
        run: bash scripts/check_migration.sh
      - name: Contract tests (api-client)
        run: cd frontend && pnpm --filter @diyu/api-client run test
      - name: Acceptance gate (env-dep mapping)
        run: uv run python scripts/check_acceptance_gate.py --json
      - name: SBOM generation and validation
        run: bash scripts/generate_sbom.sh --validate

  # Impact analysis (consumed by downstream jobs)
  change-impact:
    name: "Impact Analysis"
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      triggered_gates: ${{ steps.impact.outputs.triggered_gates }}
      risk_score: ${{ steps.risk.outputs.risk_score }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: impact
        name: Route change impact
        run: |
          RESULT=$(bash scripts/change_impact_router.sh --json --base origin/${{ github.base_ref }})
          echo "$RESULT"
          GATES=$(echo "$RESULT" | python3 -c "import sys,json; print(json.dumps(json.load(sys.stdin).get('triggered_gates',[])))" 2>/dev/null || echo "[]")
          echo "triggered_gates=$GATES" >> "$GITHUB_OUTPUT"
      - id: risk
        name: Calculate risk score
        run: |
          RESULT=$(bash scripts/risk_scorer.sh --json --base origin/${{ github.base_ref }})
          echo "$RESULT"
          SCORE=$(echo "$RESULT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('risk_score',0))" 2>/dev/null || echo "0")
          echo "risk_score=$SCORE" >> "$GITHUB_OUTPUT"

  # Merge readiness gate (aggregates all required checks for branch protection equivalent)
  merge-readiness:
    name: "Merge Readiness"
    runs-on: ubuntu-latest
    needs:
      - security-scan
      - lint-backend
      - lint-frontend
      - typecheck-backend
      - typecheck-frontend
      - test-backend
      - test-frontend
      - test-e2e
      - a11y-frontend
      - openapi-sync
      - guard-checks
      - skills-governance-check
      - semantic-checks
    if: github.event_name == 'pull_request'
    steps:
      - run: echo "All required checks passed"

  # Full audit (Section 12.6) - weekly scheduled + manual dispatch
  full-audit:
    name: "Full Audit (Section 12.6)"
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - run: uv sync --dev --frozen
      - name: Run full audit
        run: bash scripts/full_audit.sh --json --phase 0
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: full-audit-report
          path: evidence/full-audit-*.json
