# DIYU Agent Development Services
# Usage: docker compose up -d
services:
  postgres:
    image: pgvector/pgvector:pg16
    ports: ["25432:5432"]
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-diyu}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-diyu_dev}
      POSTGRES_DB: diyu
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes: ["pgdata:/var/lib/postgresql/data"]
    read_only: true
    tmpfs:
      - /tmp
      - /run/postgresql
    security_opt:
      - no-new-privileges:true

  redis:
    image: redis:7-alpine
    ports: ["6380:6379"]
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true

  qdrant:
    image: qdrant/qdrant:v1.12.6
    ports: ["6333:6333", "6334:6334"]
    volumes: ["qdrant_data:/qdrant/storage"]
    security_opt:
      - no-new-privileges:true

  neo4j:
    image: neo4j:5-community
    ports: ["7474:7474", "7687:7687"]
    environment:
      NEO4J_AUTH: ${NEO4J_AUTH:-neo4j/diyu_dev}
    volumes: ["neo4j_data:/data"]
    security_opt:
      - no-new-privileges:true

  minio:
    image: minio/minio:latest
    ports: ["9000:9000", "9001:9001"]
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-diyu}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-diyu_dev_minio}
    volumes: ["minio_data:/data"]
    read_only: true
    tmpfs:
      - /tmp
    security_opt:
      - no-new-privileges:true

  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: celery -A src.infra.tasks.broker worker --loglevel=info
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://diyu:diyu_dev@postgres:5432/diyu
      REDIS_URL: redis://redis:6379/0
      STORAGE_BASE_URL: http://minio:9000
    depends_on:
      - postgres
      - redis
    security_opt:
      - no-new-privileges:true

  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports: ["8000:8000"]
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://diyu:diyu_dev@postgres:5432/diyu
      REDIS_URL: redis://redis:6379/0
      STORAGE_BASE_URL: http://minio:9000
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_AUTH: neo4j/diyu_dev
      QDRANT_URL: http://qdrant:6333
      KNOWLEDGE_STORE_MODE: optional
    depends_on:
      - postgres
      - redis
      - minio
      - neo4j
      - qdrant
    security_opt:
      - no-new-privileges:true

volumes:
  pgdata:
  qdrant_data:
  neo4j_data:
  minio_data:
