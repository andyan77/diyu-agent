# 治理规范 v1.2 附录 A（Vibe Coding 落盘执行手册）

> version: v1.2-baseline-r1
> date: 2026-02-14
> status: Executable Appendix
> parent: `reviews/治理规范.v1.2-正文.md`
> changelog: v1.2 adds Section 9-10 (Milestone Toolchain, Evidence Workflow)

## 0. 使用方式

1. 先读正文，明确约束边界。
2. 按本附录顺序执行，不跳步。
3. 每完成一个阶段，运行对应 `verify-phase-*`。

## 1. Phase 0 最小可执行清单（文件级）

以下条目是“可落盘构建”的最小集合，全部存在且通过基础检查后，才算 Phase 0 完成。

### 1.1 基础工程文件

1. `pyproject.toml`
2. `uv.lock`
3. `Makefile`
4. `.env.example`
5. `.gitignore`

### 1.2 后端骨架

1. `src/ports/*.py`（至少 Memory/Knowledge/LLM/ObjectStorage 契约）
2. `src/shared/types/`
3. `tests/unit/`
4. `tests/isolation/smoke/`
5. `migrations/`

### 1.3 前端骨架

1. `frontend/apps/web/`
2. `frontend/apps/admin/`
3. `frontend/packages/ui/`
4. `frontend/packages/api-client/`
5. `frontend/packages/shared/`
6. `frontend/pnpm-workspace.yaml`
7. `frontend/turbo.json`
8. `frontend/package.json`

### 1.4 治理与交付骨架

1. `.github/workflows/ci.yml`
2. `scripts/check_layer_deps.sh`
3. `scripts/check_port_compat.sh`
4. `scripts/check_migration.sh`
5. `scripts/change_impact_router.sh`
6. `delivery/manifest.yaml`
7. `delivery/milestone-matrix.schema.yaml`
8. `delivery/preflight.sh`

## 2. AI 约束注入（Guard from shift-left）

新增并固定以下目录：

1. `.claude/skills/` (迁移自 `.agent/workflows/patterns/`, ADR-053)
2. `.claude/skills/` (迁移自 `.agent/workflows/guards/`, ADR-053)
3. `.claude/skills/` (迁移自 `.agent/workflows/workflows/`, ADR-053)

AI 生成代码时，至少注入：

1. 对应层 `patterns/*.md`
2. 对应流程 `workflows/*.md`
3. 触发的 guard 规则摘要

强制规则：PR 若涉及新模块但缺少对应 pattern/workflow 引用，直接标记 `needs-guard-context`。

## 3. 脚手架命令与最小输出定义

### 3.1 基线命令

```bash
make scaffold-api endpoint=get_recommendations module=brain
make scaffold-migration name=add_epistemic_type type=ddl
make scaffold-skill name=merchandising
make scaffold-test-isolation target=memory_items
make scaffold-frontend-page app=web route=chat
make scaffold-frontend-contract name=org-context
```

### 3.2 最小输出定义（Phase 0 前置）

`scaffold-api` 最少生成：

1. `src/gateway/api/<module>/<endpoint>.py`
2. `tests/unit/gateway/api/test_<endpoint>.py`
3. `tests/integration/gateway/test_<endpoint>_integration.py`
4. `docs/api/<module>-<endpoint>.md`（或 OpenAPI 更新记录）

`scaffold-migration` 最少生成：

1. `migrations/versions/<ts>_adr<id>_<name>.py`
2. `tests/integration/migration/test_<name>_upgrade_downgrade.py`
3. `docs/adr/ADR-<id>-<name>.md`（若新增 ADR）

`scaffold-skill` 最少生成：

1. `src/skill/<name>/__init__.py`
2. `src/skill/<name>/protocol.py`
3. `src/skill/<name>/service.py`
4. `tests/unit/skill/test_<name>_skill.py`

`scaffold-test-isolation` 最少生成：

1. `tests/isolation/test_<target>_isolation.py`
2. `tests/isolation/smoke/test_<target>_smoke.py`

`scaffold-frontend-page` 最少生成：

1. `frontend/apps/<app>/app/(main)/<route>/page.tsx`
2. `frontend/apps/<app>/app/(main)/<route>/loading.tsx`
3. `frontend/apps/<app>/__tests__/e2e/<route>.spec.ts`
4. `frontend/apps/<app>/__tests__/unit/<route>.test.tsx`

`scaffold-frontend-contract` 最少生成：

1. `frontend/packages/api-client/src/types/<name>.ts`
2. `frontend/packages/api-client/src/hooks/use-<name>.ts`
3. `frontend/packages/shared/src/<name>.schema.ts`
4. `frontend/packages/api-client/__tests__/contract/<name>.contract.test.ts`

### 3.3 前端脚手架安全桩（强制）

前端脚手架生成结果必须包含：

1. `AuthProvider` 注入点（页面或布局层），未登录自动跳转。
2. `OrgContext` 读取与传递（请求头或 runtime context）。
3. `PermissionGate` 占位检查（无权限返回 403 页面组件）。
4. API 调用统一走 `packages/api-client`，禁止页面直接拼接 fetch URL。
5. 安全日志埋点占位（至少事件名、org_id、trace_id）。

## 4. CI 人话化输出模板（Guard UX）

Guard 输出必须包含 5 段：`问题`、`位置`、`影响`、`怎么修`、`参考文档`。

示例：

```text
[BLOCKER] 层间依赖违规
问题: Brain 层不允许直接依赖 Gateway 层
位置: src/brain/engine/conversation.py:3
影响: 破坏分层边界，后续会导致循环依赖与测试困难
怎么修: 把 Gateway 依赖改为通过 src/ports/ 注入
参考文档: .claude/skills/ (迁移自 .agent/workflows/patterns/, ADR-053)
```

```text
[BLOCKER] 前后端契约漂移
问题: OpenAPI 已变更，但前端 types 未同步
位置: frontend/packages/api-client/src/types/
影响: 运行期字段不匹配，可能导致页面白屏
怎么修: 执行 `pnpm openapi:generate` 后提交变更
参考文档: frontend/08-quality-engineering.md
```

## 5. 阶段验收命令（Checkpoint）

### 5.1 Phase 0

```bash
make verify-phase-0
```

必须输出并校验：

1. 工具链配置存在且可运行
2. 后端基础测试目录存在
3. 前端 Monorepo 基础文件存在
4. 4 个 Guard 脚本可执行
5. CI 文件存在并含硬门禁任务
6. `delivery/manifest.yaml` 与 `milestone-matrix.schema.yaml` 存在

### 5.2 Phase 1

```bash
make verify-phase-1
```

必须输出并校验：

1. organizations/users/org_members 迁移存在
2. OrgContext 中间件链路存在
3. RLS 策略存在
4. `tests/isolation` 核心用例存在并通过
5. 审计最小闭环存在（如 `audit_events`）

### 5.3 Phase 2

```bash
make verify-phase-2
```

必须输出并校验：

1. API/WS -> Brain -> Memory Core 闭环用例通过
2. `LLMCallPort` 契约测试通过
3. Memory Core CRUD + Evolution 最小用例通过
4. 对话场景端到端 smoke（含前端）通过

### 5.4 Phase 3

```bash
make verify-phase-3
```

必须输出并校验：

1. Knowledge Write API（Neo4j + Qdrant）链路测试通过
2. 至少 1 个 Skill 端到端可触发并有回执
3. `delivery/manifest.yaml` 的 TBD 核心项开始回填
4. 前后端知识相关契约测试通过

### 5.5 Phase 4

```bash
make verify-phase-4
```

必须输出并校验：

1. SLI/SLO 指标与告警规则存在
2. 备份恢复演练记录存在且通过
3. 升级回滚演练记录存在且通过
4. 故障注入测试（关键路径）通过

### 5.6 Phase 5

```bash
make verify-phase-5
```

必须输出并校验：

1. Guard 自动阻断策略已启用
2. 三 SSOT 自动一致性检查已启用
3. Exception Register 有效期自动审计在运行
4. 月度架构偏差审计模板可产出报告

## 6. 红线规则与后果说明（给新手的“为什么”）

### 6.1 RLS 隔离测试必须 PASS

如果跳过，租户 A 可能读到租户 B 数据，属于数据泄露事故，不是普通 bug。

### 6.2 禁止硬编码密钥

如果硬编码泄露，攻击者可直接接管数据库或对象存储，且无法快速轮换止损。

### 6.3 禁止绕过 Port 直接跨层调用

如果直接跨层，接口变更会引发连锁崩溃，测试和替换成本指数上升。

### 6.4 Migration 禁止一步破坏

如果直接删列/改类型，线上回滚可能失败，导致业务中断和数据不可逆损坏。

### 6.5 禁止直接调用 LLM SDK（绕过统一网关）

如果绕过网关，计费与审计会失真，供应商切换成本会急剧上升。

### 6.6 发版前禁止 SSOT 漂移

如果 `delivery/manifest.yaml` 与 deploy 实际不一致，回滚与故障定位会失效。

## 7. 新手执行顺序（严格）

1. 创建 Phase 0 文件骨架
2. 接入最小硬门禁 CI
3. 建立脚手架命令（允许空业务逻辑）
4. 接入 `verify-phase-0`
5. 进入 Phase 1 安全底座建设
6. 接入 `verify-phase-1`
7. 按 Phase 2-5 逐段补强与验收

## 8. 迭代入口（下轮讨论）

1. 为每个 `verify-phase-*` 产出机器可读 JSON 报告。 -- 已实现 (v1.2)
2. 将脚手架从 Make 目标升级为独立 CLI（含参数校验）。
3. 把 Guard 输出结构化并接入 PR Inline 注释。

## 9. Milestone Toolchain Quick Reference (v1.2)

### 9.1 日常操作

```bash
# 查看当前里程碑覆盖概况
python3 scripts/milestone_aggregator.py

# JSON 输出（CI 用）
python3 scripts/milestone_aggregator.py --json

# 检查任务卡溯源覆盖率
python3 scripts/task_card_traceability_check.py

# 按 Phase 过滤
python3 scripts/task_card_traceability_check.py --phase 0

# 检查 E2E AC 命令质量
bash scripts/check_acceptance_commands.sh

# 模拟 FW0-8 已合并（测试用）
FW08_MERGED=true bash scripts/check_acceptance_commands.sh
```

### 9.2 新增里程碑流程

1. 在 `docs/governance/milestone-matrix-*.md` 对应 Phase 添加行
2. 在 `delivery/milestone-matrix.yaml` 对应 phase 的 `milestones[]` 添加条目
3. 运行 `python3 scripts/milestone_aggregator.py` 确认计数正确
4. 在 `docs/task-cards/` 创建对应 task card，包含 `> 矩阵条目: <ID>`
5. 运行 `python3 scripts/task_card_traceability_check.py` 确认溯源

### 9.3 新增 ADR 流程

```bash
make scaffold-adr TITLE="my decision title"
# -> 自动创建 docs/adr/ADR-NNN-my-decision-title.md
```

### 9.4 部署前检查

```bash
# 人读模式
bash delivery/preflight.sh

# JSON 模式（CI / 自动化）
bash delivery/preflight.sh --json
```

## 10. Evidence Workflow (v1.2)

### 10.1 本地开发

```bash
# Phase gate 验证并归档证据
mkdir -p evidence/phase-0
python3 scripts/verify_phase.py --current --json > evidence/phase-0/gate.json

# 里程碑报告
mkdir -p evidence
python3 scripts/milestone_aggregator.py --json > evidence/milestone-report.json

# 溯源报告
python3 scripts/task_card_traceability_check.py --json > evidence/traceability.json
```

### 10.2 CI 自动化

CI 中证据路径由 `EVIDENCE_DIR` 环境变量统一管理：

```
evidence/<commit-sha>/schema-check.json
evidence/<commit-sha>/card-count.json
evidence/<commit-sha>/phase-gate.json
evidence/<commit-sha>/traceability-check.json
evidence/<commit-sha>/milestone-report.json
evidence/<commit-sha>/test-results.xml
```

所有证据文件均通过 `actions/upload-artifact@v4` 上传，保留 90 天。

### 10.3 发版证据归档

发版时将关键证据永久归档：

```bash
# 将当前 Phase 证据复制到发版目录
cp evidence/phase-N/gate.json evidence/release/vX.Y.Z-phase-N-gate.json
# 提交到仓库
git add evidence/release/ && git commit -m "docs: archive release vX.Y.Z evidence"
```
