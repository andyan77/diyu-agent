# 笛语 Agent 治理规范 v1.2（正文基线）

> version: v1.2-baseline-r1
> date: 2026-02-14
> status: Baseline for iteration
> changelog: v1.2 adds Section 18-22 (Milestone Acceptance, Evidence Architecture, Traceability, Runbook, Toolchain)
> scope: DIYU Agent 全栈研发治理（Backend + Frontend + Delivery）

## 0. 文档边界

本次 v1.1 基线将治理规范拆分为两份：

1. 正文（本文件）：定义规则、边界、门禁、职责。
2. 执行附录：`reviews/治理规范.v1.1-Vibe执行附录.md`，提供新手可直接执行的脚手架、检查命令、CI 报错修复指引。

历史收敛稿保留在 `reviews/治理规范.md`，后续新增规则以本基线为准。

## 1. 三 SSOT 治理体系

### 1.1 SSOT 定义

1. 决策 SSOT：`docs/architecture/*.md` + `docs/adr/*.md`
2. 运行契约 SSOT：`src/ports/` + `migrations/` + OpenAPI spec
3. 交付 SSOT：`delivery/manifest.yaml`

### 1.2 一致性原则

1. 先改文档，再改代码。
2. `src/ports/`、`migrations/`、OpenAPI 任一变更必须同步更新契约文档。
3. `deploy/*` 不允许手工漂移，必须由 `delivery/manifest.yaml` 生成或严格对齐。

## 2. 目录与依赖铁律

### 2.1 目标目录（代码仓落盘时）

最低应具备：`docs/`、`src/`、`tests/`、`migrations/`、`scripts/`、`delivery/`、`deploy/`、`.github/`、`.claude/skills/`。

### 2.2 后端层级依赖

1. 依赖单向：`brain -> knowledge -> skill -> tool`。
2. 跨层调用只能通过 `src/ports/` 契约。
3. 禁止下层反向 import 上层。

### 2.3 前端包边界

依据 `frontend/README.md` 与 FE-01/07/08：

1. 前端 Monorepo 固定为 `Turborepo + pnpm`。
2. `packages/api-client` 可以依赖 `packages/shared`，不能依赖 `packages/ui`。
3. `packages/ui` 不得依赖任何 app 目录代码。
4. `apps/web`、`apps/admin` 仅通过 `packages/api-client` 消费后端接口。
5. OpenAPI 类型生成结果是前后端契约入口，不允许手写漂移。

## 3. 技术栈固定清单

| 层面 | 选型 | 版本锁定策略 |
|---|---|---|
| Backend 语言 | Python | 3.12+ |
| Backend Web | FastAPI + Uvicorn | Major 锁定 |
| ORM / Migration | SQLAlchemy 2.x + Alembic | Major 锁定 |
| DB | PostgreSQL 16+ | 镜像版本锁定 |
| Graph | Neo4j 5.x | 镜像版本锁定 |
| Vector | Qdrant 1.x | 镜像版本锁定 |
| Cache | Redis 7+ | 镜像版本锁定 |
| Async | Celery + Redis Broker | Major 锁定 |
| LLM SDK | LiteLLM | Minor 锁定 |
| Python 依赖管理 | uv | 锁定 `uv.lock` |
| Frontend 运行时 | Node.js | 22 LTS |
| Frontend 框架 | Next.js + TypeScript strict | Major 锁定 |
| Frontend Monorepo | Turborepo + pnpm | `pnpm-lock.yaml` 锁定 |
| Frontend 测试 | Vitest + Playwright + RTL | 跟随稳定版本 |
| 代码质量 | ruff + mypy / ESLint + tsc | 配置锁定 |

规则：非清单内技术需先补 ADR，再引入代码。

## 4. 分支、版本与紧急通道

### 4.1 分支策略

1. Trunk-based，`main` 为唯一长期分支。
2. 短分支生命周期不超过 3 天。
3. 合并默认 Squash。

### 4.2 提交规范

`<type>(<scope>): <description>`

`type`：`feat|fix|refactor|test|docs|chore|perf|security`

`scope` 至少覆盖：`brain|knowledge|skill|tool|gateway|infra|ports|shared|migration|delivery|frontend`。

### 4.3 版本与 N-1 补丁策略

1. 采用 SemVer。
2. 发布分支：`release/x.y`。
3. 安全补丁执行 N-1 策略：当前 minor 与上一个 minor 维护补丁窗口。
4. 补丁窗口与停止维护时间必须写入 release note。

### 4.4 紧急通道（Hotfix）

1. 线上故障走 `hotfix/*` 分支。
2. PR 必须绑定 Incident ID。
3. 合并后 24 小时内补 ADR。
4. 逾期未补 ADR，阻断后续 release。

## 5. CI 四层门禁体系

> 核心原则：CI 只阻断"本次变更相关风险"，全量回归放在阶段/发版门禁。
> 治理对象：当前任务卡 + 当前变更影响面，非整个系统。

### 5.1 PR 硬门禁（每次都跑）

每个 PR 无条件执行，目标 < 3 分钟完成：

| # | 检查项 | 命令 | 失败行为 |
|---|--------|------|---------|
| H-1 | 后端 lint + format | `ruff check && ruff format --check` | PR 阻断 |
| H-2 | 后端类型检查 | `mypy --strict` (仅变更文件所在包) | PR 阻断 |
| H-3 | 后端单元测试 | `pytest tests/unit/ -k <变更层>` | PR 阻断 |
| H-4 | 密钥扫描 + SAST | secret scanning + semgrep | PR 阻断 |
| H-5 | 依赖漏洞扫描 | `uv audit` / `pnpm audit` (仅变更侧) | PR 阻断 |

规则：H-3 仅跑变更层的单元测试（如改 `src/brain/` 只跑 `tests/unit/brain/`），不跑全量。

### 5.2 影响门禁（按变更路径触发）

由 `scripts/change_impact_router.sh` 分析 `git diff --name-only` 决定触发哪些检查：

| 变更路径 | 触发检查 | 命令 | 激活 Phase |
|----------|---------|------|-----------|
| `src/ports/` | Port 契约兼容 | `scripts/check_port_compat.sh` | Phase 0+ |
| `src/` (非 ports) | 层间依赖检查 | `scripts/check_layer_deps.sh` | Phase 0+ |
| `migrations/` | 迁移安全检查 | `scripts/check_migration.sh --dry-run` | Phase 1+ |
| `src/infra/org/` 或 RLS 相关 | 隔离 smoke | `pytest tests/isolation/smoke/` | Phase 1+ |
| `frontend/` | 前端 lint + 类型 | `pnpm lint && pnpm typecheck` | Phase 0+ |
| `frontend/` | 前端单元测试 | `pnpm test --filter=unit` | Phase 0+ |
| OpenAPI spec 变更 | 类型同步检查 | `pnpm openapi:generate && git diff --exit-code` | Phase 2+ |
| `frontend/packages/api-client/` | 契约测试 | 关键契约测试 (Auth/OrgContext/WS) | Phase 2+ |

规则：
1. 若 PR 只改 `docs/` 或 `.md` 文件，不触发任何影响门禁。
2. 路由脚本同时输出需要的 reviewer（路由人）和需要的 CI job（路由机器）。
3. "激活 Phase"列表示该检查在对应 Phase 才开始强制执行，之前跳过。

### 5.3 阶段门禁（Phase 结束时）

Phase 交付验收，手动触发或 milestone 关闭时自动触发：

```bash
make verify-phase-N          # 人读输出
make verify-phase-N --json   # 机读 JSON 证据，归档到 evidence/
```

规则：
1. 阶段门禁检查本 Phase 全部交付物，不限于当前 PR。
2. 全部 hard criteria 通过才可进入下一 Phase。
3. JSON 证据自动归档到 `evidence/phase-N/`。

### 5.4 发版门禁（Release 阻断）

发版前必须全部通过，无例外：

| # | 检查项 | 说明 |
|---|--------|------|
| R-1 | 全链路 E2E | 前端 Playwright 关键路径 + 后端集成测试 + 全量隔离测试 |
| R-2 | 三 SSOT 一致性 | 决策/运行契约/交付 SSOT 无漂移 |
| R-3 | `delivery/manifest.yaml` | 版本更新且通过 schema 校验 |
| R-4 | 性能基线 | 不低于上一版本 |
| R-5 | 备份恢复演练 | upgrade -> downgrade -> upgrade 演练记录齐全 |
| R-6 | Docker 镜像构建与扫描 | 镜像可构建 + 漏洞扫描 PASS |
| R-7 | SBOM 生成 | 软件物料清单存在 |
| R-8 | 前端 a11y | axe-core 无 Critical/Serious |
| R-9 | 合规报告 | GDPR/PIPL 数据保留/删除统计完整（Phase 4+ 激活） |

### 5.5 门禁阶段激活表

> 门禁不从 Day 1 全部生效。当检查对象尚不存在时，该门禁处于"休眠"状态。

| 门禁 | Phase 0 | Phase 1 | Phase 2 | Phase 3 | Phase 4 | Phase 5 |
|------|---------|---------|---------|---------|---------|---------|
| **PR 硬门禁 H-1~H-5** | 全部激活 | -- | -- | -- | -- | -- |
| check_layer_deps | 激活 | -- | -- | -- | -- | -- |
| check_port_compat | 激活 | -- | -- | -- | -- | -- |
| check_migration | 休眠 | 激活 | -- | -- | -- | -- |
| isolation smoke | 休眠 | 激活 | -- | -- | -- | -- |
| 前端 lint/typecheck/test | 激活 | -- | -- | -- | -- | -- |
| OpenAPI 类型同步 | 休眠 | 休眠 | 激活 | -- | -- | -- |
| 契约测试 (Auth/Org/WS) | 休眠 | 休眠 | 激活 | -- | -- | -- |
| verify-phase-N | N=0 | N=1 | N=2 | N=3 | N=4 | N=5 |
| 发版门禁 R-1~R-8 | 休眠 | 休眠 | 休眠 | 休眠 | 全部激活 | -- |
| 合规报告 R-9 | 休眠 | 休眠 | 休眠 | 休眠 | 激活 | -- |

激活判定逻辑：`change_impact_router.sh` 读取 `delivery/milestone-matrix.yaml` 中的 `current_phase` 字段，跳过未激活的门禁。

### 5.6 门禁演化规则

触发任一条件即升级为 L1/L2/L3 分层门禁：

1. CI p95 时长 > 5 分钟
2. PR 排队 > 3 分钟
3. flake rate > 2%

升级后要求：

1. L1：增加缓存与并行优化，不增加新检查项。
2. L2：将高风险影响门禁前移为 PR 硬门禁子集。
3. L3：分层队列 + 变更分流 + 可疑 PR 全量回归。

## 6. 代码审查矩阵

| 变更类型 | Reviewer 数 | 必须角色 | SLA |
|---|---|---|---|
| 普通功能 | 1 | 同层开发者 | 1 工作日 |
| 跨层变更 | 2 | 涉及层各 1 位 | 1 工作日 |
| `[CONTRACT]` | 2 | 架构负责人 + 消费端开发者 | 2 工作日 |
| `[MIGRATION]` | 2 | 架构负责人 + 数据安全 | 2 工作日 |
| `[SECURITY]` | 2 | 安全负责人（必须） | 1 工作日 |
| `[FRONTEND-CONTRACT]` | 2 | 前端负责人 + 后端 API Owner | 1 工作日 |
| 配置/依赖/交付 | 1 | DevOps | 1 工作日 |

超时升级机制：

1. +8h：Bot 提醒 reviewer
2. +24h：升级到 backup reviewer
3. +48h：升级到 Tech Lead，标记 `review-blocked`
4. +72h：升级到项目负责人

## 7. 测试规范与覆盖率风险分层

### 7.1 覆盖率分层

| 风险层级 | 模块范围 | 覆盖率目标 | 场景要求 |
|---|---|---|---|
| Critical | RLS、隔离、RBAC、Token 计费、Migration 路径、删除管线 | >=95% | 正向/反向/边界/竞态 |
| High | Port 接口、Memory Core、知识写入、OrgContext | >=85% | 正向/反向/边界 |
| Medium | Brain 对话引擎、Resolver、Skill 调度、Context Assembler | >=70% | 正向 + 主要反向 |
| Low | 适配层、日志、工具函数、配置加载 | >=50% | 正向 |

### 7.2 测试类型与执行时机

1. 单元测试：每次 commit（硬门禁）
2. 隔离 smoke：每次 commit（硬门禁）
3. 全量隔离测试：合并后（软门禁）
4. 集成测试：合并后（软门禁）
5. Property-based 与故障注入：定时或发版前
6. 前端 E2E/a11y：合并后（软门禁），关键路径发版前强制

## 8. Migration 与契约演进

1. 采用 Expand-Migrate-Contract。
2. DDL 必须可逆；DML 可 forward-only，但必须附回滚工件（快照/脚本）。
3. Migration 元数据强制包含：`reversible_type`、`rollback_artifact`、`drill_evidence_id`。
4. Port 变更遵循 Expand-Contract，先扩展后移除。

## 9. 失败恢复基线

1. Outbox：关键事件使用 `event_outbox`，至少一次投递。
2. 幂等键：异步操作必须带 `idempotency_key`。
3. 死信：重试 5 次后进入 DLQ，触发 P0 告警。
4. 补偿：一致性失败后标记 `sync_status` 并由 Reconciliation Job 修复。
5. 迁移回滚：发版前必须有 `upgrade -> downgrade -> upgrade` 演练证据。
6. 部署回滚：至少保留 3 个历史镜像，目标回滚时长 < 5 分钟。

## 10. 数据生命周期治理

| 数据类型 | 活跃保留 | 归档策略 | 硬删除窗口 | 审计追踪 |
|---|---|---|---|---|
| conversation_events | 90 天 | 冷归档 S3 | 归档 2 年后删除 | 保留事件骨架 |
| memory_items | 永久 | 不归档 | tombstone SLA <=15 工作日 | tombstone + audit |
| audit_events | >=3 年 | 1 年后冷归档 | 不删除 | 自身即审计 |
| llm_usage_records | 6 个月 | 冷归档 | 2 年后删除 | usage 汇总 |
| content_tasks | 1 年 | 冷归档 | 3 年后删除 | audit_events |
| object_storage 媒体 | 生命周期分层 | 90 天 IA / 1 年 Glacier | 关联实体删除时级联 | media_event |

## 11. 可观测性阶梯（V1.1 增量）

1. Phase 0：统一日志格式（至少 `trace_id`、`org_id`、`request_id`）。
2. Phase 1：接入 trace 与 4 黄金信号（延迟、流量、错误、饱和度）及基础告警。
3. Phase 2：建立统一看板与关键链路追踪。
4. Phase 4：建立 SLO 与告警分级、值班升级流程。

## 12. 交付治理（Delivery SSOT）

1. `delivery/manifest.yaml` 是交付唯一真源。
2. 新增 `delivery/milestone-matrix.schema.yaml`（v1.1 必做）。
3. `deploy/*` 必须从 manifest 生成或验证无漂移。
4. Phase 0 允许 `TBD` 值，但字段与约束必须完整。

## 13. 例外治理（Exception Register）

新增 `docs/governance/exception-register.md`，每个例外必须记录：

1. `id`、`owner`、`scope`、`reason`
2. `risk_level`、`compensating_control`
3. `accept_drift_until`（到期日）
4. `approver`、`review_cycle`

红线不可例外：RLS 隔离、密钥硬编码、发版 SSOT 漂移。

## 14. Phase 0-1 落盘策略

### 14.1 Phase 0（治理最小集）

必须完成：

1. 项目骨架与工具链配置
2. 硬门禁 CI
3. Guard 脚本雏形
4. `delivery/manifest.yaml` + `milestone-matrix.schema.yaml` 骨架
5. 新手执行附录中的 `verify-phase-0` 通过

### 14.2 Phase 1（安全与租户底座）

必须完成：

1. OrgContext 全链路
2. RLS 策略基线
3. 隔离测试框架
4. 审计最小闭环
5. `verify-phase-1` 通过

## 15. 开发十诫

1. 隔离是底线：RLS 与多租户隔离测试不可跳过。
2. Port 是契约：跨层调用必须走 Port。
3. 层间单向：禁止反向依赖。
4. 先写测试：安全/隔离/完整性代码测试先行。
5. 兼容变更：Port 与 Schema 走 Expand-Contract。
6. 可观测：关键操作必须产出可追溯日志与回执。
7. 幂等优先：异步操作必须可重试且幂等。
8. 配置不硬编码：配置走 org_settings 或环境变量。
9. 三 SSOT 同步：发现漂移必须修源头。
10. 始终可部署：`main` 任一时刻可部署可回滚。

## 16. DoD（基线版）

1. PR 可自动判定并路由 `CONTRACT/MIGRATION/SECURITY/FRONTEND-CONTRACT`
2. `tests/isolation` 在 CI 稳定运行，无人工豁免
3. 所有跨层调用可追溯到 `src/ports/`
4. 前端 API 类型与 OpenAPI 同步无漂移
5. Migration 有真实回滚演练证据
6. `delivery/manifest.yaml` 与 `deploy/*` 无漂移
7. main 分支可部署、可回滚、可观测

## 18. Milestone Matrix Machine-Judgeable Acceptance (v1.2)

### 18.1 Acceptance Command 分类

里程碑矩阵的 AC（Acceptance Criteria）列使用 5 种可判定前缀：

| 前缀 | 语义 | 判定方式 |
|------|------|---------|
| `[FILE]` | 文件存在且内容符合约束 | `test -f` + 属性检查 |
| `[CMD]` | 命令执行成功（exit 0） | 直接执行 |
| `[TEST]` | 测试通过 | `pytest` / `pnpm test` |
| `[E2E]` | 端到端测试通过 | `playwright` / `pytest e2e` |
| `[METRIC]` | 指标达标 | Prometheus query / 脚本验证 |

### 18.2 质量守卫

`scripts/check_acceptance_commands.sh` 在 FW0-8 合并后强制检查所有 `[E2E]` 条目包含可执行命令（反引号包裹），而非纯文本描述。

检测机制采用双通道：
1. 环境变量 `FW08_MERGED=true`（CI 优先，稳定）
2. `git log --grep="FW0-8"` 回退（本地开发便利）

### 18.3 新增条目审查清单

新增里程碑时，AC 列必须满足：
1. 使用上述 5 种前缀之一
2. `[TEST]`/`[E2E]`/`[CMD]` 必须包含可复制粘贴执行的命令
3. `[METRIC]` 必须包含阈值（如 `P95 < 200ms`）
4. 禁止纯描述性文字作为 AC

## 19. Evidence Path Architecture (v1.2)

### 19.1 路径规范

CI 产出的证据文件统一存放于参数化路径：

```
evidence/{commit_sha}/{artifact_name}.json
```

- `commit_sha` 由 CI 环境变量 `${{ github.sha }}` 注入
- Phase gate 证据额外归档到 `evidence/phase-N/`
- 发版证据归档到 `evidence/release/`

### 19.2 CI 配置

三个 CI workflow 均使用 `EVIDENCE_DIR` 环境变量：

```yaml
env:
  EVIDENCE_DIR: evidence/${{ github.sha }}
```

所有 `mkdir -p`、`tee`、`upload-artifact` 均引用此变量，确保单一修改点。

### 19.3 保留策略

| 类型 | 保留期 | 存储 |
|------|--------|------|
| PR evidence | 90 天 | GitHub Actions artifact |
| Phase gate evidence | 永久 | Git 仓库 `evidence/phase-N/` |
| Release evidence | 永久 | Git 仓库 `evidence/release/` |

## 20. Traceability Chain (v1.2)

### 20.1 三级溯源体系

```
L2: milestone-matrix.yaml milestones[]  (270 IDs)
    |
    v
L3: docs/task-cards/**/*.md  (> 矩阵条目: <ID>)
    |
    v
L4: src/ + tests/ (actual code)
```

### 20.2 自动化检查

`scripts/task_card_traceability_check.py` 执行双向检查：

1. **正向**：YAML 中每个 milestone ID 应有至少一个 task card 引用它
2. **反向**：task card 的 `矩阵条目` 引用必须对应 YAML 中存在的 ID

CI 配置为 informational gate（`continue-on-error: true`），不阻断合并，但生成覆盖率报告。

### 20.3 覆盖率目标

| Phase | 目标覆盖率 | 备注 |
|-------|-----------|------|
| Phase 0 | >= 80% | 骨架阶段，部分条目尚未展开 task card |
| Phase 1-5 | >= 95% | 每个 milestone 必须有对应 task card |

## 21. Security Incident Runbook Reference (v1.2)

### 21.1 Runbook 位置

`delivery/commercial/runbook/` 目录包含运维和安全事件响应手册：

| 文件 | 对应里程碑 | 场景 |
|------|-----------|------|
| `common-operations.md` | D0-3 | 日常运维 |
| `data-breach-response.md` | OS5-6 | 数据泄露 |
| `key-leak-response.md` | OS5-6 | 密钥泄露 |
| `ddos-response.md` | OS5-6 | DDoS/流量异常 |
| `supply-chain-response.md` | OS5-6 | 供应链攻击 |

### 21.2 维护规则

1. 每次 P0/P1 事件 post-mortem 后更新相关 runbook
2. 每季度 review 一次全部 runbook 可执行性
3. 新增场景需先建 runbook，再处理事件（playbook-first）

## 22. Governance Toolchain Inventory (v1.2)

### 22.1 脚本清单

| 脚本 | 用途 | 输入 | 输出 | CI 集成 |
|------|------|------|------|---------|
| `scripts/doctor.py` | 开发环境诊断 | -- | JSON/human | `make doctor` |
| `scripts/verify_phase.py` | Phase gate 验证 | `--phase N` | JSON evidence | `task-card-check.yml` |
| `scripts/check_task_schema.py` | 任务卡 schema 校验 | `--mode full` | JSON violations | `task-card-check.yml` |
| `scripts/count_task_cards.py` | 任务卡统计 | `--json` | JSON census | `task-card-check.yml` |
| `scripts/milestone_aggregator.py` | 里程碑聚合统计 | `--json` | JSON report | `milestone-check.yml` |
| `scripts/task_card_traceability_check.py` | 溯源覆盖率检查 | `--json` | JSON traceability | `task-card-check.yml` |
| `scripts/check_acceptance_commands.sh` | E2E AC 质量守卫 | -- | PASS/FAIL/SKIP | `milestone-check.yml` |
| `scripts/check_layer_deps.sh` | 层间依赖检查 | -- | JSON violations | `ci.yml` |
| `scripts/check_port_compat.sh` | Port 契约兼容检查 | -- | JSON | `ci.yml` (按路径) |
| `scripts/check_migration.sh` | 迁移安全检查 | -- | JSON | `ci.yml` (按路径) |
| `scripts/check_rls.sh` | RLS 隔离检查 | -- | JSON | `ci.yml` (按路径) |
| `scripts/change_impact_router.sh` | 变更影响路由 | `--base` | JSON | `ci.yml` |
| `scripts/risk_scorer.sh` | 风险评分 | `--base` | JSON | `ci.yml` |
| `scripts/scaffold_phase0.py` | Phase 0 脚手架 | -- | 文件创建 | `task-card-check.yml` |
| `scripts/scaffold_adr.py` | ADR 创建 | `<title>` | ADR 文件 | `make scaffold-adr` |
| `scripts/audit_aggregator.py` | 审计聚合 | `.audit/` | 报告 | `make audit-report` |
| `delivery/preflight.sh` | 部署前环境检查 | `--json` | JSON/human | 手动 |

### 22.2 CI Workflow 清单

| Workflow | 触发条件 | 门禁类型 | 文件 |
|----------|---------|---------|------|
| CI | PR + push to main | Hard Gate (lint, test) | `.github/workflows/ci.yml` |
| Task Card Check | PR (task-cards/governance paths) | Hard + Informational | `.github/workflows/task-card-check.yml` |
| Milestone Check | PR (milestone paths) | Informational | `.github/workflows/milestone-check.yml` |

## 23. 关联文档

1. `reviews/治理规范.v1.2-Vibe执行附录.md`
2. `frontend/01-monorepo-infrastructure.md`
3. `frontend/07-deployment.md`
4. `frontend/08-quality-engineering.md`
5. `architecture/00-系统定位与架构总览.md`
6. `docs/governance/governance-optimization-plan.md`
7. `docs/governance/execution-plan-v1.0.md`
