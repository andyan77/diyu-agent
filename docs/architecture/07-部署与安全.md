# 部署与安全

> **所属层:** 外壳层  
> **版本:** v3.6
> **验证标准:** 三种部署模式可独立验证；安全五层防御可逐层测试；HA failover 可验证  

---

## 1. 三种部署模式

| 模式 | 适用 | 数据位置 | AI 位置 |
|------|------|---------|--------|
| SaaS | 中小品牌 | 云端（RLS 隔离） | 云端 |
| 私有 | 大品牌 | 客户机房 | 客户机房或云端 |
| 混合 | 知识敏感 | 知识本地，其他云端 | 云端 |

### 1.1 DEPLOY_MODE 形式化定义

```
环境变量 DEPLOY_MODE:
  合法值: "saas" | "private" | "hybrid"
  默认值: "saas"
  注入时机: 构建时注入，运行时不可变
  前端消费: FE-07 读取此变量决定 AuthStrategy (saas->Cookie, private/hybrid->Bearer)
  后端消费: Gateway 路由策略、数据隔离策略、知识部署拓扑
```

---

## 2. SaaS 数据隔离

| 组件 | 策略 | 安全保障 |
|------|------|---------|
| PostgreSQL (业务 + Memory Core) | RLS + ltree (org) + user_id (memory) | 数据库层面强制 |
| Neo4j | tenant_id + brand_id 属性过滤 | 应用层 Query Wrapper |
| Qdrant | tenant_id + brand_id payload 过滤 | 应用层过滤 |
| Object Storage (S3/MinIO) | bucket per tenant 或 key 前缀隔离 ({org_id}/{scope}/{uuid}.{ext}) + presigned URL TTL | 存储层 + 应用层双重保障 |

---

## 3. 私有部署

```
Docker Compose（v3.5 CP/DP 标注）:
  api          [CP+DP]  -- 统一入口，同时承载管理和对话 API
  worker       [DP]     -- 异步任务处理（Evolution Pipeline, Physical Deletion Worker）
  redis        [DP]     -- 缓存 + 实时计数 + Celery Broker
  postgres     [CP+DP]  -- 业务数据 + Memory Core + event_outbox
  neo4j        [DP]     -- Knowledge Stores 图谱
  qdrant       [DP]     -- Knowledge Stores 向量 + personal_projection
  minio        [DP]     -- 对象存储 (S3 兼容, 媒体文件 + 文档附件)
  langfuse     [CP]     -- LLM 可观测性（管理/分析用途）
  prometheus   [CP]     -- 指标采集（SLI 聚合/告警用途）
```

---

## 4. 混合模式

```
客户环境: Neo4j / Qdrant / PostgreSQL(Memory Core) / Resolver
笛语云端: API / Brain / Skill / Tool / LLM Gateway

知识不出客户环境，AI 推理在云端。
Memory Core 部署位置由客户隐私要求决定:
  +-- 默认在客户环境（推荐，保护个人记忆）
  +-- 可选在云端（需客户授权）
```

---

## 5. 数据安全与合规

> **[v3.5 新增] CP/DP SLA 目标:** CP（Control Plane: 管理/配置/观测）SLA 99.9%; DP（Data Plane: 对话/记忆/知识检索）SLA 99.95%。DP 要求更高因为直接影响用户体验。

```
+-- PostgreSQL RLS 强制隔离 + 应用层双重保障
+-- Memory Core 按 user_id + tenant_id 隔离（数据库级）
+-- Knowledge Stores 永远不读 Memory Core（隐私硬边界，架构级保证）
+-- 传输 TLS 1.2+，静态 AES-256
+-- API Key 存 Secret Manager
+-- 客户数据不用于模型训练（写入 DPA）
+-- AI 生成内容保留完整溯源链（generation_metadata）
+-- PIPL 合规: 中国境内部署，避免跨境传输
+-- 全链路 trace_id 可追溯
```

### 5.1 租户隔离五层防御

```
Layer 1: RLS（PostgreSQL 行级安全策略）
Layer 2: 应用层过滤（org_chain / tenant_id / user_id 注入）
Layer 3: Gateway 防护（认证 + OrgContext 计算）
Layer 4: 测试覆盖（隔离测试用例）
Layer 5: 审计日志（事后追溯）
```

### 5.2 Memory Core 安全特殊要求

```
+-- 个人记忆属于用户，不属于组织
+-- 用户有权删除自己的记忆（tombstone 标记）
+-- Promotion Pipeline 跨域提案必须脱敏（去除个人敏感信息）
+-- 对抗性内容检测: 跨域写入和提案必须过安全扫描
+-- 注入 fail-closed: 不确定的记忆不注入上下文
+-- 负反馈熔断: 防止正反馈毒化循环
+-- [v3.5 P2 预留] Crypto Shredding: per-user 加密密钥（Vault 管理），删除时销毁密钥
    即使物理数据残留也无法解密。与 tombstone 删除管线互补（tombstone = 软删 + 物理删，
    Crypto Shredding = 密钥销毁使数据不可读）。Phase 2 实现。
+-- 审计留存边界（v3.4 新增，见 01 Section 3.1.1 / ADR-037）:
     物理删除后保留: audit_events（含 user_id + 删除时间 + 条目数量）
     物理删除后保留: tombstones 表（状态机记录）
     物理删除后保留: memory_receipts（脱敏，仅保留统计字段）
     不保留: 记忆原始内容、对话原始内容、会话摘要原始内容
     保留期限: audit_events 和 tombstones 至少 3 年（法规最低要求）
```

### 5.3 AI Agent 安全威胁模型

> **[v3.5 新增, I1 修复]** 针对 AI Agent 特有的安全威胁，与 01/02 文档的防御措施形成交叉引用。

```
威胁 1: 记忆投毒（Memory Poisoning）
  攻击: 通过对话注入恶意记忆（如虚假偏好/误导性模式），影响后续对话质量
  防御:
  +-- Provenance 可信度分级: 声明性记忆置信度上限低于行为性记忆（见 01 Section 3.1.0.1）
  +-- Knowledge 矛盾检测: Context Assembler 冲突解决中发现 personal_context
      与 knowledge_context 矛盾时，Knowledge 优先（ADR-022）
  +-- 负反馈熔断: 用户反馈机制（见 01 Section 2.3）

威胁 2: Prompt Injection via Memory
  攻击: 通过精心构造的对话内容，使记忆引擎提取包含操纵性指令的 memory_item，
        在后续注入 context 时劫持 LLM 行为
  防御:
  +-- Sanitization 双重清洗: pattern-based + LLM-based（见 01 Section 4.1 Step 1.5）
  +-- 结构化标签: <user_memory>...</user_memory> 界定边界（见 01 Section 4.1 Step 3）
  +-- Provenance 分级: 低置信度记忆排序靠后（见 01 Section 3.1.0.1）

威胁 3: 跨租户泄露 via Promotion
  攻击: 个人记忆通过 Promotion Pipeline 进入企业知识库时，携带个人敏感信息或商业机密
  防御:
  +-- PII 脱敏: Promotion 第 3 步脱敏 + 安全扫描（见 02 Section 7.2）
  +-- 敏感信息分类标签: 商业机密禁止通过 Promotion（见 02 Section 7.2 v3.5 新增）
  +-- 审批流程: 按目标可见性路由到对应级别 admin 审批

威胁 4: 媒体文件攻击 [v3.6 新增]
  攻击 4a: 恶意文件上传（伪装 MIME type、嵌入恶意代码、EXIF 隐私泄露）
  防御:
  +-- 三步上传协议 Stage 1 同步预检: magic bytes 校验 + EXIF 清洗 + ClamAV 扫描
      （见 05-Gateway层.md Section 8.2）
  +-- S3 原生 x-amz-checksum-sha256 完整性校验 (ADR-052)
  +-- security_status 状态机 6 态管控 (ADR-051)

  攻击 4b: 媒体文件注入 (通过 OCR/ASR 输出注入恶意指令)
  防御:
  +-- OCR/ASR 文本输出在注入 Context 前必须通过 Step 1.5 Sanitization
      （见 01-对话Agent层-Brain.md Section 4.1 Step 1.5 v3.6 扩展）
  +-- security_status 三层拦截 (Gateway/Brain/LLMCallPort)
      （见 05-Gateway层.md Section 8.3）

  攻击 4c: NSFW/违规内容上传
  防御:
  +-- Stage 2 异步深度扫描: NSFW 检测 + PII 检测
  +-- quarantined 状态 -> 管理员审核
  +-- org_settings.media_config.nsfw_sensitivity 可配置灵敏度
      （见 06-基础设施层.md Section 1.5）
```

---

## 6. 高可用 (HA)

> **[v3.2 新增]** Memory Core down = 系统 UNAVAILABLE（见 00-总览 Section 11 降级矩阵）。作为硬依赖组件，Memory Core 的底层 PostgreSQL 必须具备高可用能力。此为部署拓扑决策，Brain 通过 MemoryCorePort 抽象，不感知底层 HA 方案。

### 6.1 Memory Core (PostgreSQL) HA

```
方案: PostgreSQL Streaming Replication + 自动 Failover

部署拓扑:
+-- Primary: 承载全部读写
+-- Standby: 同步/异步复制（WAL shipping）
+-- Failover 管理: Patroni（推荐）或云厂商托管 HA

目标 SLA:
+-- RPO (Recovery Point Objective): < 1s（同步复制模式）
+-- RTO (Recovery Time Objective): < 30s（自动 failover）

应用层适配:
+-- MemoryCorePort 的 PG 适配器通过连接池连接 Primary endpoint
+-- Failover 时连接池自动重连到 promoted Standby
+-- Brain 层无感知（Port 接口不变）

Read Replica 配置建议（v3.5 新增）:
+-- 分析查询走 Standby: SLI 聚合（staleness/conflict 统计）、报表查询
+-- 主库只承载事务写入: memory_items CRUD、tombstones、event_outbox
+-- 避免 OLTP/OLAP 争抢主库资源

SaaS 模式:
+-- 云厂商托管 PostgreSQL HA（如 RDS Multi-AZ）
+-- 自动备份 + 跨 AZ 复制

私有部署模式:
+-- Patroni + etcd 集群管理
+-- 客户运维团队按标准流程部署
```

### 6.2 Knowledge Stores HA

```
Neo4j:
+-- Causal Clustering（读写分离 + 自动 failover）
+-- 软依赖: 故障时系统降级运行，不停服

Qdrant:
+-- 集群模式 (Raft consensus)
+-- 副本分片 (replication_factor >= 2)
+-- 软依赖: 故障时系统降级运行，不停服

Redis:
+-- Sentinel 模式（自动 failover）
+-- 用于缓存和实时计数，短暂故障影响有限

Object Storage (S3/MinIO) [v3.6 新增]:
+-- SaaS 模式: AWS S3 (跨 AZ 冗余, 11 个 9 持久性)
+-- 私有部署: MinIO Erasure Coding (最少 4 节点, 允许丢失 n/2 节点)
+-- 备份策略: S3 Versioning + Lifecycle 冷归档
+-- 软依赖: Object Storage 故障时多模态功能降级，文本对话不受影响
+-- 降级行为: media_id 对应的 URL 请求返回 503，前端展示 text_fallback
```

---

> **验证方式:** 1) SaaS 隔离: 不同租户的请求只能访问本租户数据; 2) Memory 隔离: 不同用户不能看到彼此记忆; 3) 隐私硬边界: Knowledge Stores 无法读取 Memory Core 的代码路径验证; 4) 私有部署: Docker Compose 一键启动可运行; 5) HA: Primary PG 故障后 Standby 自动接管，Brain 层测试仍 PASS; 6) [v3.6] Object Storage 隔离: 不同租户的 presigned URL 不可访问其他租户文件; 7) [v3.6] MinIO Docker Compose: 私有部署包含 MinIO 服务且可正常上传/下载; 8) [v3.6] 媒体安全: 恶意文件上传被 Stage 1 同步预检拦截; 9) [v3.6] Object Storage HA: MinIO 单节点故障后系统降级但文本对话不受影响。
