# 附录

> **版本:** v3.6

---

## 附录 A: 术语表

| 术语 | 定义 |
|------|------|
| **Brain** | 对话 Agent 内核。具备对话、理解、记忆、进化、角色适配五大固有能力。不依赖任何 Skill 或 Knowledge Stores 即可运行 |
| **SSOT-A: Memory Core** | 个人记忆域的唯一数据真值源。管对话事件流、个人偏好/行为模式、会话摘要。硬依赖，挂了停服 |
| **SSOT-B: Knowledge Stores** | 企业知识资产域的唯一数据真值源。Neo4j（骨架）+ Qdrant（血肉）+ FK 联动。软依赖，拔了降级运行 |
| **FK 联动** | 图谱节点的 graph_node_id 与向量条目 payload 中的 graph_node_id 互相引用，实现精确查询与语义检索的互补 |
| **Context Assembler** | Brain 内部组件，唯一同时读取 Memory Core 和 Knowledge Stores 的组件。实现隐私硬边界 |
| **隐私硬边界** | Knowledge Stores 永远不直接读 Memory Core。这是架构级保证，不是配置 |
| **Promotion Pipeline** | 跨 SSOT 的提案入库管线。从 Memory Core 候选 -> 脱敏/扫描 -> 审批 -> 写入 Knowledge Stores |
| **实体类型注册** | Skill 向 Knowledge Stores 注册新的实体类型，无需修改核心代码即可扩展知识模型 |
| **KnowledgeBundle** | Resolver 的输出，包含图谱实体、关系、语义内容，已完成 FK 联动和 org_chain 过滤 |
| **Experiment Engine** | 全局基础设施层的实验引擎。管理 5 个维度（Brain 路由/Skill 执行/Knowledge 检索/Prompt 版本/模型选择）的受控实验，按租户级分流，遵循"默认不做、先过离线、强制止损"原则 |
| **实验卡** | 每次实验的最小完备描述，包含 7 项: 假设、主指标、护栏指标、流量比例、影响组织范围、停止条件、回滚条件 |
| **Skill** | 可插拔的领域能力积木。拥有自己的业务逻辑、prompt、实体类型定义。不拥有自己的数据库 |
| **Tool** | 原子级可执行能力（LLM调用、搜索、抓取等），由 Skill 调用 |
| **Diyu Resolver** | Knowledge Stores 的统一查询入口，按 Profile 执行图谱查询、向量检索、FK 联动 |
| **Profile** | Resolver 的查询配置，定义查什么、怎么查、FK 策略、组装规则 |
| **记忆引擎** | Brain 的固有能力之一。从对话中提取观察，经分析和进化，写入 Memory Core |
| **进化提案** | 记忆引擎识别到的知识模式，影响范围超出 personal scope 时，通过 Promotion Pipeline 提交审批 |
| **内核自足** | 拔掉所有 Skill、Knowledge Stores 和非必要 Tool，系统仍可完整对话、记忆 |
| **乐高式可插拔** | Skill 注册即用，拔掉不影响内核，Knowledge Stores 中的数据保留 |
| **三条写入管线** | Memory 自动写（SSOT-A）、Knowledge 受控写（SSOT-B）、Promotion 跨域审批写（A->B），各走各的 |
| **FK Registry（两库字典）** | Neo4j graph_node_id 与 Qdrant point_id 的映射注册表，用于跨库一致性对账 |
| **Reconciliation Job** | 定期对比 FK Registry 与两库实际数据的自愈任务，修复不一致状态 |
| **Transactional Outbox** | PG 事务内写入 event_outbox 表，由 Poller 异步投递，保证关键事件至少一次送达 |
| **LAW（法律级约束）** | 系统不变量，代码强制执行，任何角色的 UI/API 操作均无法绕过。如: org_tier 固定 5 层、隐私硬边界、RLS 策略等。见 06 Section 1.6 |
| **RULE（规则级约束）** | 管理员可通过 Admin Console 配置的运行时参数。如: content_policy、review_flow、default_model 等。见 06 Section 1.6 |
| **BRIDGE（桥接机制）** | is_locked 标志——对当前组织是 RULE（可配置），对子组织产生 LAW 效果（不可覆盖）。见 06 Section 1.6 |
| **Skill Router** | Brain 内部的 Skill 匹配机制。遍历 Skill Registry 中的 capabilities 标签，调用 can_handle() 计算置信度，选择最佳匹配。文档中简称 "Router" |
| **LLMCallPort / LLMCall Tool** | LLMCallPort 是 Port 接口（Day 1 Port 之一，见 00 Section 12.3），LLMCall Tool 是其 Tool 层实现，底层委托 LLM Gateway 完成实际模型调用。Brain 通过 LLMCallPort 抽象调用 LLM，Skill 通过 LLMCall Tool 调用 LLM |
| **pgvector** | PostgreSQL 向量检索扩展。Memory Core 默认启用，为个人记忆提供语义检索能力（同库同事务）。与 Qdrant enterprise（Knowledge Stores）和 Qdrant personal_projection（Day-2 增强）定位不同。见 01 Section 3.2.1 / ADR-042 |
| **Hybrid Retrieval** | 双路混合检索策略。FTS（全文检索）+ pgvector（向量检索）同时查询，结果通过 RRF（Reciprocal Rank Fusion, k=60）融合排序。见 01 Section 4.1 Step 1 |
| **confidence_effective** | 检索排序时的有效置信度。公式: confidence * decay_factor(days_since_last_validated)。存储值不变，仅影响排序行为。与 invalid_at 硬淘汰互补。见 01 Section 2.3.2.4 |
| **injection_receipt v3.1** | memory_receipts details 的 CE 后处理闭环扩展。新增 utilized(LLM 是否使用该记忆)、utilization_signal(利用信号来源)、user_feedback_signal(隐式反馈信号)三个字段。Expand-compatible，与 v3 共存。见 01 Section 4.1.1 / 06 Section 9 |
| **Query Rewriting** | Context Assembler 的检索预处理步骤。低成本 LLM 将用户原始查询改写为 1-3 条检索友好的查询语句，提升召回率。见 01 Section 4.1 Step 0.5 |
| **Multi-Signal Reranking** | 检索后多信号重排序。final_score = semantic * recency_boost * confidence_effective * provenance_weight * frequency_factor。五个因子各自独立可调。见 01 Section 4.1 Step 1.3 |
| **ContentBlock** | [v3.6] 统一多模态内容模型 Schema v1.1。type 枚举 text/image/audio/video/document，外部统一 media_id，存储层内部 ObjectRef。text_fallback 必填。完整字段级契约见附录 G.2.1 (ADR-043) |
| **ObjectStoragePort** | [v3.6] 对象存储抽象接口 (v3.6 Extension Port)。封装 S3/MinIO/OSS 操作原语，不含业务逻辑。见 00 Section 12.3.1 |
| **ObjectRef** | [v3.6] 存储层内部结构 (bucket/key/checksum/size/mime)，禁止跨层传递。仅在 ObjectStoragePort 实现、安全管线 Worker、LLMCallPort 实现内流转 |
| **security_status** | [v3.6] 媒体安全状态机 (ADR-051)。6 态: pending/scanning/safe/rejected/quarantined/expired。三层拦截: Gateway/Brain/LLMCallPort |
| **media_event** | [v3.6] 统一事件模型扩展。7 个子类型覆盖媒体全生命周期 (upload/scan/reject/delete)。见 06 Section 6.3 |

---

## 附录 B: 架构决策记录 (ADR)

| ADR | 决策 | 版本 |
|-----|------|------|
| ADR-001 | Prompt 模板归属各 Skill，公共能力抽为 shared/prompt_toolkit | v2.0 |
| ADR-002 | Knowledge 层用 Profile 实现多场景适配 | v2.0 |
| ~~ADR-003~~ | ~~Knowledge 只有一个写入入口（Brain 记忆引擎）~~ **v3.1 废弃，见 ADR-017** | ~~v2.0~~ |
| ADR-004 | 组织模型使用树状结构 | v2.0 |
| ADR-005 | 知识继承向下自动，沉淀向上需确认 | v2.0 |
| ADR-006 | PostgreSQL RLS + ltree | v2.1 |
| ADR-007 | RBAC + Org Scope，不引入外部 ReBAC | v2.1 |
| ADR-008 | LiteLLM SDK 集成，不独立部署代理 | v2.1 |
| ADR-009 | 记忆系统自建，借鉴 Zep 时序设计 | v2.1 |
| ADR-010 | 自定义 ToolProtocol，预留 MCP 适配器 | v2.1 |
| ADR-011 | Langfuse 自托管做 LLM 观测 | v2.1 |
| ADR-012 | 内容类型通过注册机制扩展 | v2.1 |
| ADR-013 | 对话 Agent 是系统内核，不是 Skill。Brain 具备五大固有能力 | v3.0 |
| ADR-014 | Knowledge 基座是统一知识存储，图谱与向量通过 FK 联动 | v3.0 |
| ADR-015 | Skill 向 Knowledge 基座注册实体类型来扩展知识模型，不自建数据存储 | v3.0 |
| ADR-016 | 内核自足性要求: 拔掉所有 Skill，系统仍可完整对话、记忆、进化 | v3.0 |
| **ADR-017** | **双 SSOT 平行架构: Memory Core(SSOT-A, 硬依赖) 与 Knowledge Stores(SSOT-B, 软依赖) 平行不从属。废弃 ADR-003 的"唯一写入入口"设计，改为三条写入管线分离** | **v3.1** |
| **ADR-018** | **隐私硬边界: Knowledge Stores 永远不直接读 Memory Core。Context Assembler 是唯一同时读取两者的组件** | **v3.1** |
| **ADR-019** | **Memory Core scope 只有 session/personal; Knowledge Stores scope 只有 store/region/brand/global。两套 scope 不混装** | **v3.1** |
| **ADR-020** | **Neo4j 版本治理选方案 A 起步（节点带 version/valid_from/valid_to/is_active），方案 B(ChangeSet)后期叠加** | **v3.1** |
| **ADR-021** | **Qdrant enterprise 条目入库时原始文本必须存入 payload 或有可寻址的原始文档引用，保证条目可追溯性** | **v3.1** |
| **ADR-022** | **Context Assembler 冲突解决规则: Knowledge 优先（企业规则 > 个人偏好）** | **v3.1** |
| **ADR-023** | **Experiment Engine 运营原则: 默认不做 A/B; 离线门槛前置; 一页实验卡(7 项); 护栏阈值自动止损/回滚; 按 tenant/org 分层分流; 周期 7-14 天硬截止(允许一次 +14 天延期); feature flag + experiment_id/variant 轻量闭环; 结论沉淀为 ADR-EXP-xxx; 补充: 同 trace 单维度互斥(碰撞管理)、tenant 知情权、知识继承级联评估** | **v3.1.1** |
| **ADR-024** | **FK 一致性保障: Neo4j 为权威源，Write-Through + sync_status 写入 Qdrant，idempotency_key + version 防重复/冲突。两库字典(FK Registry)支持对账，Reconciliation Job 自愈不一致。删除顺序: 先 Qdrant 再 Neo4j（见 02 Section 7.3）** | **v3.2** |
| **ADR-025** | **事件可靠性分级: Level 1 关键事件(审计/计费/回执)使用 PG Transactional Outbox 保证投递; Level 2 普通事件(通知/缓存)使用 Celery + Redis 尽力投递。Outbox 最小字段: event_id/aggregate_id/event_type/payload/status/retry_count/next_retry_at/created_at（见 06 Section 6）** | **v3.2** |
| **ADR-026** | **Context Assembler 性能策略: Step 1(Memory Core) 与 Step 2(Knowledge Stores) 并发执行; 各步骤硬超时(SLA 级); Knowledge 查询结果可缓存(统一失效入口 + cache_version); Memory Core 查询不缓存（见 01 Section 4.4）** | **v3.2** |
| **ADR-027** | **Memory Core HA: PostgreSQL Streaming Replication + Patroni(私有部署) / 云厂商托管 HA(SaaS); RPO < 1s, RTO < 30s; Brain 通过 MemoryCorePort 抽象无感知底层 HA 方案（见 07 Section 6）** | **v3.2** |
| **ADR-028** | **附录 C 废弃: 可复用代码资产清单来自另一项目，与当前架构文档的"设计规范"定位不符。代码资产跟踪移至项目管理工具** | **v3.2** |
| **ADR-029** | **OrganizationSettings 约束分类: 所有配置项显式标注为 LAW(代码强制)/RULE(管理员可配)/BRIDGE(is_locked 桥接)三级。LAW 边界列标注 RULE 项的系统上限约束。分类表见 06 Section 1.6** | **v3.2.1** |
| **ADR-030** | **API 分区与外部消费者: Gateway 用户 API(/api/v1/*)和管理 API(/api/v1/admin/*)共享 Gateway 但中间件差异化; Frontend UI 和 Admin Console 作为外部消费者纳入 Step 8/9（见 00 Section 12.2, 05 Section 4.1）。外部消费者不引入新 Port、不修改内部层** | **v3.2.1** |
| **ADR-031** | **架构元模型: 三级独立性梯度 -- Level 0 不可分核心对(Brain+MemoryCore) / Level 1 Port耦合功能层(Knowledge/Skill/Tool/Gateway,可通过Port契约独立替换) / Level 2 可插拔环境层(基础设施/部署,配置级切换)。"层独立"的准确含义是"契约兼容前提下可独立演进"而非"互不相关"（见 00 Section 7.4）** | **v3.3** |
| **ADR-032** | **跨层业务闭环: 5 条 Loop -- A(学习进化: Brain->MemoryCore->Promotion->KnowledgeStores) / B(知识沉淀: AdminAPI->KnowledgeStores->Resolver) / C(知识消费: Brain->SkillRouter->Resolver->Skill) / D(计量反压: Gateway pre-check->放行->LLM->post-settle 精确扣减,2阶段时序) / E(治理: AdminConsole->OrgContext->Settings继承链->RLS)。Loop间存在依赖: C依赖B产出, A通过B落地, D对C施加反压, E约束所有Loop（见 00 Section 7.5）** | **v3.3** |
| **ADR-033** | **语义契约与兼容规则: 三大核心数据结构(KnowledgeBundle/MemoryItem/OrgContext)定义 schema v1，显式标注每个字段的必填性和空值语义。兼容规则(对齐 Protobuf/Avro/Pact 业界共识): 新增可选字段(有默认值或可为空)=兼容变更; 新增必填字段/删除字段/重命名字段/改变字段类型或语义/将可选改为必填=破坏性变更(需 expand-contract 迁移)（见 02 Section 5.4.1, 01 Section 2.3.1, 05 Section 4.2）** | **v3.3** |
| **ADR-034** | **Port 演进与契约测试: Port 变更分为兼容变更(新增可选参数/字段/方法)和破坏性变更(签名/返回结构/错误码/超时/时序/行为语义变更)。破坏性变更必须采用 Expand-Contract 三阶段迁移(扩展->迁移->收缩)，最小 deprecation 周期 2 个 minor version。三层契约测试: Layer 1 Port Schema 断言(PR 级阻断) / Layer 2 语义契约 Snapshot(PR 级阻断) / Layer 3 事件契约 Consumer-Driven(日构建)。全部契约集中索引于附录 G（见 00 Section 12.5, 12.6, 附录 G）** | **v3.3.1** |
| **ADR-035** | **动态上下文预算分配器: 在 01 Section 4.2 静态基线之上，根据运行时信号（memory_richness, knowledge_relevance, conversation_depth, model_context_window）弹性调整各 slot 配额。每 slot 设 min/max 硬约束，system_prompt 和 generation_budget 不可压缩。分配异常退回静态基线。推荐实现: 对历史分配记录使用 EWMA 平滑 + hysteresis 防抖，具体算法不锁定（见 01 Section 4.2.1）** | **v3.4** |
| **ADR-036** | **Memory Quality 度量与 Receipt Schema v2: (1) 5 项核心 SLI（staleness_rate/conflict_rate/injection_hit_rate/user_correction_rate/retrieval_latency_p95）各自定义分子/分母/窗口/SLO/聚合维度; (2) 告警采用 Google SRE MWMBR 模式（快速 1h+5m / 缓慢 6h+30m）; (3) memory_receipts 增加 trace_id 和 details_schema_version 字段，details 内部按 receipt_type 结构化（见 01 Section 2.3.2, 06 Section 9）** | **v3.4** |
| **ADR-037** | **PIPL/GDPR 删除管线: 6 存储位置删除范围矩阵（memory_items/conversation_events/session_summaries/Qdrant/Redis/receipts）; tombstone 标记（同步）+ Outbox Level 1 投递（idempotency_key 防重复）+ Physical Deletion Worker（inbox 幂等消费）+ audit_event 永久留痕; Evolution Pipeline 写前检查 tombstone 防删后复活; 30 天 SLA; 审计留存边界: audit_events/tombstones 至少 3 年（见 01 Section 3.1.1, 07 Section 5.2）** | **v3.4** |
| **ADR-038** | **Runtime Governance（伞形，amends ADR-036：SLI 从 5 项扩展到 7 项 + 告警模式补充最小样本量阈值）：038.1 注入正确性闭环、038.2 动态预算工程化、038.3 SLO 可观测性（见 01 Section 2.3.2, 01 Section 4.2.1, 06 Section 9）** | **v3.5** |
| **ADR-039** | **Data Lifecycle Governance（伞形，amends ADR-037：状态机从 4 态扩展到 8 态 + SLA 从硬编码 30 天改为 legal_profile 可配置）：039.1 删除管线增强、039.2 数据生命周期合规（见 01 Section 3.1.1, 06 Section 8, 07 Section 5.2）** | **v3.5** |
| **ADR-042** | **CE (Context Engineering) 优化与 pgvector 默认启用: (1) Memory Core 个人记忆语义检索从"可选 Qdrant projection"改为"pgvector 默认启用"（同库同事务，降级为 FTS-only）; (2) Hybrid Retrieval(FTS+pgvector+RRF融合) + Multi-Signal Reranking(五因子排序) + Query Rewriting; (3) 后处理闭环: 利用检测+隐式反馈+injection_receipt v3.1 扩展; (4) Evolution Pipeline CE 增强: 纠正快速通道+结构化Analysis+Contextual Chunking+Memory Consolidation; (5) confidence_effective 衰减计算(存储值不变,排序时计算); (6) 三方定位: pgvector=Memory Core内嵌, Qdrant enterprise=Knowledge Stores, Qdrant projection=Day-2 Memory性能扩展。Qdrant enterprise 不受影响。所有优化在 01 Brain 层内闭环，不改变 Port 契约，不破坏层间解耦（见 01 Section 2.1/2.3.0.1/2.3.2.4/2.3.2.5/3.2.1/4.1/4.1.1, 06 Section 9）** | **v3.5.1** |
| **ADR-043** | **ContentBlock Schema v1.1: 统一多模态内容模型; text_fallback 必填; 外部统一 media_id, 存储层内部 ObjectRef; 禁止存储临时 URL** | **v3.6** |
| **ADR-044** | **双域媒体存储: personal_media_objects (SSOT-A, tombstone) + enterprise_media_objects (SSOT-B, ChangeSet); 各自独立 RLS; enterprise 不引用 tombstone** | **v3.6** |
| **ADR-045** | **三步上传协议: init -> 客户端直传 -> complete; 每步安全检查范围明确; complete 后阻断规则; 配额预扣+超时回收** | **v3.6** |
| **ADR-046** | **LLMCallPort Expand 迁移: content_parts 可选参数; Expand-Contract 三阶段; 最小 2 minor versions 兼容期** | **v3.6** |
| **ADR-047** | **Tool 独立计费: tool_usage_records 与 llm_usage_records 分离; Loop D Pre-check 覆盖双维度** | **v3.6** |
| **ADR-048** | **媒体删除完整性: Step 0 意图记录不可跳过; personal 走 tombstone, enterprise 走 ChangeSet; 覆盖原始/衍生/CDN/向量/图谱/缓存; 不可逆操作后置** | **v3.6** |
| **ADR-049** | **Tier 命名一致性修正: 06-基础设施层.md tier_types DEFAULT 值对齐 Section 1.1 五层定义; M0 落地修正。迁移映射: headquarters->platform, province->brand_hq(新增brand_dept), city->regional_agent, store->franchise_store。联动检查: max_org_depth 基线确认为 5(无需修改); tier_types 从 4 元素扩展为 5 元素(唯一实际变更); 系统中无代码硬编码旧 tier 名称。执行方式: 作为 M0 基座期文档修正任务。OrgContext Schema v1 的 org_tier 枚举值同步更新(05 Section 4.2), Expand-Contract: 新增枚举值, 旧值 2 minor versions 后移除** | **v3.6** |
| **ADR-050** | **版本号三层分离: DB 行级 (content_schema_version) / WS 消息级 (content_version) / 事件级 (payload_version) 三层; content JSONB 内禁放版本号; 三层互不依赖** | **v3.6** |
| **ADR-051** | **媒体安全状态机: 6 态 (pending/scanning/safe/rejected/quarantined/expired); 三层拦截 (Gateway/Brain/LLMCallPort); quarantined 后异步降级展示 text_fallback** | **v3.6** |
| **ADR-052** | **Checksum 校验规范: 禁止 ETag; 使用 S3 原生 x-amz-checksum-sha256; 分片上传兼容** | **v3.6** |

---

## ~~附录 C: 可复用的既有代码资产~~ [已废弃, 见 ADR-028]

> **废弃说明:** 此附录的代码资产清单来自另一项目原型，与当前架构文档的"设计规范"定位不符。代码资产跟踪已移至项目管理工具。以下内容仅作历史参考保留。

| ~~模块~~ | ~~行数~~ | ~~改造方向~~ |
|------|------|---------|
| ~~RBAC 框架~~ | ~~264~~ | ~~增加 Org Scope 判定~~ |
| ~~租户上下文~~ | ~~100~~ | ~~扩展为 org_context + org_path~~ |
| ~~权限装饰器~~ | ~~233~~ | ~~扩展为 require_role/require_org_tier~~ |
| ~~隔离守卫~~ | ~~229~~ | ~~扩展为 RLS + org_chain 校验~~ |
| ~~图谱查询~~ | ~~768~~ | ~~每模板加 org_chain 过滤 + FK 联动~~ |
| ~~向量检索~~ | ~~872~~ | ~~加 FK payload 过滤 + source_type 区分 + graph_node_id~~ |
| ~~PolicyBundle 组装~~ | ~~629~~ | ~~重构为 KnowledgeBundle + FK 联动~~ |
| ~~ID 生成器~~ | ~~779~~ | ~~新增 graph_node 前缀~~ |
| ~~Dify DSL 构建器~~ | ~~695~~ | ~~可直接复用（原型验证）~~ |
| ~~灰度开关~~ | ~~419~~ | ~~可直接复用~~ |

---

## 附录 D: 技术栈总览

| 能力 | 方案 | 自建/借力 |
|------|------|----------|
| LLM 调用 | LiteLLM SDK | 借力 |
| LLM 观测 | Langfuse 自托管 | 借力 |
| 图数据库 | Neo4j | 借力 |
| 向量数据库 | Qdrant | 借力 |
| 关系数据库 | PostgreSQL + RLS + ltree + pgvector | 借力 |
| 任务队列 | Celery + Redis | 借力 |
| 数据库迁移 | Alembic | 借力 |
| 对象存储 | S3 / MinIO (S3 兼容) | 借力 |
| 指标采集+告警 | Prometheus + Alertmanager | 借力 |
| 可视化 | Grafana | 借力 |
| **Brain (对话 Agent 内核)** | **自建** | **核心差异化** |
| **Memory Core (SSOT-A)** | **自建** | **核心差异化** |
| **Context Assembler** | **自建** | **核心差异化** |
| **记忆引擎** | **自建** | **核心差异化** |
| **Knowledge Stores FK 联动** | **自建** | **核心差异化** |
| **Diyu Resolver** | **自建** | **核心差异化** |
| **Skill 框架** | **自建（SkillManifest 注册契约格式，见 03 Section 2）** | **核心架构** |
| **Tool 框架** | **自建** | **核心架构** |
| **Promotion Pipeline** | **自建** | **核心架构** |

---

## 附录 E: 待决事项

| 决策点 | 当前状态 |
|--------|---------|
| 用户认证 | **已决: JWT 自建 + AuthProvider 接口抽象** |
| 组织树深度 | **已决: 固定 5 层** |
| 知识冲突 | **已决: Context Assembler 中 Knowledge 优先** |
| 权限模型 | **已决: RBAC + Org Scope** |
| 记忆框架 | **已决: 自建，借鉴 Zep 时序设计** |
| MCP 协议 | **已决: 预留适配器，不绑定** |
| LLM 网关 | **已决: LiteLLM SDK 集成** |
| LLM 观测 | **已决: Langfuse 自托管** |
| 多语言 | **已决: 不做** |
| 外部通知 | **已决: 预留接口** |
| 双 SSOT 架构 | **已决: Memory Core(硬依赖) + Knowledge Stores(软依赖)** |
| Neo4j 版本治理 | **已决: 方案 A 起步，方案 B 后期叠加** |
| WebSocket 模式 | **已决: 按会话连接，生命周期语义见 05 Section 7** |
| 前端框架 | **已决: Next.js 15 + App Router（见 FE-00 / FE-01）** |
| 数据导出/报表 | 后续补充 |
| 素材管理(DAM) | 后续补充 |
| 灰度发布 | **已决: Experiment Engine + feature_flags 轻量闭环（见 06 Section 5, ADR-023）** |
| 约束分类（LAW/RULE/BRIDGE） | **已决: OrganizationSettings 三级分类 + LAW 边界标注（见 06 Section 1.6, ADR-029）** |
| API 分区与外部消费者 | **已决: 用户/管理 API 分区 + Frontend UI/Admin Console 作为 Step 8/9（见 05 Section 4.1, 00 Section 12.2, ADR-030）** |
| 个人记忆向量检索 | **已决: pgvector 默认启用（同库同事务），Qdrant personal_projection 降级为 Day-2 性能增强选项（见 01 Section 3.2.1, ADR-042）** |
| 记忆检索策略 | **已决: Hybrid Retrieval(FTS+pgvector+RRF) + Multi-Signal Reranking 五因子排序（见 01 Section 4.1, ADR-042）** |

---

## 附录 F: 后续待补充

| 模块 | 说明 |
|------|------|
| 数据导出与报表 | PIPL 数据导出 + 运营报表 |
| 素材管理(DAM) | 层级化素材库 + AI 标签 |
| ~~灰度发布~~ | ~~Skill/Prompt 灰度上线~~ **已纳入 06 Section 5 Experiment Engine，见 ADR-023** |
| 外部通知 | Webhook + 企业微信/钉钉 |
| 离线/弱网 | PWA + 关键数据离线缓存 |
| 库存实时对接 | ExternalAPI Tool 对接 ERP |

---

## 附录 G: 契约索引表

> **[v3.3.1 新增]** 集中索引所有 Port 接口、语义契约和事件契约，避免散落各文档难以查找。

### G.1 Port 接口索引

| Port | 职责 | 定义文档 | Schema 版本 | 独立性级别 |
|------|------|---------|------------|-----------|
| MemoryCorePort | 封装 Memory Core 读写 | 01-Brain Section 6 | v1 | Level 0 (Core Pair) |
| KnowledgePort | 封装 Knowledge Stores 读取 | 01-Brain Section 6 / 00-总览 Section 12.3 | v1 | Level 1 (Functional) |
| LLMCallPort | 封装所有 LLM 调用 | 00-总览 Section 12.3 | v1 | Level 1 (Functional) |
| SkillRegistry | 技能发现与调度 | 00-总览 Section 12.3 | v1 | Level 1 (Functional) |
| OrgContext | 封装组织上下文组装 | 05-Gateway Section 4 | v1 | Level 1 (Functional) |
| StoragePort | 封装通用持久化读写 | 00-总览 Section 12.3 | v1 | Level 2 (Environment) |
| ObjectStoragePort | [v3.6] 封装对象存储操作 (S3/MinIO/OSS) | 00-总览 Section 12.3.1 | v1 | Level 2 (Environment, v3.6 Extension Port) |

### G.2 语义契约索引

| 契约 | 数据结构 | 定义文档 | Schema 版本 | 兼容规则 | 涉及 Loop |
|------|---------|---------|------------|---------|----------|
| KnowledgeBundle | Resolver 输出 | 02-Knowledge Section 5.4.1 | v1 | ADR-033 | B, C |
| MemoryItem | MemoryCorePort 输出 | 01-Brain Section 2.3.1 | v1 | ADR-033 | A |
| OrgContext | OrgContext Port 输出 | 05-Gateway Section 4.2 | v1 | ADR-033 | D, E |
| EvolutionProposal | Promotion Pipeline 载体 | 02-Knowledge Section 4.2 / Section 7 | v1 | ADR-033 | A |
| WriteReceipt | MemoryCorePort 写入回执 | 01-Brain Section 2.3.1 | v1 | ADR-033 | A |
| ResolutionMetadata | KnowledgeBundle 子结构 | 02-Knowledge Section 5.4.1 | v1 | ADR-033 | B, C |
| ContentBlock | [v3.6] 统一多模态内容模型 | 08-附录 G.2.1 (ADR-043) | v1.1 | ADR-033 | A, B, C |
| MediaRef | [v3.6] KnowledgeBundle 媒体引用 | 02-Knowledge Section 5.4.1 | v1 | ADR-033 | B, C |
| MultimodalMessage | [v3.6] WS payload 多模态扩展 | 05-Gateway Section 7.1 | v1 | ADR-033 | C |

#### G.2.1 ContentBlock Schema v1.1 完整定义 (ADR-043)

> **[v3.6 新增]** 统一多模态内容模型的字段级契约定义。所有跨层传递多模态内容的位置均引用此 Schema。

```
ContentBlock Schema v1.1:
  type: "text" | "image" | "audio" | "video" | "document"   -- 必填
  text: Optional[str]              -- type=text 时必填; type!=text 时可选 (补充说明)
  media_id: Optional[UUID]         -- type!=text 时必填; type=text 时禁填
  metadata: Optional[Dict]         -- MIME type, duration, dimensions 等; 可选
  text_fallback: str               -- 必填，所有类型均提供纯文本回退

字段约束矩阵:
  | type     | text     | media_id | metadata | text_fallback |
  |----------|----------|----------|----------|---------------|
  | text     | 必填     | 禁填     | 可选     | 必填          |
  | image    | 可选     | 必填     | 可选     | 必填          |
  | audio    | 可选     | 必填     | 可选     | 必填          |
  | video    | 可选     | 必填     | 可选     | 必填          |
  | document | 可选     | 必填     | 可选     | 必填          |

ID 模型规则 (LAW):
  外部接口 (API / WS / ContentBlock / Skill / Brain):
    统一使用 media_id: UUID
    禁止暴露 bucket / key / presigned_url

  存储层内部 (ObjectStoragePort 实现 / 安全管线 Worker / LLMCallPort 实现):
    通过 media_id -> 查表获取 ObjectRef (bucket/key/checksum/size/mime)
    ObjectRef 仅在存储层代码内流转

  ObjectRef (存储层内部结构，禁止跨层传递):
    bucket: str
    key: str                      -- 格式: {org_id}/{scope}/{uuid}.{ext}
    checksum_sha256: str
    size_bytes: int
    mime_type: str

  解析责任边界:
    media_id -> ObjectRef 的解析仅发生在:
      1. ObjectStoragePort 实现层 (生成 URL / 执行删除)
      2. 安全管线 Worker (读取文件做扫描)
      3. LLMCallPort 实现层 (构建 LLM API payload)
    其余所有层级仅传递 media_id

兼容性 (ADR-033):
  现有 content JSONB 字段 (conversation_events.content, memory_items.content)
  当前值: {"text": "..."} 或纯字符串
  扩展后: {"blocks": [ContentBlock], "text_fallback": "..."}
  向后兼容: 无 "blocks" 字段时视为纯文本
  注: content JSONB 内禁止放版本号 (版本由行级列决定，见版本号三层分离原则 ADR-050)
```

### G.3 事件契约索引

| 事件类型 | 级别 | 生产者 | 消费者 | 定义文档 | 涉及 Loop |
|---------|------|--------|--------|---------|----------|
| audit_event | Level 1 | 各层 | 审计服务 | 06 Section 6 | E |
| billing_event | Level 1 | LLM Gateway | Token Billing | 06 Section 6 | D |
| promotion_receipt | Level 1 | Promotion Pipeline | Memory Core / 通知 | 02 Section 7 | A |
| knowledge_write_receipt | Level 1 | Knowledge Write API | 审计 / 通知 | 02 Section 7 | B |
| cache_invalidation | Level 2 | Knowledge Write API | Context Assembler | 01 Section 4.4 | C |
| notification_event | Level 2 | 各层 | 通知服务 | 06 Section 6 | E |
| **decision_event** | **Level 1** | **Context Assembler** | **审计 / SLI 聚合** | **06 Section 6.3** | **A, C** |
| **deletion_event** | **Level 1** | **Deletion Pipeline** | **Physical Deletion Worker / 审计** | **06 Section 6.3** | **E** |
| **degrade_event** | **Level 1（关键告警）/ Level 2（普通通知）** | **各层降级触发点** | **SLI 聚合 / 告警** | **06 Section 6.3** | **A, C, D** |
| **media_event** | **Level 1** | **Gateway / 安全管线 / 删除管线** | **安全管线 Worker / 删除 Worker / 审计 / 计费 / 回收 Worker** | **06 Section 6.3** | **B, D, E** |

> **[v3.5 新增] Unified Event Model:** 以上三类事件共享字段规格 -- event_id(UUID), trace_id(UUID), tenant_id(UUID), timestamp(TIMESTAMPTZ), policy_version(TEXT)。payload 内部结构按 event_type 区分，详见 06 Section 6.3。payload_version 从 1 起始，遵循 ADR-033 兼容规则。

**SSE Transport Mapping (v4.4 新增, 05a-API-Contract 对齐):**

```
上述系统事件通过 event_outbox -> SSE Gateway 投递到前端。
映射规则: domain_event.type -> SSE event name (1:1 映射)
前端消费: FE-02 Section 2 SSE event handlers
v3.6 新增: media_event (7 subtypes) 作为单一 SSE event 类型, 通过 subtype 字段区分
SSE Event 完整定义: 引用 05a-API-Contract.md Section 5
```

### G.4 契约测试层级索引

| Layer | 名称 | 触发时机 | 定义文档 |
|-------|------|---------|---------|
| Layer 1 | Port Schema 断言 | PR 级阻断 | 00 Section 12.6, ADR-034 |
| Layer 2 | 语义契约 Snapshot | PR 级阻断 | 00 Section 12.6, ADR-034 |
| Layer 3 | 事件契约 Consumer-Driven | 日构建 | 00 Section 12.6, ADR-034 |
| **Layer 4** | **持久化数据版本兼容** | **发布前回归** | **06 Section 6.4, ADR-034** |

> **[v3.5 新增] Layer 4 说明:** 验证 DDL 变更对持久化数据的前向/后向兼容性，包括 schema migration 回滚安全性、content_schema_version 升降级路径、details_schema_version v2->v3 兼容性。与 00 Section 12.6 契约测试三层策略对齐，作为第四层补充。

**v3.6 契约测试扩展条目:**

```
Layer 1 新增:
  +-- ObjectStoragePort: 方法签名 (generate_upload_url, generate_download_url,
      delete_object, delete_objects, head_object) + 参数类型 + 返回类型
  +-- LLMCallPort.call(): content_parts 可选参数类型断言
      (List[ContentBlock] | None, Expand 兼容)
  覆盖范围: 原 6 个 Port + ObjectStoragePort = 7 个 Port

Layer 2 新增:
  +-- ContentBlock Schema v1.1: JSON Schema snapshot
      测试: 构造合法 ContentBlock (各 type: text/image/audio/video/document) -> 序列化 -> snapshot 比对
  +-- KnowledgeBundle media_contents: JSON Schema snapshot (扩展字段)
      测试: 含 media_contents 的 KnowledgeBundle -> snapshot 比对
  +-- MultimodalMessage (WS payload): JSON Schema snapshot
      测试: ai_response_chunk 含 blocks + content_version -> snapshot 比对
  覆盖范围: 原 3 个 schema (KnowledgeBundle/MemoryItem/OrgContext) + 3 个新增 = 6 个 schema

Layer 3 新增:
  +-- media_event (7 个子类型): 生产者构造事件 -> 断言符合消费者契约
      消费者清单:
        安全管线 Worker (订阅 upload_completed)
        删除管线 Worker (订阅 deletion_requested)
        审计服务 (订阅所有 media_event)
        计费服务 (订阅 upload_completed, 用于存储计量)
        回收 Worker (订阅 upload_expired)
  +-- tool_usage_records 相关计费事件 payload 断言
  覆盖范围: 原 Level 1/2 事件 + media_event + tool billing event

Layer 4 新增:
  +-- conversation_events: content_schema_version=0 样本 + version=1 样本
      测试: 新代码能正确解析 version=0 的纯文本 content (向后兼容验证)
  +-- personal_media_objects / enterprise_media_objects: v1 样本
  +-- tool_usage_records: v1 样本
  覆盖范围: 原 memory_items/event_outbox/receipts + 新增 3 张表的 Fixture

CI 集成规则 (与现有一致):
  PR 级: Layer 1 + Layer 2 必须通过
  日构建: Layer 3 + Layer 4 完整运行
  破坏性变更: snapshot diff -> 自动标注 BREAKING CHANGE
```

**前端参与层 (v4.4 新增, FE-08 Section 5 对接):**

```
Layer 1 (Port Schema): 前端 api-client TypeScript types 必须与此层 Schema 一致
Layer 2 (Semantic Snapshot): 前端可运行 snapshot 测试验证 API 响应结构未变
Layer 3 (Event Consumer-Driven): 前端作为 event consumer 提供 consumer contract
Layer 4 (Persistence): 前端不直接参与, 但依赖此层保证数据兼容性
```

> **维护规则:** 新增 Port / 语义契约 / 事件契约时，须同步更新本索引表。PR review checklist 中包含此项。

---

> **文档版本:** v3.6
> **创建日期:** 2026-02-07
> **核心变更:** 双 SSOT 平行架构; ADR-003 废弃并由 ADR-017 替代; 新增 ADR-017~023; Experiment Engine 完整规范; **v3.2: ADR-024~028; 附录 C 废弃**; **v3.2.1: LAW/RULE/BRIDGE 术语; ADR-029~030**; **v3.3: 架构元模型+跨层闭环+语义契约v1; ADR-031~033**; **v3.3.1: Port演进策略+契约测试+契约索引表(附录G); ADR-034**; **v3.3.2: LAW参数化评估**; **v3.4: Memory Quality度量框架+动态预算分配器+PIPL/GDPR删除管线+Receipt Schema v2+审计留存边界; ADR-035~037**; **v3.5: Runtime Governance(ADR-038 amends 036)+Data Lifecycle Governance(ADR-039 amends 037)+Unified Event Model契约+Prometheus/Grafana技术栈+契约测试Layer 4+SkillManifest注册契约**; **v3.5.1: CE优化落盘(pgvector默认启用/Hybrid Retrieval/Reranking/后处理闭环/Evolution增强/confidence_effective); ADR-042**; **v3.6: 多模态能力架构(ContentBlock Schema v1.1/双域媒体存储/三步上传协议/security_status状态机/ObjectStoragePort/LLMCallPort Expand/Tool独立计费/媒体删除完整性/版本号三层分离); ADR-043~052; 契约测试4层扩展; 术语表+技术栈+Port索引+契约索引同步更新**
