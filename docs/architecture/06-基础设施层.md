# 基础设施层（服务 + 存储 + 组织模型）

> **所属层:** 基础层
> **版本:** v3.6
> **验证标准:** 各服务可独立测试；PG 数据模型 + RLS 隔离可验证；Experiment Engine 分流/止损/碰撞管理可验证；事件可靠性分级可验证

---

## 1. 组织模型（横切关注点）

### 1.1 组织树

> 组织树是整个系统的基础数据模型。所有的知识继承、权限管控、审核流转都建立在组织树之上。

```
Organization（组织节点）
+-- org_id: UUID             全局唯一标识
+-- name: String             组织名称
+-- tier: Enum               层级类型
+-- parent_org_id: UUID      上级组织（顶级为 null）
+-- brand_id: UUID           所属品牌
+-- path: LTREE              物化路径
+-- settings: JSONB          组织级配置
+-- status: Enum             active | suspended | archived
                             前端消费: Admin Console 组织管理面板展示; suspended 状态组织显示受限标识
+-- created_at / updated_at
```

**层级类型 (tier):**

| tier | 含义 | 父级约束 |
|------|------|---------|
| platform | 平台运营方（笛语自身） | 无（根节点） |
| brand_hq | 品牌总部 | parent = platform |
| brand_dept | 总部部门（市场/设计/电商等） | parent = brand_hq，不可有子节点 |
| regional_agent | 省级代理 | parent = brand_hq |
| franchise_store | 加盟终端门店 | parent = regional_agent，不可有子节点 |

> **[裁决]** 组织树最大深度固定 5 层，不可配置。

**典型组织树:**

```
platform: 笛语平台 (path: 'diyu')
+-- brand_hq: 某品牌服装 (path: 'diyu.brand_a')
|   +-- brand_dept: 市场部
|   +-- brand_dept: 设计部
|   +-- regional_agent: 华东代理 (path: 'diyu.brand_a.region_east')
|   |   +-- franchise_store: 杭州旗舰店
|   |   +-- franchise_store: 上海南京路店
|   |   +-- franchise_store: 南京新街口店
|   +-- regional_agent: 华南代理
|   +-- regional_agent: 华北代理
+-- brand_hq: 另一个品牌
```

### 1.2 ltree 物化路径

> **[裁决] 采纳 PostgreSQL ltree 扩展。**

```sql
CREATE EXTENSION IF NOT EXISTS ltree;

CREATE TABLE organizations (
  org_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  tier TEXT NOT NULL,
  parent_org_id UUID REFERENCES organizations(org_id),
  brand_id UUID,
  path LTREE NOT NULL,
  settings JSONB DEFAULT '{}',
  status TEXT NOT NULL DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_org_path ON organizations USING GIST (path);

-- 查某省代下属所有门店
SELECT * FROM organizations WHERE path <@ 'diyu.brand_a.region_east';
-- 查某门店的完整上级链路
SELECT * FROM organizations WHERE 'diyu.brand_a.region_east.store_hz' <@ path;
```

### 1.3 用户与角色

```
OrgMember（组织成员）
+-- user_id: UUID, org_id: UUID
+-- role: Enum               角色
+-- status: Enum             active | disabled
+-- invited_by: UUID
+-- UNIQUE(user_id, org_id)
+-- 一个用户可属于多个组织
```

**角色与权限:**

| 角色 | 管理组织 | 管理成员 | 创建内容 | 审核内容 | 查看内容 | 管理知识库 | 配置管控 | 导出数据 | 管理模型 | 管理实验 | 查看计费 |
|------|---------|---------|---------|---------|---------|----------|---------|---------|---------|---------|---------|
| owner | Y | Y | Y | Y | Y | Y | Y | Y | Y | Y | Y |
| admin | Y | Y | Y | Y | Y | Y | Y | Y | - | Y | Y |
| editor | - | - | Y | - | Y | - | - | - | - | - | - |
| reviewer | - | - | - | Y | Y | - | - | - | - | - | - |
| viewer | - | - | - | - | Y | - | - | - | - | - | - |

**权限码映射（Gateway 鉴权使用）:**

| 权限列 | 权限码 (Permission Key) | 说明 |
|--------|------------------------|------|
| 管理组织 | `org.manage` | 组织 CRUD、层级调整 |
| 管理成员 | `member.manage` | 邀请/移除/角色变更 |
| 创建内容 | `content.create` | 发起内容生成任务 |
| 审核内容 | `content.review` | 审批内容发布 |
| 查看内容 | `content.read` | 读取内容和对话历史 |
| 管理知识库 | `knowledge.manage` | Knowledge Stores 写入/删除 |
| 配置管控 | `settings.manage` | OrganizationSettings 修改(RULE 级) |
| 导出数据 | `data.export` | 数据导出/报表下载 |
| 管理模型 | `model.manage` | 模型注册/启停/Fallback 链配置 |
| 管理实验 | `experiment.manage` | 实验创建/启停/分流配置 |
| 查看计费 | `billing.read` | Token 用量和成本报表查看 |

### 1.4 权限判定

> **[裁决]** RBAC + 组织树约束。不引入外部 ReBAC 引擎。

```
ALLOW = role.has_permission(action) AND target.path <@ actor.path
```

### 1.5 组织级配置

```
OrganizationSettings:
+-- content_policy: strict | standard | relaxed
+-- review_flow:
|     auto_compliance_check: Boolean
|     require_regional_review: Boolean
|     require_hq_review: Boolean
+-- content_restrictions:
|     allowed_platforms: [String]
|     forbidden_words: [String]        各级叠加，不可删减上级
|     max_discount_mention: Float
|     tone_override_allowed: Boolean
|     is_locked: [String]              锁定的配置项
+-- feature_flags:
|     skill_whitelist: [String]
|     tool_whitelist: [String]
|     experiment_participation: Boolean
+-- model_access:
|     allowed_models: [String]         子组织只能是父组织子集
|     default_model: String
|     budget_monthly_tokens: Integer
|     budget_alert_threshold: Float
|     budget_hard_limit: Boolean
|     budget_tool_amount: Float        v3.6 新增: 工具费用预算 (独立于 token 预算)
|                                      数据流: org_settings.model_access.budget_tool_amount (config SSOT)
|                                              -> usage_budgets.budget_tool_amount (runtime 单向初始化)
+-- media_config:                      v3.6 新增: 多模态媒体治理配置 (Loop E)
|     allowed_media_types: [String]    允许的媒体类型 ['image','audio','video','document']
|     file_size_limit: Integer         单文件大小上限 (bytes)
|     media_quota: Integer             组织媒体存储总配额 (bytes)
|     nsfw_sensitivity: Float          NSFW 检测灵敏度阈值
|     quarantine_expire_days: Integer  quarantined 超期天数 (默认 7)
+-- llm_config:
      preferred_model: String
      fallback_chain: [String]
      temperature_override: Float

继承规则:
1. 子组织未覆盖 -> 继承父组织
2. is_locked 中的项 -> 子组织设置被忽略
3. forbidden_words -> 各级叠加
4. allowed_models -> 取交集（子不能超越父）
5. allowed_media_types -> 取交集（与 allowed_models 同模式）

前端暴露索引 (v4.4 新增, 通过 effective-settings API 暴露给前端):
  content_policy group: content_policy, content_restrictions, brand_tone, personas
  review_flow group: review_flow, auto_compliance_check, require_regional_review, require_hq_review
  feature_flags group: skill_whitelist, tool_whitelist
  model_access group: allowed_models, default_model, fallback_chain
  media_config group (v3.6): allowed_media_types, file_size_limit, nsfw_sensitivity,
                              quarantine_expire_days, media_quota
  llm_config group: preferred_model, temperature_override
  knowledge group: knowledge_visibility_acl
  完整 Schema: 引用本文档 Section 1.5 OrganizationSettings 各 group 定义

org_settings.branding [Phase 2 reserved]:
  -- brand visual customization (logo, primary_color, font_family)
  -- 引用 L-8 alignment gap
```

### 1.6 约束分类（LAW / RULE / BRIDGE）

> **[裁决 v3.2.1]** 组织模型中所有配置项显式标注约束级别，指导 Admin Console 实现和安全测试。见 ADR-029。

```
约束级别定义:

  LAW（系统不变量）:
    代码/数据库级强制，任何 API 都无法违反。
    Admin Console: 只读展示或不显示。
    测试要求: 不可绕过性测试（直接调 API 验证拒绝）。

  RULE（租户可配置）:
    Admin Console 呈现为表单控件。
    测试要求: 边界值测试 + 继承测试。

  BRIDGE（is_locked 机制）:
    对当前组织 = RULE（admin 决定锁哪些项）。
    对子组织 = LAW 效果（被锁定的项不可修改）。
```

**各配置项分类:**

| 配置项 | 级别 | LAW 边界（如有） | Admin Console 呈现 |
|--------|------|-----------------|-------------------|
| 组织树固定 5 层 | LAW | -- | 不显示 |
| tier 类型固定 5 种 | LAW | -- | 只读 |
| 父级约束（叶节点不可有子节点等） | LAW | -- | 不显示 |
| RBAC 5 角色定义 | LAW | -- | 只读（角色名不可改） |
| 权限判定公式 | LAW | -- | 不显示 |
| RLS 隔离策略 | LAW | -- | 不显示 |
| content_policy | RULE | -- | 单选 |
| auto_compliance_check | RULE | -- | 开关 |
| require_regional_review | RULE | -- | 开关 |
| require_hq_review | RULE | -- | 开关 |
| allowed_platforms | RULE | -- | 多选 |
| forbidden_words | RULE | LAW: 各级叠加，不可删减上级词条 | 可添加列表（已有上级词条只读） |
| max_discount_mention | RULE | -- | 数值输入 |
| tone_override_allowed | RULE | -- | 开关 |
| allowed_models | RULE | LAW: 父组织 allowed_models 取交集为上界 | 多选（选项范围 = 父组织交集后的可选集） |
| default_model | RULE | LAW: 必须在 allowed_models 范围内 | 下拉（选项 = 当前 allowed_models） |
| budget_monthly_tokens | RULE | -- | 数值输入 |
| budget_alert_threshold | RULE | -- | 数值输入 |
| budget_hard_limit | RULE | -- | 开关 |
| preferred_model | RULE | LAW: 必须在 allowed_models 范围内 | 下拉 |
| fallback_chain | RULE | LAW: 每项必须在 allowed_models 范围内 | 排序列表 |
| temperature_override | RULE | -- | 滑块 |
| skill_whitelist | RULE | -- | 多选 |
| tool_whitelist | RULE | -- | 多选 |
| experiment_participation | RULE | -- | 开关 |
| budget_tool_amount | RULE | -- | 数值输入 |
| allowed_media_types | RULE | LAW: 父组织 allowed_media_types 取交集为上界 | 多选（选项范围 = 父组织交集后的可选集） |
| file_size_limit | RULE | -- | 数值输入 |
| media_quota | RULE | -- | 数值输入 |
| nsfw_sensitivity | RULE | -- | 滑块 |
| quarantine_expire_days | RULE | -- | 数值输入 |
| is_locked（锁定哪些项） | BRIDGE | -- | 多选（仅对子组织生效） |
| **v3.6 多模态 LAW 约束** | | | |
| 外部接口禁止暴露 ObjectRef | LAW | -- | 不显示 (架构级) |
| ObjectRef 禁止持久化 presigned_url | LAW | -- | 不显示 (架构级) |
| personal/enterprise_media_objects 物理隔离 | LAW | -- | 不显示 (DDL 级) |
| enterprise_media 删除走 ChangeSet 禁止引用 tombstone | LAW | -- | 不显示 (架构级) |
| enterprise 删除顺序 Qdrant-first | LAW | -- | 不显示 (FK 协议) |
| 删除 Step 0 意图记录不可跳过 | LAW | -- | 不显示 (审计级) |
| 安全扫描 Stage 1 同步预检不可旁路 | LAW | -- | 不显示 (安全级) |
| security_status != safe 的 media_id 不可被引用 | LAW | -- | 不显示 (三层拦截) |
| content JSONB 内禁止放版本号 | LAW | -- | 不显示 (三层分离原则) |
| 禁止使用 ETag 做完整性校验 | LAW | -- | 不显示 (ADR-052) |
| idempotency_key 禁止包含 timestamp | LAW | -- | 不显示 (幂等性) |
| 异构存储禁止假设分布式事务 | LAW | -- | 不显示 (outbox + FK 协议) |
| 删除管线不可逆操作必须排在最后 | LAW | -- | 不显示 (安全级) |

#### 1.6.1 LAW 约束参数化评估

> **[v3.3.2 新增]** 逐条评估当前 LAW 约束是否适合在未来降级为 RULE 或参数化配置，以提升系统对不同行业/客户的适应性。

```
评估方法: 对每条 LAW 约束回答 3 个问题:
  Q1: 该约束是否基于技术实现的硬性限制？（是 -> 保持 LAW）
  Q2: 是否存在合理的业务场景需要突破该约束？（否 -> 保持 LAW）
  Q3: 参数化后是否引入安全/一致性风险？（是 -> 保持 LAW）
```

| LAW 约束 | Q1 技术硬限 | Q2 有业务需求突破 | Q3 参数化有风险 | 评估结论 | 说明 |
|---------|-----------|-----------------|---------------|---------|------|
| 组织树固定 5 层 | 否（ltree 支持任意深度）| 是（某些行业 3 层或 7 层更合理）| 中（层数变更需大量 RLS/查询/UI 联动调整）| **可参数化但需 V2 规划** | 当前 5 层对目标行业（零售连锁）合理。建议: 预留 max_org_depth 配置项但 v1 硬编码为 5，V2 评估开放 |
| tier 类型固定 5 种 | 否 | 是（与层数联动，不同行业层级名称不同）| 中 | **随 org_depth 一并参数化** | tier 名称可参数化，但类型集合需与 org_depth 联动 |
| 父级约束（叶节点不可有子节点等） | 是（树完整性保障）| 否 | 是 | **保持 LAW** | 树结构完整性是系统正确性基础，不可放松 |
| RBAC 5 角色定义 | 否 | 是（某些客户需要更细粒度角色）| 中（影响权限判定逻辑和 UI）| **保持 LAW，但预留扩展点** | 建议: v1 保持 5 角色; 权限判定公式基于 permission codes 而非角色硬编码，为未来自定义角色留路径 |
| 权限判定公式 | 是（安全核心逻辑）| 否 | 是（自定义判定公式 = 安全漏洞入口）| **保持 LAW** | 权限判定是安全红线，不可参数化 |
| RLS 隔离策略 | 是（数据隔离核心）| 否 | 是（放松 RLS = 数据泄露）| **保持 LAW** | 多租户数据隔离是系统安全基石 |

```
评估总结:

确认为真正不变量（保持 LAW，不参数化）:
  +-- 父级约束（树完整性）
  +-- 权限判定公式（安全核心）
  +-- RLS 隔离策略（数据隔离）

确认为 LAW 但预留扩展路径:
  +-- RBAC 角色定义: v1 保持 5 角色 LAW;
      扩展路径: 权限判定基于 permission codes 解耦角色硬编码

可参数化但需 V2 规划:
  +-- org_depth(组织树层数) + tier_types(层级类型):
      影响面大（RLS policy, org_chain 查询, UI breadcrumb, 继承逻辑）
      建议 v1 预留 max_org_depth/tier_types 配置字段但锁定为当前值
      V2 专项评估联动改造范围

不可参数化的原因共性:
  凡涉及数据隔离（RLS）和安全判定（权限公式）的约束，
  其正确性依赖于确定性行为，参数化 = 引入不确定性 = 安全风险。

预留配置字段（v1 锁定为当前值，V2 开放修改）:
  +-- max_org_depth INTEGER DEFAULT 5
  +-- tier_types TEXT[] DEFAULT ARRAY['platform','brand_hq','brand_dept','regional_agent','franchise_store']
  标注: 见上述"可参数化但需 V2 规划"评估结论。
```

---

## 2. Organization Service

```
OrganizationService:
+-- create_org / get_org / get_org_chain / get_children / get_subtree
+-- get_merged_settings(org_id)      含 is_locked 检查
+-- check_permission(user_id, org_id, permission)
|     内部: RBAC 判定 + Org Scope 判定
+-- move_org(org_id, new_parent_id)  递归更新子树 path
```

---

## 3. Token Billing Service

```
TokenBillingService:
+-- record_usage(org_id, user_id, model_id, tokens, skill_id, task_id)
+-- check_budget(org_id) -> { remaining, percentage, is_exceeded }
+-- enforce_budget(org_id) -> allow | warn | downgrade | reject
+-- Redis 实时计数 + PostgreSQL 每日对账

数据表: llm_usage_records, usage_budgets, usage_daily_summaries
```

---

## 4. Audit Service

```
AuditService:
+-- log_event(event)
+-- get_content_provenance(task_id) -> 完整溯源链

generation_metadata（每条 AI 内容的溯源链）:
+-- model_id, prompt_template_version
+-- retrieved_knowledge_ids（图谱节点 + FK 关联的向量条目）
+-- persona_id, content_type_id
+-- raw_output（合规修改前的原始输出）
+-- compliance_modifications
+-- tokens, cost
+-- experiment_id / variant（如有）

全链路 trace_id:
  对话事件 -> 检索 -> 注入 -> (若发生) promotion -> knowledge 写入
  一条链可追溯
```

---

## 5. Experiment Engine

> **[裁决 已定稿]** 全局基础设施。可实验: Brain 路由策略、Skill 执行策略、Knowledge 检索策略、Prompt 版本、模型选择。
> 遵循"默认不做、轻量闭环、租户隔离、强制止损"原则。见 ADR-023。

### 5.1 核心原则

| # | 原则 | 要点 | 架构锚点 |
|---|------|------|---------|
| P1 | 默认不做 A/B | 只有"高影响且不确定"的改动才做实验。大部分改动通过 Port Stub 单测 + 离线评测验证即可 | 5 个实验维度（见下 5.2）即为"高影响"范围的完整枚举 |
| P2 | 先过离线门槛 | 离线评测不过线，不允许占线上流量 | Langfuse（Section 7）+ generation_metadata（Section 4）提供离线评测数据基础 |
| P3 | 一页实验卡 | 每次实验只写 7 件事（见 5.3），不做重型实验设计文档 | -- |
| P4 | 强制止损自动化 | 命中护栏阈值自动降级/回滚，不开会讨论 | 复用 LLM Gateway 断路器（05 Section 5.4）+ 降级矩阵（00 Section 11）模式 |
| P5 | 按租户分层实验 | 按 tenant/org 分流，不按全局用户混跑。避免行业差异污染结论 | 基于组织树（Section 1）的 org_id/org_tier 分流 |
| P6 | 周期短而硬 | 通常 7-14 天，到期必须"上线/下线"二选一。允许一次基于统计检验力不足的延期（+14 天上限），需在实验卡中预设 | -- |
| P7 | 平台先轻后重 | 先用 feature_flags（Section 1.5）+ experiment_id/variant（Section 4）打通闭环，不先做重型实验平台 | feature_flags.experiment_participation 已预留 |
| P8 | 只保留可复用结论 | 实验结束沉淀"适用条件 + 收益区间"至 ADR-EXP-xxx，避免重复试错 | 附录 B ADR 体系 |

**补充原则（针对 DIYU 架构特性）:**

| # | 原则 | 要点 |
|---|------|------|
| P9 | 实验碰撞管理 | 同一 trace 链路上同时只允许 1 个实验维度变更。若需并行，必须在实验卡中声明已知并行实验及交互风险评估 |
| P10 | 客户知情权 | 租户管理员可通过 feature_flags.experiment_participation 控制是否参与实验。自动回滚时必须触发 tenant_admin_notification 事件（Event Bus） |
| P11 | 知识继承级联评估 | 在 brand_hq 层做的实验会通过继承链影响所有下游 store，实验卡必须填写 affected_org_scope 并评估级联面 |

### 5.2 实验维度与离线门槛

| 维度 | 说明 | 离线评测"过线"标准 | 在线主指标（参考） |
|------|------|-------------------|------------------|
| Brain 路由策略 | 意图分发、Skill 选择逻辑 | 意图分类准确率 >= 基线；回归测试集 PASS | 任务完成率、首轮分发准确率 |
| Skill 执行策略 | Skill 内部流程、工具编排 | Skill 单测 PASS；输出质量评分 >= 基线 | Skill 成功率、用户采纳率 |
| Knowledge 检索策略 | Resolver Profile、FK 策略、检索参数 | 召回率/精确率 >= 基线；延迟 P95 <= 阈值 | 知识命中率、上下文相关性评分 |
| Prompt 版本 | Skill 的 prompt 模板变体 | LLM-as-Judge 评分 >= 基线（多维度） | 用户满意度、内容采纳率 |
| 模型选择 | 主模型/备选模型切换 | 质量评分 >= 基线；成本 <= 预算 | 质量/成本比、延迟 P95 |

> **离线评测基础设施:** Langfuse（Section 7）提供 trace 回放和评分能力。generation_metadata（Section 4）中的 raw_output、retrieved_knowledge_ids、compliance_modifications 提供可对比的评测数据源。

### 5.3 实验卡模板

每次实验填写以下 7 项，存入 `experiments` 表（见 Section 9 数据模型）:

```
实验卡:
+-- hypothesis:           假设（改什么、预期什么效果）
+-- primary_metric:       主指标（唯一，可量化）
+-- guardrail_metrics:    护栏指标（不可恶化的底线指标列表）
+-- traffic_split:        流量比例（如 control:50% / variant:50%）
+-- affected_org_scope:   影响的组织层级范围 + 级联评估
+-- stop_conditions:      停止条件（主指标达到统计显著 OR 周期到期）
+-- rollback_conditions:  回滚条件（护栏指标阈值 + 自动执行）
```

### 5.4 租户级分流机制

> 基于 Section 1 组织模型的分流设计。

```
分流粒度（按优先级）:
  1. org_id 级（推荐，ToB 天然隔离单元）
  2. org_tier 级（按品牌/区域/门店层级整体分流）
  3. brand_id 级（同品牌下所有组织统一分配）

分流实现:
  experiment_assignments 表记录 org_id <-> experiment_id + variant 映射
  Gateway 在组装 OrganizationContext 时注入当前 variant
  variant 随 OrganizationContext 贯穿 Brain -> Skill -> Tool 全链路

统计检验力注意事项:
  ToB tenant 数量有限，按 org_id 分流后每组样本量可能不足
  应对策略:
    +-- 接受更大的最小可检测效应量（MDE），即"只检测大效应"
    +-- 对 tenant 数极少的场景，考虑贝叶斯方法替代频率检验
    +-- 可在实验卡中预设延期条件（基于检验力不足，最多 +14 天）
```

### 5.5 自动止损与回滚

```
止损流程:
  实验运行中 -> 护栏指标采集（Langfuse + Audit）
    -> 命中护栏阈值?
       +-- YES -> 自动回滚（将 experiment status 置为 rolled_back，全部流量回 control）
       |          -> 触发 Event Bus 事件: experiment.rolled_back
       |          -> 通知 tenant_admin（P10 客户知情权）
       |          -> 记录 rollback_reason 至 audit_events
       +-- NO  -> 继续运行直到 stop_conditions 达成

回滚机制:
  experiment_assignments.variant 切回 "control"
  feature_flags 层面: 相当于关闭实验开关
  不涉及代码回滚或部署操作（feature flag 控制，非代码分支）

与降级矩阵的关系:
  实验回滚 = 第四层保护机制，与以下已有机制模式一致:
    Layer 1: Memory Engine 负反馈熔断（01-Brain）
    Layer 2: LLM Gateway Fallback 链（05-Gateway）
    Layer 3: 组件级降级（00-降级矩阵）
    Layer 4: 实验级自动回滚（本节）
```

### 5.6 实验碰撞管理

```
约束: 同一请求的 trace 链路上，同时只允许 1 个实验维度变更

示例（禁止）:
  用户 A 同时参与 "Brain 路由实验" + "Prompt 版本实验"
  -> 无法归因效果来自哪个变更

示例（允许）:
  用户 A 参与 "Brain 路由实验"
  用户 B 参与 "Prompt 版本实验"
  -> 不同用户，互不干扰

实现:
  experiment_assignments 表的 UNIQUE(org_id, dimension) 约束
  分配 variant 时检查该 org 是否已有同 trace 链路的活跃实验
  如有冲突，后提交的实验排队等待
```

### 5.7 结论沉淀

```
实验结束后（无论上线或下线），必须输出结论记录:

结论格式（ADR-EXP-xxx）:
+-- experiment_id
+-- conclusion: "adopt" | "reject" | "inconclusive"
+-- applicable_conditions: 在什么场景下结论成立
+-- benefit_range: 收益区间（如 "召回率提升 5%-12%"）
+-- caveats: 已知局限（如 "仅在大品牌 tenant 验证"）
+-- archived_at: 归档时间

存储: 附录 B ADR 体系（ADR-EXP-xxx 子序列）
未来可迁移至 Knowledge Stores 作为平台级知识实体（entity_type: ExperimentConclusion）
```

---

## 6. Event Bus 与事件可靠性

> **[v3.2 扩展]** 事件按可靠性要求分级，关键事件不可丢失。见 ADR-025。

### 6.1 事件域

事件域: task, review, memory, org, knowledge, billing, model。

### 6.2 事件可靠性分级

```
Level 1: 关键事件（不可丢失）
  事件类型: audit_events, llm_usage_records, memory_receipts, evolution_proposals, experiment.rolled_back
  方案: PG Transactional Outbox
  +-- 写入业务表时，同事务内写入 event_outbox 表
  +-- 独立 poller 消费 outbox -> 投递到目标服务/Celery
  +-- 投递成功后标记 outbox 行为 processed
  +-- 保证: 事件与业务数据同事务，不丢失

  event_outbox 最低字段:
  +-- event_id: UUID PK
  +-- aggregate_id: UUID          关联的业务实体 ID
  +-- event_type: TEXT            事件类型标识
  +-- payload: JSONB              事件内容
  +-- payload_version: INTEGER DEFAULT 1   -- v3.5 新增: 应对 Worker 升级时未消费的旧版本事件兼容
  +-- idempotency_key: TEXT NOT NULL       -- v3.5 新增: 生产者去重（UNIQUE 约束）
  +-- status: TEXT                "pending" | "processing" | "processed" | "failed"
  +-- retry_count: INTEGER        已重试次数（上限 5）
  +-- next_retry_at: TIMESTAMPTZ  下次重试时间（exponential backoff）
  +-- created_at: TIMESTAMPTZ
  +-- UNIQUE(idempotency_key)     -- 防止应用层重试导致重复事件产生

Level 2: 普通事件（可容忍偶发丢失）
  事件类型: notification, webhook, cache_invalidation
  方案: Celery + Redis 直接发布
  丢失影响: 用户晚收到通知，缓存多存活一个 TTL 周期

演进路径:
  当前: PG Outbox (Level 1) + Celery (Level 2)
  后续: 事件量增大或需要多消费者组时，考虑 NATS / Kafka 替代 Celery
```

### 6.3 Unified Event Model

> **[v3.5 新增, B8 修复]** 定义跨 Loop 统一事件模型，确保 Runtime Governance Loop 与 Data Lifecycle Pipeline 的事件可互操作。

```
三种事件类型:

  decision_event（注入决策事件，Runtime Loop -> Observe 步骤）:
    +-- 记录每次注入决策的五元组 + 策略版本
    +-- 触发时机: Context Assembler 完成注入后写入

  deletion_event（删除生命周期事件，Lifecycle Pipeline -> Audit 步骤）:
    +-- 记录删除状态机每次状态迁移
    +-- 触发时机: tombstone 状态变更时写入

  degrade_event（降级事件，两者共用）:
    +-- 记录组件降级的原因、影响范围、恢复时间
    +-- 触发时机: 降级矩阵命中时写入

共享字段（所有事件类型必须包含）:
  +-- event_id: UUID              全局唯一事件标识
  +-- trace_id: UUID              关联全链路追踪
  +-- tenant_id: UUID             租户标识
  +-- timestamp: TIMESTAMPTZ      事件产生时间（PG now()，非本地时钟）
  +-- policy_version: TEXT        当前生效的策略版本号

与 event_outbox 的关系:
  Level 1 事件（decision_event, deletion_event, media_event）通过 event_outbox 投递（同事务写入）
  Level 2 事件（degrade_event 的非关键通知）可走 Celery 直接发布
  事件 payload 遵循 payload_version 字段标注的 schema 版本

media_event（v3.6 新增，媒体生命周期事件）:
  子类型:
    media.upload_initiated     -- 上传流程启动 (记录 media_id, uploader, intent)
    media.upload_completed     -- 上传完成 (S3 confirm + 同步预检通过)
    media.upload_expired       -- 上传超时未 complete (配额回收)
    media.scan_completed       -- 异步深度扫描完成 (含结果)
    media.rejected             -- 安全扫描拒绝
    media.deletion_requested   -- 删除请求 (intent 记录)
    media.deletion_completed   -- 删除完成 (所有存储位置确认清除)

  遵循 event_outbox 规范:
    payload_version: INTEGER DEFAULT 1
    Level 1 投递（同事务写入 event_outbox）
    共享字段: event_id, trace_id, tenant_id, timestamp, policy_version

  media_event 特有字段:
    media_id: UUID
    media_domain: "personal" | "enterprise"   -- 标识 SSOT 归属
    media_type: "image" | "audio" | "video" | "document"
    action_detail: JSONB                       -- 子类型特有数据

  idempotency_key 格式（与 event_outbox UNIQUE 约束对齐）:
    个人域模板: media:{media_id}:{action}
    企业域模板: media:{media_id}:{action}:{changeset_id}
    超时回收模板: media:{media_id}:expired
    规则: 禁止包含 timestamp（同一业务动作重试时 key 必须相同，才能被 UNIQUE 约束去重）
```

### 6.4 持久化数据兼容测试套件

> **[v3.5 新增]** 与 00 Section 12.6 契约测试三层策略对齐，作为第四层：持久化数据版本兼容。

```
测试目标:
  确保 N+1 版本代码能正确处理所有历史版本的持久化数据。
  数据一旦写入就无法轻易迁移，比接口测试更难但更关键。

测试方式:
  +-- 保存每个版本的样本数据（Fixture）
  +-- CI 中验证 N+1 版本代码能正确处理所有历史版本的数据
  +-- 覆盖范围: memory_items、event_outbox payload、receipt details
  +-- 与 ADR-033 兼容规则联动: Expand-Contract 迁移必须有对应 Fixture

与契约测试三层的关系:
  Layer 1: Port 接口契约测试（00 Section 12.6 已有）
  Layer 2: 语义契约 Schema 测试（00 Section 12.6 已有）
  Layer 3: 事件契约测试（00 Section 12.6 已有）
  Layer 4: 持久化数据版本兼容测试（本节新增）
```

> **[预留]** Webhook 外部通知接口、NotificationService（企业微信/钉钉等）。

---

## 7. LLM 观测

> **[裁决]** 集成 Langfuse 自托管。满足中国数据驻留要求。

---

## 8. 存储总览

| 组件 | 用途 |
|------|------|
| PostgreSQL + RLS + ltree + pgvector | 业务数据、组织树、会话、任务、计费、审计、**Memory Core (SSOT-A)**（含 pgvector 向量检索，见 01 Section 3.2.1 / ADR-042） |
| Neo4j | Knowledge Stores 图谱侧 (SSOT-B): 实体 + 关系 + 版本治理 |
| Qdrant | Knowledge Stores 向量侧 (SSOT-B): 语义内容 + FK payload + 个人投影 |
| S3 / MinIO | v3.6 新增: 对象存储（媒体文件），通过 ObjectStoragePort 抽象，底层可替换 |
| Redis | 消息队列 + 缓存 + Token 实时计数 |
| Langfuse | LLM 观测 |

---

## 9. PostgreSQL 数据模型

> **[v3.5 工程纪律]** 所有业务时间戳使用 PG `now()`（在事务中执行），Worker 本地时钟仅用于日志和调试，不参与业务逻辑。
> 原因: 容器环境中 Worker 节点时钟偏差可达数秒，关键逻辑（valid_at/invalid_at、tombstone SLA、EWMA 窗口）依赖一致时钟。

```sql
CREATE EXTENSION IF NOT EXISTS ltree;
CREATE EXTENSION IF NOT EXISTS vector;  -- v3.5.1 新增: pgvector 向量检索（见 01 Section 3.2.1 / ADR-042）

-- 组织树
organizations (org_id PK, name, tier, parent_org_id FK, brand_id, path LTREE, settings JSONB, status)

-- 用户
users (user_id PK, display_name, phone UNIQUE, email UNIQUE, identity_type, auth_source, status)

-- 组织成员
org_members (user_id, org_id FK, role, status, invited_by | UNIQUE(user_id, org_id))

-- 会话
sessions (session_id PK, user_id, org_id FK, context JSONB, entity_slots JSONB,
          summary_blocks JSONB, ttl, expires_at)

-- Memory Core: 对话事件 (SSOT-A)
conversation_events (
  event_id PK, session_id FK, user_id, tenant_id,
  event_type TEXT, content JSONB,
  content_schema_version INTEGER DEFAULT 0,  -- v3.6 新增: 内容格式版本
  -- 0 = 存量纯文本格式 (向后兼容); 1 = ContentBlock Schema v1.1 (含 blocks 数组)
  -- 读取时按值分支解析 content JSONB; 遵循 ADR-033 Expand-Contract
  -- 注: content JSONB 内禁止放版本号 (版本由此行级列决定, 见版本号三层分离原则)
  tombstone_id UUID,                  -- 关联删除标记（null = 未删除）(v3.4 新增)
  created_at TIMESTAMPTZ DEFAULT now()
)

-- Memory Core: 法域合规配置 (v3.5 新增，B6 修复，见 ADR-039.3)
legal_profiles (
  profile_id TEXT PK,                -- 'GDPR', 'PIPL', 'CCPA', 'DEFAULT'
  deletion_sla INTERVAL NOT NULL,    -- '30 days', '15 days', '45 days'
  sla_type TEXT NOT NULL CHECK (sla_type IN ('calendar_days', 'business_days')),
  source TEXT NOT NULL,              -- 法条引用或内部 SLA 编号
  alert_thresholds JSONB DEFAULT '{"warn_pct": 25, "critical_pct": 10}'::jsonb,
  -- v3.5 V2.1 新增: 告警梯度百分比。SLA 计算逻辑引用此字段（非硬编码）
  -- warn_pct: SLA 剩余百分比 <= 此值触发 P1 告警
  -- critical_pct: SLA 剩余百分比 <= 此值触发 P0 告警 + 自动升级
  created_at TIMESTAMPTZ DEFAULT now()
)
-- 预置数据:
-- INSERT INTO legal_profiles VALUES
--   ('GDPR',    '30 days',  'calendar_days',  'Art.17 GDPR'),
--   ('PIPL',    '15 days',  'business_days',  '内部SLA，参照TC260推荐标准'),
--   ('DEFAULT', '15 days',  'business_days',  '默认按最严格标准');

-- Memory Core: 删除标记 (v3.4 新增，见 01 Section 3.1.1 / ADR-037 / ADR-039)
tombstones (
  tombstone_id UUID PK,
  user_id UUID NOT NULL,
  scope TEXT NOT NULL,                -- "all" | "personal" | "session"
  requested_at TIMESTAMPTZ NOT NULL,
  completed_at TIMESTAMPTZ,           -- null = 未完成
  status TEXT NOT NULL DEFAULT 'requested',
  -- v3.5 状态机扩展为 8 态（与 01 Section 3.1.1 对齐）:
  --   requested -> verified -> tombstoned -> queued -> processing -> completed
  --                                                              -> failed -> retry_pending -> processing (loop)
  --                                                                        -> escalated (重试耗尽)
  legal_profile_id TEXT REFERENCES legal_profiles(profile_id) DEFAULT 'DEFAULT',
  -- v3.5 新增: 关联法域合规配置（B6 修复）
  -- 注: 审查报告原文写 ALTER TABLE deletion_requests，但架构无此表，语义对齐后映射到 tombstones
  progress JSONB DEFAULT '{}'::jsonb,
  -- v3.5 新增: Worker 断点恢复字段，记录每个存储位置的删除完成状态
  -- 示例: {"pg_memory_items": "completed", "qdrant_personal": "pending", "redis_cache": "completed"}
  created_at TIMESTAMPTZ DEFAULT now()
)

-- Memory Core: 记忆条目 (SSOT-A)
memory_items (
  item_id UUID PK,                 -- 内部存储 PK，Port 层对外 memory_id（见 01 Section 2.3.1），兼容别名弃用期 2 minor version
  user_id UUID, tenant_id UUID,
  scope TEXT NOT NULL,           -- "session" | "personal"
  item_type TEXT NOT NULL,       -- "preference" | "behavior_pattern" | "insight" | "agent_experience"(Phase 2, 见 01 Section 2.3)
  content JSONB NOT NULL,
  confidence FLOAT,
  version INTEGER DEFAULT 1,
  valid_at TIMESTAMPTZ, invalid_at TIMESTAMPTZ,
  superseded_by UUID,
  source_sessions UUID[],
  provenance JSONB,
  content_schema_version INTEGER DEFAULT 1,  -- v3.5 新增: 应对 preference 结构演进
  embedding vector(1536),                    -- v3.5.1 新增: pgvector 向量列（见 01 Section 3.2.1 / ADR-042）
  -- 维度 1536 为 text-embedding-3-small 默认值，可通过 ModelRegistry 配置调整
  -- NULL = 尚未生成 embedding（降级为 FTS-only 检索）
  last_validated_at TIMESTAMPTZ,             -- v3.5.1 新增: 最近一次被正反馈验证的时间（见 01 Section 2.3.2.4）
  -- 用于 confidence_effective 计算: decay_factor(days_since_last_validated)
  -- NULL = 从未被验证，视同 created_at
  epistemic_type TEXT,                       -- v3.5.2 新增: 认知类型标记（见 01 Section 3.1.0.2）
  -- 枚举值: 'fact' | 'opinion' | 'preference' | 'outdated'
  -- NULL = 存量记忆未标注，视为 'preference'（向后兼容，Expand 兼容变更，见 ADR-033）
  -- 用于 Memory-Aware Instruction 差异化引用策略 + Structured Tags epistemic_type 属性
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
)

-- v3.5.1 新增: pgvector 索引（Hybrid Retrieval 支撑，见 01 Section 4.1 Step 1）
-- 索引类型选择: HNSW（推荐，recall 更高）或 IVFFlat（构建更快，适合初期数据量小时）
-- CREATE INDEX idx_memory_items_embedding ON memory_items USING hnsw (embedding vector_cosine_ops)
--   WITH (m = 16, ef_construction = 64);
-- 注: 仅对 embedding IS NOT NULL 的行生效。embedding 为 NULL 时降级为 FTS-only（见 01 Section 3.2.1）

-- v3.5.1 新增: FTS 索引（Hybrid Retrieval 的全文检索路径）
-- CREATE INDEX idx_memory_items_content_fts ON memory_items USING gin (to_tsvector('simple', content->>'text'));
-- 注: 'simple' 分词器适用于中英混合场景。生产环境可按需切换为 zhparser 或 pg_jieba

-- Memory Core: 回执 (v2，见 ADR-036 / ADR-038)
memory_receipts (
  receipt_id PK, receipt_type TEXT,  -- "retrieval" | "injection" | "promotion"
  session_id UUID, user_id UUID,
  trace_id UUID,                     -- 关联全链路追踪（见 Section 4 AuditService）(v3.4 新增)
  details_schema_version INTEGER DEFAULT 1,  -- details 结构版本 (v3.4 新增)
  -- v3.5 升级路径: 2->3（容纳注入五元组），遵循 ADR-033 Expand-Contract 迁移
  -- 迁移步骤（memory_receipts details，非 MemoryItem Schema）:
  --   Expand: 新增字段（五元组），details_schema_version = 3。旧代码忽略新字段
  --   Migrate: 逐步将新写入切换到 v3 格式。旧数据保持 v2 不迁移
  --   Contract: 待所有消费端升级后，移除 v2 兼容分支（最小 2 个 minor version 后）
  details JSONB,
  outbox_event_id UUID REFERENCES event_outbox(event_id),
  -- v3.5 新增: 关联 outbox 事件（B5 修复，双层幂等架构）
  -- outbox 层 idempotency_key = 生产者去重; receipt 层 idempotency_key = 消费者去重
  created_at TIMESTAMPTZ DEFAULT now()
)

-- 建议索引（实现阶段按查询模式决定）:
-- CREATE INDEX idx_receipts_type_created ON memory_receipts(receipt_type, created_at);
-- CREATE INDEX idx_receipts_trace ON memory_receipts(trace_id);
-- 对 details 内高频聚合字段考虑生成列 + B-tree 索引（如 latency_ms）

-- details 结构化字段约定（details_schema_version = 2）:
--
-- receipt_type = "retrieval":
--   candidates_count: INTEGER        候选记忆数
--   selected_count: INTEGER          选中注入数
--   latency_ms: INTEGER              检索耗时
--   degraded_reason: TEXT            降级原因（null = 正常）
--
-- receipt_type = "injection":
--   hit_reason: TEXT                  命中原因
--   threshold: FLOAT                 置信度阈值
--   budget_allocation: JSONB          各 slot 实际分配（见 01 Section 4.2.1）
--   conflict_detected: BOOLEAN        是否检测到冲突
--   conflict_resolution: TEXT         冲突解决方式
--
-- v3.5 新增（details_schema_version = 3，注入五元组扩展）:
--   candidate_score: FLOAT            候选记忆的相关性得分
--   decision_reason: TEXT             注入/不注入的判定原因标签（Enum）
--   policy_version: TEXT              当前注入策略版本号（联动 Experiment Engine）
--   guardrail_hit: JSONB              是否触发安全护栏 + 原因 {hit: BOOLEAN, reason: TEXT}
--   context_position: TEXT            注入到上下文的位置区间（应对 Lost-in-the-middle）
--
-- v3.5.1 新增（details_schema_version = 3.1，CE 后处理闭环扩展，见 01 Section 4.1.1）:
--   utilized: BOOLEAN                  LLM 是否实际使用了该记忆（后处理检测结果）
--   utilization_signal: TEXT           利用信号来源（"explicit_reference" | "paraphrase" | "not_detected"）
--   user_feedback_signal: TEXT         隐式反馈信号（"positive_confirm" | "correction" | "neutral" | null）
--   -- Expand-compatible: 旧版本消费端忽略新字段。3.1 与 3 共存，不需迁移旧数据。
--
-- receipt_type = "promotion":
--   proposal_id: UUID                提案 ID
--   review_status: TEXT              审核状态
--   sanitization_applied: BOOLEAN    是否脱敏
--
-- 兼容规则: details_schema_version = 1 的旧数据保持原样，新写入使用 version = 2。
-- 读取时按 version 分支解析（向前兼容）。符合 ADR-033 兼容变更定义。
--
-- v3.5 新增: error_code 枚举定义（receipt_type 为 retrieval 或 injection 时使用）:
--   RETRIEVAL_TIMEOUT              检索超时
--   INJECTION_BUDGET_EXCEEDED      注入预算超限
--   INJECTION_GUARDRAIL_HIT        注入安全护栏命中
--   KNOWLEDGE_DEGRADED             Knowledge Stores 降级
--   MEMORY_CORE_UNAVAILABLE        Memory Core 不可用
--   EVOLUTION_BLOCKED_BY_ERASURE   进化被删除管线阻断
--   BUDGET_ALLOCATOR_FALLBACK      预算分配器回退到静态基线

-- 内容任务
content_tasks (task_id PK, org_id FK, user_id, brand_id,
               intent_type, content_type_id, persona_id, platform,
               status, result JSONB, generation_metadata JSONB,
               parent_task_id FK->self, version, refine_feedback)

-- 审核队列
human_review_queue (id PK, task_id FK, creator_org_id, review_org_id,
                    review_status, compliance_result JSONB, reviewed_by)

-- 审计日志
audit_events (id PK, event_type, event_domain, org_id, task_id,
              actor_id, actor_role, details JSONB, created_at)

-- Token 计费
llm_usage_records (id PK, org_id FK, user_id, brand_id, model_id, provider,
                   input_tokens, output_tokens, cost_amount, skill_id, task_id, created_at)
usage_budgets (id PK, org_id FK UNIQUE, period, budget_tokens, budget_amount,
               budget_tool_amount NUMERIC(12,6),  -- v3.6 新增: 工具费用预算 (Expand 兼容变更)
               -- 数据流: org_settings.model_access.budget_tool_amount (config SSOT)
               --         -> usage_budgets.budget_tool_amount (runtime, 单向初始化)
               -- Pre-check: 分别校验 token 预算和 tool 金额预算
               -- Post-settle: tool_usage_records 异步扣减 budget_tool_amount
               alert_threshold, hard_limit, set_by_org_id)
usage_daily_summaries (org_id, date, total_tokens, total_cost, model_breakdown JSONB | PK(org_id,date))

-- 模型注册
model_registry (model_id PK, display_name, provider, capabilities, tier,
                pricing JSONB, endpoint_config JSONB, status)

-- 进化提案 (Promotion Pipeline)
evolution_proposals (id PK, source_org_id, target_org_id, target_visibility,
                     knowledge_type, knowledge_content JSONB,
                     status, proposed_by, reviewed_by, reviewed_at)

-- 库存同步记录
inventory_sync_records (sync_id PK, org_id FK, source_system, sync_type,
                        record_count, status, started_at, completed_at)

-- 实体类型注册表
entity_type_registry (entity_type_id PK, label, registered_by,
                      schema JSONB, relationships JSONB,
                      vector_content_types JSONB, visibility_rules JSONB,
                      org_scope JSONB, status)

-- 实验定义（Experiment Engine, Section 5）
experiments (
  experiment_id UUID PK,
  name TEXT NOT NULL,
  dimension TEXT NOT NULL,          -- "brain_routing" | "skill_execution" | "knowledge_retrieval" | "prompt_version" | "model_selection"
  hypothesis TEXT NOT NULL,
  primary_metric TEXT NOT NULL,
  guardrail_metrics JSONB NOT NULL, -- [{metric, threshold, direction}]
  traffic_split JSONB NOT NULL,     -- {control: 50, variant: 50}
  affected_org_scope JSONB NOT NULL,-- {tiers: [...], cascade_assessment: "..."}
  stop_conditions JSONB NOT NULL,
  rollback_conditions JSONB NOT NULL,
  status TEXT NOT NULL DEFAULT 'draft', -- "draft" | "active" | "stopped" | "rolled_back" | "concluded"
  conclusion JSONB,                 -- {result, applicable_conditions, benefit_range, caveats}
  max_duration_days INTEGER NOT NULL DEFAULT 14,
  started_at TIMESTAMPTZ,
  ended_at TIMESTAMPTZ,
  created_by UUID NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
)

-- 实验分配（租户级分流）
experiment_assignments (
  experiment_id UUID FK -> experiments,
  org_id UUID FK -> organizations,
  variant TEXT NOT NULL,            -- "control" | "variant_a" | "variant_b" ...
  assigned_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (experiment_id, org_id),
  UNIQUE (org_id, dimension)        -- 同一 org 同一维度只能参与一个实验（碰撞管理）
)
-- 注: dimension 字段通过 experiments 表 JOIN 获取，UNIQUE 约束通过触发器或应用层保证

-- v3.6 新增: 个人媒体对象 (SSOT-A 域, 与 memory_items 同级)
personal_media_objects (
  media_id UUID PK DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL,
  tenant_id UUID NOT NULL,
  bucket TEXT NOT NULL,
  key TEXT NOT NULL UNIQUE,
  checksum_sha256 TEXT NOT NULL,
  size_bytes BIGINT NOT NULL,
  mime_type TEXT NOT NULL,
  media_type TEXT NOT NULL CHECK (media_type IN ('image','audio','video','document')),
  security_status TEXT NOT NULL DEFAULT 'pending'
    CHECK (security_status IN ('pending','scanning','safe','rejected','quarantined','expired')),
  scan_result JSONB,                -- 安全扫描详情
  tombstone_id UUID REFERENCES tombstones(tombstone_id),  -- SSOT-A 删除走 tombstone
  quota_reserved_bytes BIGINT DEFAULT 0,                  -- 配额预扣 (v3.2)
  created_at TIMESTAMPTZ DEFAULT now()
)
-- RLS: 与 memory_items 对齐，按 user_id + tenant_id 隔离

-- v3.6 新增: 企业媒体对象 (SSOT-B 域, 与 Knowledge Stores 对齐)
enterprise_media_objects (
  media_id UUID PK DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,             -- v3.3: 与 Neo4j 图谱节点 tenant_id 对齐 (02-Knowledge层.md:79)
  org_id UUID NOT NULL REFERENCES organizations(org_id),
  brand_id UUID,
  uploaded_by UUID NOT NULL REFERENCES users(user_id),
  bucket TEXT NOT NULL,
  key TEXT NOT NULL UNIQUE,
  checksum_sha256 TEXT NOT NULL,
  size_bytes BIGINT NOT NULL,
  mime_type TEXT NOT NULL,
  media_type TEXT NOT NULL CHECK (media_type IN ('image','audio','video','document')),
  visibility TEXT NOT NULL DEFAULT 'store'
    CHECK (visibility IN ('global','brand','region','store')),
  org_scope TEXT,                    -- 与 Neo4j 图谱节点 org_scope 对齐 (02-Knowledge层.md:81)
  security_status TEXT NOT NULL DEFAULT 'pending'
    CHECK (security_status IN ('pending','scanning','safe','rejected','quarantined','expired')),
  scan_result JSONB,
  graph_node_id TEXT,                -- 关联 Neo4j 节点 (FK 联动, 可选)
  deletion_changeset_id UUID,        -- 关联 Knowledge ChangeSet (SSOT-B 删除走 ChangeSet)
  deleted_at TIMESTAMPTZ,            -- 软删除时间戳 (NULL = 未删除)
  quota_reserved_bytes BIGINT DEFAULT 0,  -- 配额预扣 (v3.2)
  created_at TIMESTAMPTZ DEFAULT now()
)
-- RLS: 硬隔离 (租户维度 + 组织链双向), visibility 精确判定在应用层
-- 删除管线域模型分离 (LAW):
--   personal_media_objects -> tombstone 状态机 (SSOT-A, PIPL/GDPR)
--   enterprise_media_objects -> Knowledge ChangeSet (SSOT-B, ACL+审计)
--   两条管线独立，不互引

-- v3.6 新增: Tool 计费记录 (与 llm_usage_records 分离, 见 ADR-047)
tool_usage_records (
  id BIGSERIAL PK,
  org_id UUID NOT NULL REFERENCES organizations(org_id),
  user_id UUID NOT NULL,
  brand_id UUID,
  tool_name TEXT NOT NULL,           -- 对齐 04-Tool层 ToolProtocol.name
  tool_version TEXT NOT NULL,
  skill_id TEXT,                     -- 调用方 Skill
  input_summary TEXT,                -- 脱敏后摘要
  duration_ms INTEGER,
  cost_amount NUMERIC(12,6) NOT NULL,
  billing_unit TEXT NOT NULL,        -- 'per_call' | 'per_image' | 'per_minute'
  status TEXT NOT NULL CHECK (status IN ('success','error','rate_limited')),
  created_at TIMESTAMPTZ DEFAULT now()
)

-- RLS 策略
ALTER TABLE content_tasks ENABLE ROW LEVEL SECURITY;
CREATE POLICY org_isolation ON content_tasks
  USING (org_id IN (
    SELECT org_id FROM organizations
    WHERE path <@ current_setting('app.current_org_path')::ltree
  ));
-- Memory Core 表: 按 user_id + tenant_id 隔离
ALTER TABLE memory_items ENABLE ROW LEVEL SECURITY;
CREATE POLICY user_isolation ON memory_items
  USING (user_id = current_setting('app.current_user_id')::uuid
         AND tenant_id = current_setting('app.current_tenant_id')::uuid);
-- 其他业务表类似

-- v3.6 新增: 媒体表 RLS
-- personal_media_objects: 与 memory_items 对齐，按 user_id + tenant_id 隔离
ALTER TABLE personal_media_objects ENABLE ROW LEVEL SECURITY;
CREATE POLICY user_isolation ON personal_media_objects
  USING (user_id = current_setting('app.current_user_id')::uuid
         AND tenant_id = current_setting('app.current_tenant_id')::uuid);

-- enterprise_media_objects: 硬隔离 (租户 + 组织链双向), visibility 精确判定在应用层
ALTER TABLE enterprise_media_objects ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_org_isolation ON enterprise_media_objects
  USING (
    org_id IN (
      SELECT org_id FROM organizations
      WHERE path <@ current_setting('app.current_org_path')::ltree   -- 子树 (下级资产)
         OR current_setting('app.current_org_path')::ltree <@ path   -- 祖先链 (上级继承资产)
    )
  );
-- v3.3 修正: 仅子树方向会过滤掉 brand/global 级别的父节点资产，
-- 导致应用层无法做继承判定。增加祖先链方向后:
--   store 用户可看到 brand 级媒体 (path = root.brand_a, 是 store path 的祖先)
--   应用层再按 visibility + org_chain 做精确过滤 (见 02-Knowledge层.md Section 3.6)
-- 注: content_tasks 等已有表不受影响 (无继承语义)
-- M2 验证项: 确认所有企业域调用路径均设置 app.current_tenant_id session variable 后,
-- 可追加 AND tenant_id = current_setting('app.current_tenant_id')::uuid 作为防御纵深。
-- 当前 org_path ltree 已隐含租户边界 (不同租户组织树根不同), tenant_id 为第二道防线。
```

### 9.1 媒体删除管线完整定义 (SSOT)

> **[v3.6 新增]** 双管线（personal tombstone / enterprise ChangeSet）的完整流程定义。01-Brain.md (tombstone 状态机) 和 02-Knowledge层.md (企业删除) 均引用本节。

```
删除触发源:
  1. 用户删除请求 (personal_media, 遵循 tombstone 状态机, 见 01 Section 3.1.1)
  2. 管理员删除请求 (enterprise_media, 遵循 Knowledge Write API ACL, 见 02 Section 7.1)
  3. PIPL/GDPR 合规删除 (按 legal_profile SLA)
  4. 安全扫描拒绝后自动删除 (quarantined media 超期未审核)

--- personal_media 删除管线 (SSOT-A, tombstone) ---

  Step 0: 意图记录 (不可跳过, LAW)
    +-- 写入 tombstone 记录 (状态: requested)
    +-- 记录: 删除意图、用户 ID、影响范围
    +-- 写入 media_event (media.deletion_requested, domain="personal")

  Step 1: 权限验证
    +-- user_id 匹配
    +-- tombstone 状态: requested -> verified

  Step 2: 级联删除执行 (原则: 可逆操作先行，不可逆操作最后, LAW)
    +-- PG: personal_media_objects 关联 tombstone_id (软删标记, 可逆)
    +-- Redis: 清除相关缓存
    +-- CDN: purge
    +-- Object Storage: 删除原始文件 + 衍生文件 (物理删除, 不可逆, 最后执行)
    +-- progress JSONB 逐项更新 (复用 tombstone.progress 机制)
    +-- tombstone 状态: verified -> queued -> processing

  Step 3: 完成确认
    +-- 所有存储位置确认清除
    +-- 写入 media_event (media.deletion_completed, domain="personal")
    +-- tombstone 状态: processing -> completed

--- enterprise_media 删除管线 (SSOT-B, ChangeSet) ---

  Step 0: ACL 校验 + ChangeSet 记录
    +-- 校验: 操作者角色 + 组织范围 (02-Knowledge层 Section 7.1)
    +-- 创建 ChangeSet: 记录删除意图、操作者、影响范围
    +-- 写入 media_event (media.deletion_requested, domain="enterprise")

  Step 1: 级联执行 (原则: 可逆先行 + FK 顺序, LAW)
    +-- PG: enterprise_media_objects 设 deleted_at + deletion_changeset_id (软删标记, 可逆)
    +-- Qdrant: 先批量删除含该 graph_node_id 的向量条目 (Qdrant-first, FK 协议)
    +-- Neo4j: 再通过 ChangeSet 更新/删除关联节点/边
    +-- Redis: 清除相关缓存
    +-- CDN: purge
    +-- Object Storage: 删除原始 + 衍生文件 (物理删除, 不可逆, 最后执行)
    容错: Qdrant 删除失败 -> Neo4j 节点标记 sync_status = "pending_vector_delete"
          Reconciliation Job 后续补删 (复用 02-Knowledge层 Section 7.3 自愈机制)
    设计依据: PG 软删后 Gateway 层即返回 404，用户侧立即不可见;
             即使后续步骤部分失败，不会出现"文件已删但索引仍指向"的破链中间态

  Step 2: 确认
    +-- ChangeSet 状态更新为 completed
    +-- 写入 media_event (media.deletion_completed, domain="enterprise")

--- 双管线区别 ---
  personal: tombstone 8 态状态机, legal_profile SLA, 用户自助
  enterprise: ChangeSet + ACL, 管理员操作, 无 PIPL/GDPR SLA (企业自有资产)

失败处理 (两条管线共用):
  +-- 任一存储位置失败: 进入重试
  +-- 重试策略: 指数退避, 上限 5 次
  +-- 重试耗尽: P0 告警 + 人工介入
  +-- 不可逆操作后置 (LAW): Object Storage 物理删除排在最后，PG 软删标记先行
  +-- 中间态安全: PG 软删后 Gateway 层即返回 404，用户侧立即不可见
```

---

> **验证方式:** 1) RLS 隔离: 不同 org 的用户不能看到彼此数据; 2) Memory Core 隔离: 不同用户不能看到彼此记忆; 3) org_chain 计算正确; 4) Token Billing 准确记录消耗; 5) Audit 可追溯完整链路; 6) Experiment Engine: 同 org 同维度不可重复分配（碰撞管理）; 护栏阈值命中后自动回滚且触发通知; experiment_participation=false 的 tenant 不被分流; 7) personal_media_objects RLS: 不同用户不能看到彼此媒体; 8) enterprise_media_objects RLS: 组织链双向放行 + 应用层 visibility 过滤; 9) media_event 幂等: 同一 idempotency_key 不产生重复事件; 10) budget_tool_amount 单向数据流: org_settings -> usage_budgets 初始化正确。
